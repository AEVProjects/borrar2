{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "msi-video-approved-gen",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "rawBody": false
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        87040,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000001",
      "name": "Webhook - Video Approved",
      "webhookId": "msi-video-approved-gen"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    EP: 'us-central1-aiplatform.googleapis.com',\n    PJ: 'video-gen-msi',\n    LOC: 'us-central1',\n    MDL: 'veo-3.1-generate-001',\n    MDL_EXTEND: 'veo-3.1-generate-preview',\n    STORAGE_URI_PART1: 'gs://video-bucket-for-msi-920206/approved-part1/',\n    STORAGE_URI_PART2: 'gs://video-bucket-for-msi-920206/approved-part2/',\n    STORAGE_URI_PART3: 'gs://video-bucket-for-msi-920206/approved-part3/'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        87200,
        -1808
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000002",
      "name": "Publicar Credenciales"
    },
    {
      "parameters": {
        "jsCode": "// Read approved data from the webhook (not from $input which is Publicar Credenciales)\nconst webhookData = $('Webhook - Video Approved').item.json;\nlet data = webhookData.body || webhookData;\nif (typeof data === 'string') {\n  try { data = JSON.parse(data); } catch (e) { }\n}\n\nconst approved1 = data.approved_prompt_part1 || '';\nconst approved2 = data.approved_prompt_part2 || '';\nconst approved3 = data.approved_prompt_part3 || '';\nconst start_image_url = data.start_image_url || null;\nconst aspect_ratio = data.aspect_ratio || '9:16';\nconst duration = String(Math.min(parseInt(data.duration || '8'), 8));\nconst post_id = data.post_id || null;\nconst prompt = data.prompt || '';\nconst service = data.service || 'company_intro';\n\nif (!approved1 || approved1.length < 10) throw new Error('approved_prompt_part1 is required (min 10 chars)');\nif (!approved2 || approved2.length < 10) throw new Error('approved_prompt_part2 is required (min 10 chars)');\nif (!start_image_url) throw new Error('start_image_url is required');\n// second_image_url is no longer required - last frame of Part 1 video will be used for Part 2\n\nreturn [{ json: {\n  PROMPT_PART1: approved1,\n  PROMPT_PART2: approved2,\n  PROMPT_PART3: approved3,\n  DURATION: duration,\n  ASPECT_RATIO: aspect_ratio,\n  POST_ID: post_id,\n  ORIGINAL_PROMPT: prompt,\n  SERVICE: service,\n  START_IMAGE_URL: start_image_url\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        87424,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000003",
      "name": "Format Approved Input"
    },
    {
      "parameters": {
        "jsCode": "// Download start image and base64 encode it (~15s max)\nconst s = $input.item.json;\nconst imgBuffer = await this.helpers.httpRequest({\n  method: 'GET', url: s.START_IMAGE_URL, encoding: 'arraybuffer', timeout: 15000\n});\nconst b64 = Buffer.from(imgBuffer).toString('base64');\nif (b64.length < 100) throw new Error('Start image download failed');\n\nreturn [{ json: { IMAGE_B64: b64, PROMPT_PART1: s.PROMPT_PART1, PROMPT_PART2: s.PROMPT_PART2, PROMPT_PART3: s.PROMPT_PART3, DURATION: s.DURATION, ASPECT_RATIO: s.ASPECT_RATIO, POST_ID: s.POST_ID, ORIGINAL_PROMPT: s.ORIGINAL_PROMPT, SERVICE: s.SERVICE } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        87648,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000004",
      "name": "Download Image 1"
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\nconst SA_EMAIL = 'vertex-veo@video-gen-msi.iam.gserviceaccount.com';\nconst SA_KEY = '-----BEGIN PRIVATE KEY-----\\nMIIEuwIBADANBgkqhkiG9w0BAQEFAASCBKUwggShAgEAAoIBAQDOuH1CtR7QVhT0\\n99yWCCuO2TkACYTjzWQTV8xXnvXNENgLuQjtv+iGXcLuIoFErYRW1aCpim3RwTep\\nCZisBEhCocUWUUdoNSxVoh9e21FRbY1U6ck2f73hLytIz2AtaJHhuy/MKsLjmkT2\\n2RGVnyu4+G6yXfCldVHtD4jHapXTUNkgyooCuQj+saqhtEsdjDbQTODTY4CUqLPI\\noMidS9yqyYRkzctpd2rwF3DtN42TV6dnhMY3ZPoZ5UpgXbseMAT5i9i3e35LQ0MK\\nVVxeSDOu7lCfA2hsdahBGF1nv186e+FsUXRKb+KhcFpxFWSKEKkxOjc/qkdEroY8\\nLjrat0DBAgMBAAECggEACALSyd/CgLDhUYf8eqz44SmOYa+8wGZAg1Zi8x9UJ70I\\nHlYuoCYQgQqHqBpat5pg10uilQdqD5elDE40pi/pS/nAbUe7lHCBFhV5EUA/E8CC\\n2mBP/aZwKZaeHw14TPIxOxX5uXgLwu3Cz+0kFxAKzfmEsrFcxtC32s/ADXhWM5Dr\\n7c/ilSUs3PbH5/wVTxjVkcpwN+hzl0Wv5u4BI65dq1zaMwT2gdTfDjmskNlEnupn\\n6nVxpmlRw1wNn/Z+C04VDOsAZtPJNSnnfQlVOFUgNvirgHudspmaYDqngO5583tr\\nwdBhwIy74NCLmff6uxFK3UB9HOl/rBjTCnrWxEl4kQKBgQDuWxFm8yfPtMO/m0Yt\\n9jRAAYFXQ7rM4fIFDVyUtHi85SiLo6fCxXvuxOgk4/D8MBxTbln3JttGEoLL6U26\\ntLfBIO7Yc9XDHYYKn7lYR3spa7+Y3Y3eqYQXjn4bY55p/9kPJlaNZhq+mFsapifE\\nBGUSVDE5i8iX/mLYk+zGH1OcKQKBgQDeBey0lXnJndQghY/TgMlrfkhMXhMk3vX3\\nN9yAJNlWlSsVPh7zN3YKbzMl+6JluU9acB9IIwMYlNJn4oadOP+s89k4bPSTi5H2\\nhrMSnMavYkPP9PRmCEMJfrbPefzvSUO4XrY6Idh2NKKZxzDJ0bG+rIQadxB4qHKF\\nlbiZSJUS2QJ/cZb0tBss3c9HegiFaWHrhJUzDmM4omsK611ywWtAHsUWjXVwfWGf\\nriood2wpbAWBekEcnqvl037+1i5Y3KFC8MbBDGYneNSZDHcR3QAzsYmnxTHQakxe\\npttBPcw7skg7KP0cQkZmeG4i/JAyYze08wcsbkAvWD/i21OjgsdrEQKBgQDLTI2E\\nheKw1Q5qgSJDvwewoD+/fdz1xBthtgr4Y8WHXKvIlcttVfmGcHBbdWEs2FRrMYPT\\nYAvztEI90dUFni2vxtG+szX47LJJFOpgPqJH8ii6AUjRLPuFdDwdG0yaJ3IVHtSp\\nwlgdVPEW8qggBR1GxV1phmDUuxmybHhOE4I9cQKBgHVGrcoRVdPlmFSRKYAlKrxZ\\nYNWqJP09bu+vSKGPYBo+zhYps58VjBRVjunPoQtSXYdK1aPnBMiMJPj0LVxB46fu\\nYV9mp1crPCpgLZW8EL9MawX0qp3xew6voBSIule4g2DH1yg7VBki+KPavXWDMENi\\n+pSlThxquK71D8u6vXuy\\n-----END PRIVATE KEY-----\\n';\nconst TOKEN_URI = 'https://oauth2.googleapis.com/token';\nfunction b64url(str) { return Buffer.from(str).toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nfunction b64urlBuf(buf) { return buf.toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nconst now = Math.floor(Date.now()/1000);\nconst hdr = b64url(JSON.stringify({alg:'RS256',typ:'JWT'}));\nconst pay = b64url(JSON.stringify({iss:SA_EMAIL,sub:SA_EMAIL,aud:TOKEN_URI,iat:now,exp:now+3600,scope:'https://www.googleapis.com/auth/cloud-platform'}));\nconst si = hdr + '.' + pay;\nconst signer = crypto.createSign('RSA-SHA256');\nsigner.update(si);\nconst jwt = si + '.' + b64urlBuf(signer.sign(SA_KEY));\nconst tokenRes = await this.helpers.httpRequest({method:'POST',url:TOKEN_URI,headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion='+jwt, timeout: 10000});\nif (!tokenRes.access_token) throw new Error('Token failed');\nconst TOKEN = tokenRes.access_token;\nconst creds = $('Publicar Credenciales').item.json;\nconst s = $input.item.json;\nconst EP = creds.EP;\nconst PJ = creds.PJ;\nconst LOC = creds.LOC;\nconst MDL = creds.MDL;\nconst veoRes = await this.helpers.httpRequest({\n  method: 'POST',\n  url: 'https://' + EP + '/v1/projects/' + PJ + '/locations/' + LOC + '/publishers/google/models/' + MDL + ':predictLongRunning',\n  headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + TOKEN },\n  body: JSON.stringify({\n    instances: [{ prompt: s.PROMPT_PART1, image: { bytesBase64Encoded: s.IMAGE_B64, mimeType: 'image/jpeg' } }],\n    parameters: { aspectRatio: s.ASPECT_RATIO, resolution: '720p', sampleCount: 1, durationSeconds: parseInt(s.DURATION), personGeneration: 'allow_all', addWatermark: false, includeRaiReason: true, generateAudio: true, storageUri: creds.STORAGE_URI_PART1, negativePrompt: 'background music, soundtrack, instrumental music, musical score, ambient music, piano, guitar, drums, orchestra, synthesizer, melody, rhythm, cinematic score, dramatic music, soft music, upbeat music, ambient sounds, ambient noise, room tone, wind sound, traffic noise, nature sounds, transition animation, visual transitions, fade, dissolve, wipe, crossfade, jump cut, abrupt transition, scene change, new background, different setting, blurry, text, letters, words, subtitles, captions, watermark, frozen face, closed mouth, extra hands, extra fingers, extra arms, extra limbs, duplicate body parts, morphing body, body transformation, logo animation, logo zoom, logo glow, logo enlargement, logo movement' }\n  }),\n  timeout: 30000\n});\nif (!veoRes.name) throw new Error('Veo Part 1 failed: ' + JSON.stringify(veoRes).substring(0, 300));\n\nreturn [{ json: { op1: veoRes.name, PROMPT_PART2: s.PROMPT_PART2, PROMPT_PART3: s.PROMPT_PART3, DURATION: s.DURATION, ASPECT_RATIO: s.ASPECT_RATIO, POST_ID: s.POST_ID, ORIGINAL_PROMPT: s.ORIGINAL_PROMPT } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        88096,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000006",
      "name": "Submit Part 1"
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        88320,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000007",
      "name": "Wait Part 1",
      "webhookId": "veo3-approved-wait-1"
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\nconst SA_EMAIL = 'vertex-veo@video-gen-msi.iam.gserviceaccount.com';\nconst SA_KEY = '-----BEGIN PRIVATE KEY-----\\nMIIEuwIBADANBgkqhkiG9w0BAQEFAASCBKUwggShAgEAAoIBAQDOuH1CtR7QVhT0\\n99yWCCuO2TkACYTjzWQTV8xXnvXNENgLuQjtv+iGXcLuIoFErYRW1aCpim3RwTep\\nCZisBEhCocUWUUdoNSxVoh9e21FRbY1U6ck2f73hLytIz2AtaJHhuy/MKsLjmkT2\\n2RGVnyu4+G6yXfCldVHtD4jHapXTUNkgyooCuQj+saqhtEsdjDbQTODTY4CUqLPI\\noMidS9yqyYRkzctpd2rwF3DtN42TV6dnhMY3ZPoZ5UpgXbseMAT5i9i3e35LQ0MK\\nVVxeSDOu7lCfA2hsdahBGF1nv186e+FsUXRKb+KhcFpxFWSKEKkxOjc/qkdEroY8\\nLjrat0DBAgMBAAECggEACALSyd/CgLDhUYf8eqz44SmOYa+8wGZAg1Zi8x9UJ70I\\nHlYuoCYQgQqHqBpat5pg10uilQdqD5elDE40pi/pS/nAbUe7lHCBFhV5EUA/E8CC\\n2mBP/aZwKZaeHw14TPIxOxX5uXgLwu3Cz+0kFxAKzfmEsrFcxtC32s/ADXhWM5Dr\\n7c/ilSUs3PbH5/wVTxjVkcpwN+hzl0Wv5u4BI65dq1zaMwT2gdTfDjmskNlEnupn\\n6nVxpmlRw1wNn/Z+C04VDOsAZtPJNSnnfQlVOFUgNvirgHudspmaYDqngO5583tr\\nwdBhwIy74NCLmff6uxFK3UB9HOl/rBjTCnrWxEl4kQKBgQDuWxFm8yfPtMO/m0Yt\\n9jRAAYFXQ7rM4fIFDVyUtHi85SiLo6fCxXvuxOgk4/D8MBxTbln3JttGEoLL6U26\\ntLfBIO7Yc9XDHYYKn7lYR3spa7+Y3Y3eqYQXjn4bY55p/9kPJlaNZhq+mFsapifE\\nBGUSVDE5i8iX/mLYk+zGH1OcKQKBgQDeBey0lXnJndQghY/TgMlrfkhMXhMk3vX3\\nN9yAJNlWlSsVPh7zN3YKbzMl+6JluU9acB9IIwMYlNJn4oadOP+s89k4bPSTi5H2\\nhrMSnMavYkPP9PRmCEMJfrbPefzvSUO4XrY6Idh2NKKZxzDJ0bG+rIQadxB4qHKF\\nlbiZSJUS2QJ/cZb0tBss3c9HegiFaWHrhJUzDmM4omsK611ywWtAHsUWjXVwfWGf\\nriood2wpbAWBekEcnqvl037+1i5Y3KFC8MbBDGYneNSZDHcR3QAzsYmnxTHQakxe\\npttBPcw7skg7KP0cQkZmeG4i/JAyYze08wcsbkAvWD/i21OjgsdrEQKBgQDLTI2E\\nheKw1Q5qgSJDvwewoD+/fdz1xBthtgr4Y8WHXKvIlcttVfmGcHBbdWEs2FRrMYPT\\nYAvztEI90dUFni2vxtG+szX47LJJFOpgPqJH8ii6AUjRLPuFdDwdG0yaJ3IVHtSp\\nwlgdVPEW8qggBR1GxV1phmDUuxmybHhOE4I9cQKBgHVGrcoRVdPlmFSRKYAlKrxZ\\nYNWqJP09bu+vSKGPYBo+zhYps58VjBRVjunPoQtSXYdK1aPnBMiMJPj0LVxB46fu\\nYV9mp1crPCpgLZW8EL9MawX0qp3xew6voBSIule4g2DH1yg7VBki+KPavXWDMENi\\n+pSlThxquK71D8u6vXuy\\n-----END PRIVATE KEY-----\\n';\nconst TOKEN_URI = 'https://oauth2.googleapis.com/token';\nfunction b64url(str) { return Buffer.from(str).toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nfunction b64urlBuf(buf) { return buf.toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nconst now = Math.floor(Date.now()/1000);\nconst hdr = b64url(JSON.stringify({alg:'RS256',typ:'JWT'}));\nconst pay = b64url(JSON.stringify({iss:SA_EMAIL,sub:SA_EMAIL,aud:TOKEN_URI,iat:now,exp:now+3600,scope:'https://www.googleapis.com/auth/cloud-platform'}));\nconst si = hdr + '.' + pay;\nconst signer = crypto.createSign('RSA-SHA256');\nsigner.update(si);\nconst jwt = si + '.' + b64urlBuf(signer.sign(SA_KEY));\nconst tokenRes = await this.helpers.httpRequest({method:'POST',url:TOKEN_URI,headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion='+jwt, timeout: 10000});\nif (!tokenRes.access_token) throw new Error('Token failed');\nconst TOKEN = tokenRes.access_token;\nconst creds = $('Publicar Credenciales').item.json;\nconst s = $input.item.json;\nconst EP = creds.EP;\nconst PJ = creds.PJ;\nconst LOC = creds.LOC;\nconst MDL = creds.MDL;\nconst res = await this.helpers.httpRequest({\n  method: 'POST',\n  url: 'https://' + EP + '/v1/projects/' + PJ + '/locations/' + LOC + '/publishers/google/models/' + MDL + ':fetchPredictOperation',\n  headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + TOKEN },\n  body: JSON.stringify({ operationName: s.op1 }),\n  timeout: 15000\n});\nlet videoUri = res.response?.videos?.[0]?.gcsUri || res.response?.videos?.[0]?.uri || '';\nif (!videoUri) throw new Error('Part 1 not ready: ' + JSON.stringify(res).substring(0, 400));\n\nreturn [{ json: { video1_gcs_uri: videoUri, PROMPT_PART2: s.PROMPT_PART2, PROMPT_PART3: s.PROMPT_PART3, DURATION: s.DURATION, ASPECT_RATIO: s.ASPECT_RATIO, POST_ID: s.POST_ID, ORIGINAL_PROMPT: s.ORIGINAL_PROMPT } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        88544,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000008",
      "name": "Fetch Part 1"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// Submit Part 2 as VIDEO-TO-VIDEO EXTENSION (not image-to-video)\n// Uses the GCS URI from Part 1 as the video input.\n// This leverages Veo 3.1's \"last second rule\" - the model samples\n// the last ~24 frames (1 second) of Part 1 to extract latent vectors\n// for voice timbre, visual identity, and motion continuity.\n// ============================================================\nconst crypto = require('crypto');\nconst SA_EMAIL = 'vertex-veo@video-gen-msi.iam.gserviceaccount.com';\nconst SA_KEY = '-----BEGIN PRIVATE KEY-----\\nMIIEuwIBADANBgkqhkiG9w0BAQEFAASCBKUwggShAgEAAoIBAQDOuH1CtR7QVhT0\\n99yWCCuO2TkACYTjzWQTV8xXnvXNENgLuQjtv+iGXcLuIoFErYRW1aCpim3RwTep\\nCZisBEhCocUWUUdoNSxVoh9e21FRbY1U6ck2f73hLytIz2AtaJHhuy/MKsLjmkT2\\n2RGVnyu4+G6yXfCldVHtD4jHapXTUNkgyooCuQj+saqhtEsdjDbQTODTY4CUqLPI\\noMidS9yqyYRkzctpd2rwF3DtN42TV6dnhMY3ZPoZ5UpgXbseMAT5i9i3e35LQ0MK\\nVVxeSDOu7lCfA2hsdahBGF1nv186e+FsUXRKb+KhcFpxFWSKEKkxOjc/qkdEroY8\\nLjrat0DBAgMBAAECggEACALSyd/CgLDhUYf8eqz44SmOYa+8wGZAg1Zi8x9UJ70I\\nHlYuoCYQgQqHqBpat5pg10uilQdqD5elDE40pi/pS/nAbUe7lHCBFhV5EUA/E8CC\\n2mBP/aZwKZaeHw14TPIxOxX5uXgLwu3Cz+0kFxAKzfmEsrFcxtC32s/ADXhWM5Dr\\n7c/ilSUs3PbH5/wVTxjVkcpwN+hzl0Wv5u4BI65dq1zaMwT2gdTfDjmskNlEnupn\\n6nVxpmlRw1wNn/Z+C04VDOsAZtPJNSnnfQlVOFUgNvirgHudspmaYDqngO5583tr\\nwdBhwIy74NCLmff6uxFK3UB9HOl/rBjTCnrWxEl4kQKBgQDuWxFm8yfPtMO/m0Yt\\n9jRAAYFXQ7rM4fIFDVyUtHi85SiLo6fCxXvuxOgk4/D8MBxTbln3JttGEoLL6U26\\ntLfBIO7Yc9XDHYYKn7lYR3spa7+Y3Y3eqYQXjn4bY55p/9kPJlaNZhq+mFsapifE\\nBGUSVDE5i8iX/mLYk+zGH1OcKQKBgQDeBey0lXnJndQghY/TgMlrfkhMXhMk3vX3\\nN9yAJNlWlSsVPh7zN3YKbzMl+6JluU9acB9IIwMYlNJn4oadOP+s89k4bPSTi5H2\\nhrMSnMavYkPP9PRmCEMJfrbPefzvSUO4XrY6Idh2NKKZxzDJ0bG+rIQadxB4qHKF\\nlbiZSJUS2QJ/cZb0tBss3c9HegiFaWHrhJUzDmM4omsK611ywWtAHsUWjXVwfWGf\\nriood2wpbAWBekEcnqvl037+1i5Y3KFC8MbBDGYneNSZDHcR3QAzsYmnxTHQakxe\\npttBPcw7skg7KP0cQkZmeG4i/JAyYze08wcsbkAvWD/i21OjgsdrEQKBgQDLTI2E\\nheKw1Q5qgSJDvwewoD+/fdz1xBthtgr4Y8WHXKvIlcttVfmGcHBbdWEs2FRrMYPT\\nYAvztEI90dUFni2vxtG+szX47LJJFOpgPqJH8ii6AUjRLPuFdDwdG0yaJ3IVHtSp\\nwlgdVPEW8qggBR1GxV1phmDUuxmybHhOE4I9cQKBgHVGrcoRVdPlmFSRKYAlKrxZ\\nYNWqJP09bu+vSKGPYBo+zhYps58VjBRVjunPoQtSXYdK1aPnBMiMJPj0LVxB46fu\\nYV9mp1crPCpgLZW8EL9MawX0qp3xew6voBSIule4g2DH1yg7VBki+KPavXWDMENi\\n+pSlThxquK71D8u6vXuy\\n-----END PRIVATE KEY-----\\n';\nconst TOKEN_URI = 'https://oauth2.googleapis.com/token';\nfunction b64url(str) { return Buffer.from(str).toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nfunction b64urlBuf(buf) { return buf.toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nconst now = Math.floor(Date.now()/1000);\nconst hdr = b64url(JSON.stringify({alg:'RS256',typ:'JWT'}));\nconst pay = b64url(JSON.stringify({iss:SA_EMAIL,sub:SA_EMAIL,aud:TOKEN_URI,iat:now,exp:now+3600,scope:'https://www.googleapis.com/auth/cloud-platform'}));\nconst si = hdr + '.' + pay;\nconst signer = crypto.createSign('RSA-SHA256');\nsigner.update(si);\nconst jwt = si + '.' + b64urlBuf(signer.sign(SA_KEY));\nconst tokenRes = await this.helpers.httpRequest({method:'POST',url:TOKEN_URI,headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion='+jwt, timeout: 10000});\nif (!tokenRes.access_token) throw new Error('Token failed');\nconst TOKEN = tokenRes.access_token;\nconst creds = $('Publicar Credenciales').item.json;\nconst s = $input.item.json;\nconst EP = creds.EP;\nconst PJ = creds.PJ;\nconst LOC = creds.LOC;\nconst MDL = creds.MDL_EXTEND;\n\n// KEY DIFFERENCE: Use video.gcsUri + mimeType for video extension mode\n// Extension only supported on veo-3.1-generate-preview (NOT -001)\nconst veoRes = await this.helpers.httpRequest({\n  method: 'POST',\n  url: 'https://' + EP + '/v1/projects/' + PJ + '/locations/' + LOC + '/publishers/google/models/' + MDL + ':predictLongRunning',\n  headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + TOKEN },\n  body: JSON.stringify({\n    instances: [{ prompt: s.PROMPT_PART2, video: { gcsUri: s.video1_gcs_uri, mimeType: 'video/mp4' } }],\n    parameters: { storageUri: creds.STORAGE_URI_PART2, sampleCount: 1, generateAudio: true, personGeneration: 'allow_all', negativePrompt: 'different voice, voice change, new speaker, different accent, different tone, different pitch, background music, soundtrack, instrumental music, musical score, ambient music, piano, guitar, drums, orchestra, synthesizer, melody, cinematic score, transition animation, fade, dissolve, wipe, crossfade, jump cut, abrupt transition, scene change, new background, different setting, blurry, text, subtitles, watermark, frozen face, closed mouth, extra hands, extra fingers, extra arms, extra limbs, duplicate body parts, morphing body' }\n  }),\n  timeout: 30000\n});\nif (!veoRes.name) throw new Error('Veo Part 2 (extend) failed: ' + JSON.stringify(veoRes).substring(0, 300));\n\nreturn [{ json: { op2: veoRes.name, video1_gcs_uri: s.video1_gcs_uri, PROMPT_PART3: s.PROMPT_PART3, DURATION: s.DURATION, POST_ID: s.POST_ID, ORIGINAL_PROMPT: s.ORIGINAL_PROMPT } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        88768,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000009",
      "name": "Submit Part 2"
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        88992,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000010",
      "name": "Wait Part 2",
      "webhookId": "veo3-approved-wait-2"
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\nconst SA_EMAIL = 'vertex-veo@video-gen-msi.iam.gserviceaccount.com';\nconst SA_KEY = '-----BEGIN PRIVATE KEY-----\\nMIIEuwIBADANBgkqhkiG9w0BAQEFAASCBKUwggShAgEAAoIBAQDOuH1CtR7QVhT0\\n99yWCCuO2TkACYTjzWQTV8xXnvXNENgLuQjtv+iGXcLuIoFErYRW1aCpim3RwTep\\nCZisBEhCocUWUUdoNSxVoh9e21FRbY1U6ck2f73hLytIz2AtaJHhuy/MKsLjmkT2\\n2RGVnyu4+G6yXfCldVHtD4jHapXTUNkgyooCuQj+saqhtEsdjDbQTODTY4CUqLPI\\noMidS9yqyYRkzctpd2rwF3DtN42TV6dnhMY3ZPoZ5UpgXbseMAT5i9i3e35LQ0MK\\nVVxeSDOu7lCfA2hsdahBGF1nv186e+FsUXRKb+KhcFpxFWSKEKkxOjc/qkdEroY8\\nLjrat0DBAgMBAAECggEACALSyd/CgLDhUYf8eqz44SmOYa+8wGZAg1Zi8x9UJ70I\\nHlYuoCYQgQqHqBpat5pg10uilQdqD5elDE40pi/pS/nAbUe7lHCBFhV5EUA/E8CC\\n2mBP/aZwKZaeHw14TPIxOxX5uXgLwu3Cz+0kFxAKzfmEsrFcxtC32s/ADXhWM5Dr\\n7c/ilSUs3PbH5/wVTxjVkcpwN+hzl0Wv5u4BI65dq1zaMwT2gdTfDjmskNlEnupn\\n6nVxpmlRw1wNn/Z+C04VDOsAZtPJNSnnfQlVOFUgNvirgHudspmaYDqngO5583tr\\nwdBhwIy74NCLmff6uxFK3UB9HOl/rBjTCnrWxEl4kQKBgQDuWxFm8yfPtMO/m0Yt\\n9jRAAYFXQ7rM4fIFDVyUtHi85SiLo6fCxXvuxOgk4/D8MBxTbln3JttGEoLL6U26\\ntLfBIO7Yc9XDHYYKn7lYR3spa7+Y3Y3eqYQXjn4bY55p/9kPJlaNZhq+mFsapifE\\nBGUSVDE5i8iX/mLYk+zGH1OcKQKBgQDeBey0lXnJndQghY/TgMlrfkhMXhMk3vX3\\nN9yAJNlWlSsVPh7zN3YKbzMl+6JluU9acB9IIwMYlNJn4oadOP+s89k4bPSTi5H2\\nhrMSnMavYkPP9PRmCEMJfrbPefzvSUO4XrY6Idh2NKKZxzDJ0bG+rIQadxB4qHKF\\nlbiZSJUS2QJ/cZb0tBss3c9HegiFaWHrhJUzDmM4omsK611ywWtAHsUWjXVwfWGf\\nriood2wpbAWBekEcnqvl037+1i5Y3KFC8MbBDGYneNSZDHcR3QAzsYmnxTHQakxe\\npttBPcw7skg7KP0cQkZmeG4i/JAyYze08wcsbkAvWD/i21OjgsdrEQKBgQDLTI2E\\nheKw1Q5qgSJDvwewoD+/fdz1xBthtgr4Y8WHXKvIlcttVfmGcHBbdWEs2FRrMYPT\\nYAvztEI90dUFni2vxtG+szX47LJJFOpgPqJH8ii6AUjRLPuFdDwdG0yaJ3IVHtSp\\nwlgdVPEW8qggBR1GxV1phmDUuxmybHhOE4I9cQKBgHVGrcoRVdPlmFSRKYAlKrxZ\\nYNWqJP09bu+vSKGPYBo+zhYps58VjBRVjunPoQtSXYdK1aPnBMiMJPj0LVxB46fu\\nYV9mp1crPCpgLZW8EL9MawX0qp3xew6voBSIule4g2DH1yg7VBki+KPavXWDMENi\\n+pSlThxquK71D8u6vXuy\\n-----END PRIVATE KEY-----\\n';\nconst TOKEN_URI = 'https://oauth2.googleapis.com/token';\nfunction b64url(str) { return Buffer.from(str).toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nfunction b64urlBuf(buf) { return buf.toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nconst now = Math.floor(Date.now()/1000);\nconst hdr = b64url(JSON.stringify({alg:'RS256',typ:'JWT'}));\nconst pay = b64url(JSON.stringify({iss:SA_EMAIL,sub:SA_EMAIL,aud:TOKEN_URI,iat:now,exp:now+3600,scope:'https://www.googleapis.com/auth/cloud-platform'}));\nconst si = hdr + '.' + pay;\nconst signer = crypto.createSign('RSA-SHA256');\nsigner.update(si);\nconst jwt = si + '.' + b64urlBuf(signer.sign(SA_KEY));\nconst tokenRes = await this.helpers.httpRequest({method:'POST',url:TOKEN_URI,headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion='+jwt, timeout: 10000});\nif (!tokenRes.access_token) throw new Error('Token failed');\nconst TOKEN = tokenRes.access_token;\nconst creds = $('Publicar Credenciales').item.json;\nconst s = $input.item.json;\nconst EP = creds.EP;\nconst PJ = creds.PJ;\nconst LOC = creds.LOC;\nconst MDL = creds.MDL_EXTEND;\nconst res = await this.helpers.httpRequest({\n  method: 'POST',\n  url: 'https://' + EP + '/v1/projects/' + PJ + '/locations/' + LOC + '/publishers/google/models/' + MDL + ':fetchPredictOperation',\n  headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + TOKEN },\n  body: JSON.stringify({ operationName: s.op2 }),\n  timeout: 15000\n});\nlet videoUri = res.response?.videos?.[0]?.gcsUri || res.response?.videos?.[0]?.uri || '';\nif (!videoUri) throw new Error('Part 2 (extend) not ready: ' + JSON.stringify(res).substring(0, 400));\n\nreturn [{ json: { video1_gcs_uri: s.video1_gcs_uri, video2_gcs_uri: videoUri, PROMPT_PART3: s.PROMPT_PART3, POST_ID: s.POST_ID, ORIGINAL_PROMPT: s.ORIGINAL_PROMPT, DURATION: s.DURATION } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        89216,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000011",
      "name": "Fetch Part 2"
    },
    {
      "parameters": {
        "jsCode": "// Generate V4 Signed URLs so browser can download videos\nconst crypto = require('crypto');\nconst s = $input.item.json;\nconst SA_EMAIL = 'vertex-veo@video-gen-msi.iam.gserviceaccount.com';\nconst SA_KEY = '-----BEGIN PRIVATE KEY-----\\nMIIEuwIBADANBgkqhkiG9w0BAQEFAASCBKUwggShAgEAAoIBAQDOuH1CtR7QVhT0\\n99yWCCuO2TkACYTjzWQTV8xXnvXNENgLuQjtv+iGXcLuIoFErYRW1aCpim3RwTep\\nCZisBEhCocUWUUdoNSxVoh9e21FRbY1U6ck2f73hLytIz2AtaJHhuy/MKsLjmkT2\\n2RGVnyu4+G6yXfCldVHtD4jHapXTUNkgyooCuQj+saqhtEsdjDbQTODTY4CUqLPI\\noMidS9yqyYRkzctpd2rwF3DtN42TV6dnhMY3ZPoZ5UpgXbseMAT5i9i3e35LQ0MK\\nVVxeSDOu7lCfA2hsdahBGF1nv186e+FsUXRKb+KhcFpxFWSKEKkxOjc/qkdEroY8\\nLjrat0DBAgMBAAECggEACALSyd/CgLDhUYf8eqz44SmOYa+8wGZAg1Zi8x9UJ70I\\nHlYuoCYQgQqHqBpat5pg10uilQdqD5elDE40pi/pS/nAbUe7lHCBFhV5EUA/E8CC\\n2mBP/aZwKZaeHw14TPIxOxX5uXgLwu3Cz+0kFxAKzfmEsrFcxtC32s/ADXhWM5Dr\\n7c/ilSUs3PbH5/wVTxjVkcpwN+hzl0Wv5u4BI65dq1zaMwT2gdTfDjmskNlEnupn\\n6nVxpmlRw1wNn/Z+C04VDOsAZtPJNSnnfQlVOFUgNvirgHudspmaYDqngO5583tr\\nwdBhwIy74NCLmff6uxFK3UB9HOl/rBjTCnrWxEl4kQKBgQDuWxFm8yfPtMO/m0Yt\\n9jRAAYFXQ7rM4fIFDVyUtHi85SiLo6fCxXvuxOgk4/D8MBxTbln3JttGEoLL6U26\\ntLfBIO7Yc9XDHYYKn7lYR3spa7+Y3Y3eqYQXjn4bY55p/9kPJlaNZhq+mFsapifE\\nBGUSVDE5i8iX/mLYk+zGH1OcKQKBgQDeBey0lXnJndQghY/TgMlrfkhMXhMk3vX3\\nN9yAJNlWlSsVPh7zN3YKbzMl+6JluU9acB9IIwMYlNJn4oadOP+s89k4bPSTi5H2\\nhrMSnMavYkPP9PRmCEMJfrbPefzvSUO4XrY6Idh2NKKZxzDJ0bG+rIQadxB4qHKF\\nlbiZSJUS2QJ/cZb0tBss3c9HegiFaWHrhJUzDmM4omsK611ywWtAHsUWjXVwfWGf\\nriood2wpbAWBekEcnqvl037+1i5Y3KFC8MbBDGYneNSZDHcR3QAzsYmnxTHQakxe\\npttBPcw7skg7KP0cQkZmeG4i/JAyYze08wcsbkAvWD/i21OjgsdrEQKBgQDLTI2E\\nheKw1Q5qgSJDvwewoD+/fdz1xBthtgr4Y8WHXKvIlcttVfmGcHBbdWEs2FRrMYPT\\nYAvztEI90dUFni2vxtG+szX47LJJFOpgPqJH8ii6AUjRLPuFdDwdG0yaJ3IVHtSp\\nwlgdVPEW8qggBR1GxV1phmDUuxmybHhOE4I9cQKBgHVGrcoRVdPlmFSRKYAlKrxZ\\nYNWqJP09bu+vSKGPYBo+zhYps58VjBRVjunPoQtSXYdK1aPnBMiMJPj0LVxB46fu\\nYV9mp1crPCpgLZW8EL9MawX0qp3xew6voBSIule4g2DH1yg7VBki+KPavXWDMENi\\n+pSlThxquK71D8u6vXuy\\n-----END PRIVATE KEY-----\\n';\n\nfunction signUrl(gsUri) {\n  const m = gsUri.match(/^gs:\\/\\/([^\\/]+)\\/(.+)$/);\n  if (!m) return gsUri;\n  const bucket = m[1], objPath = m[2], host = 'storage.googleapis.com';\n  const d = new Date();\n  const pad = v => String(v).padStart(2, '0');\n  const ds = d.getUTCFullYear() + '' + pad(d.getUTCMonth()+1) + pad(d.getUTCDate());\n  const dt = ds + 'T' + pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + pad(d.getUTCSeconds()) + 'Z';\n  const scope = ds + '/auto/storage/goog4_request';\n  const cred = SA_EMAIL + '/' + scope;\n  const qs = 'X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=' + encodeURIComponent(cred) + '&X-Goog-Date=' + dt + '&X-Goog-Expires=604800&X-Goog-SignedHeaders=host';\n  const objEnc = objPath.split('/').map(p => encodeURIComponent(p)).join('/');\n  const canon = 'GET\\n/' + bucket + '/' + objEnc + '\\n' + qs + '\\nhost:' + host + '\\n\\nhost\\nUNSIGNED-PAYLOAD';\n  const sts = 'GOOG4-RSA-SHA256\\n' + dt + '\\n' + scope + '\\n' + crypto.createHash('sha256').update(canon).digest('hex');\n  const sg = crypto.createSign('RSA-SHA256');\n  sg.update(sts);\n  return 'https://' + host + '/' + bucket + '/' + objEnc + '?' + qs + '&X-Goog-Signature=' + sg.sign(SA_KEY, 'hex');\n}\n\nreturn [{ json: {\n  video1_gcs_uri: s.video1_gcs_uri,\n  video2_gcs_uri: s.video2_gcs_uri,\n  video3_gcs_uri: s.video3_gcs_uri,\n  video1_url: signUrl(s.video1_gcs_uri),\n  video2_url: signUrl(s.video2_gcs_uri),\n  video3_url: signUrl(s.video3_gcs_uri),\n  POST_ID: s.POST_ID,\n  ORIGINAL_PROMPT: s.ORIGINAL_PROMPT,\n  DURATION: s.DURATION\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        90112,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000012",
      "name": "Generate URLs"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.POST_ID && $json.POST_ID.length > 10 ? `UPDATE social_posts SET post_type = 'Video', video_part1_uri = '${$json.video1_gcs_uri}', video_part2_uri = '${$json.video2_gcs_uri}', video1_signed_url = '${$json.video1_url}', video2_signed_url = '${$json.video2_url}', video_part3_uri = '${$json.video3_gcs_uri}', video3_signed_url = '${$json.video3_url}', status = 'video_completed', updated_at = NOW() WHERE id = '${$json.POST_ID}' RETURNING *` : `INSERT INTO social_posts (post_type, status, headline, post_copy, image_url, video_part1_uri, video_part2_uri, video_part3_uri, video1_signed_url, video2_signed_url, video3_signed_url, created_at, updated_at) VALUES ('Video', 'video_completed', LEFT('${($json.ORIGINAL_PROMPT || '').replace(/'/g, \"''\")}', 120), '${($json.ORIGINAL_PROMPT || '').replace(/'/g, \"''\")}', '${$json.video1_url}', '${$json.video1_gcs_uri}', '${$json.video2_gcs_uri}', '${$json.video3_gcs_uri}', '${$json.video1_url}', '${$json.video2_url}', '${$json.video3_url}', NOW(), NOW()) RETURNING *` }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        90336,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000013",
      "name": "Update DB",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Video generated and saved to database', data: { video1_url: $('Generate URLs').item.json.video1_url, video2_url: $('Generate URLs').item.json.video2_url, video3_url: $('Generate URLs').item.json.video3_url, video1_gcs_uri: $('Generate URLs').item.json.video1_gcs_uri, video2_gcs_uri: $('Generate URLs').item.json.video2_gcs_uri, video3_gcs_uri: $('Generate URLs').item.json.video3_gcs_uri, post_id: $('Update DB').item.json?.id || $('Generate URLs').item.json.POST_ID, db_saved: true, duration: (parseInt($('Generate URLs').item.json.DURATION) * 2) + 's', prompt: $('Generate URLs').item.json.ORIGINAL_PROMPT, service: $('Format Approved Input').item.json.SERVICE } }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        90560,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000014",
      "name": "Respond Success"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// Submit Part 3 as VIDEO-TO-VIDEO EXTENSION (Call to Action) (not image-to-video)\n// Uses the GCS URI from Part 2 as the video input.\n// This leverages Veo 3.1's \"last second rule\" - the model samples\n// the last ~24 frames (1 second) of Part 1 to extract latent vectors\n// for voice timbre, visual identity, and motion continuity.\n// ============================================================\nconst crypto = require('crypto');\nconst SA_EMAIL = 'vertex-veo@video-gen-msi.iam.gserviceaccount.com';\nconst SA_KEY = '-----BEGIN PRIVATE KEY-----\\nMIIEuwIBADANBgkqhkiG9w0BAQEFAASCBKUwggShAgEAAoIBAQDOuH1CtR7QVhT0\\n99yWCCuO2TkACYTjzWQTV8xXnvXNENgLuQjtv+iGXcLuIoFErYRW1aCpim3RwTep\\nCZisBEhCocUWUUdoNSxVoh9e21FRbY1U6ck2f73hLytIz2AtaJHhuy/MKsLjmkT2\\n2RGVnyu4+G6yXfCldVHtD4jHapXTUNkgyooCuQj+saqhtEsdjDbQTODTY4CUqLPI\\noMidS9yqyYRkzctpd2rwF3DtN42TV6dnhMY3ZPoZ5UpgXbseMAT5i9i3e35LQ0MK\\nVVxeSDOu7lCfA2hsdahBGF1nv186e+FsUXRKb+KhcFpxFWSKEKkxOjc/qkdEroY8\\nLjrat0DBAgMBAAECggEACALSyd/CgLDhUYf8eqz44SmOYa+8wGZAg1Zi8x9UJ70I\\nHlYuoCYQgQqHqBpat5pg10uilQdqD5elDE40pi/pS/nAbUe7lHCBFhV5EUA/E8CC\\n2mBP/aZwKZaeHw14TPIxOxX5uXgLwu3Cz+0kFxAKzfmEsrFcxtC32s/ADXhWM5Dr\\n7c/ilSUs3PbH5/wVTxjVkcpwN+hzl0Wv5u4BI65dq1zaMwT2gdTfDjmskNlEnupn\\n6nVxpmlRw1wNn/Z+C04VDOsAZtPJNSnnfQlVOFUgNvirgHudspmaYDqngO5583tr\\nwdBhwIy74NCLmff6uxFK3UB9HOl/rBjTCnrWxEl4kQKBgQDuWxFm8yfPtMO/m0Yt\\n9jRAAYFXQ7rM4fIFDVyUtHi85SiLo6fCxXvuxOgk4/D8MBxTbln3JttGEoLL6U26\\ntLfBIO7Yc9XDHYYKn7lYR3spa7+Y3Y3eqYQXjn4bY55p/9kPJlaNZhq+mFsapifE\\nBGUSVDE5i8iX/mLYk+zGH1OcKQKBgQDeBey0lXnJndQghY/TgMlrfkhMXhMk3vX3\\nN9yAJNlWlSsVPh7zN3YKbzMl+6JluU9acB9IIwMYlNJn4oadOP+s89k4bPSTi5H2\\nhrMSnMavYkPP9PRmCEMJfrbPefzvSUO4XrY6Idh2NKKZxzDJ0bG+rIQadxB4qHKF\\nlbiZSJUS2QJ/cZb0tBss3c9HegiFaWHrhJUzDmM4omsK611ywWtAHsUWjXVwfWGf\\nriood2wpbAWBekEcnqvl037+1i5Y3KFC8MbBDGYneNSZDHcR3QAzsYmnxTHQakxe\\npttBPcw7skg7KP0cQkZmeG4i/JAyYze08wcsbkAvWD/i21OjgsdrEQKBgQDLTI2E\\nheKw1Q5qgSJDvwewoD+/fdz1xBthtgr4Y8WHXKvIlcttVfmGcHBbdWEs2FRrMYPT\\nYAvztEI90dUFni2vxtG+szX47LJJFOpgPqJH8ii6AUjRLPuFdDwdG0yaJ3IVHtSp\\nwlgdVPEW8qggBR1GxV1phmDUuxmybHhOE4I9cQKBgHVGrcoRVdPlmFSRKYAlKrxZ\\nYNWqJP09bu+vSKGPYBo+zhYps58VjBRVjunPoQtSXYdK1aPnBMiMJPj0LVxB46fu\\nYV9mp1crPCpgLZW8EL9MawX0qp3xew6voBSIule4g2DH1yg7VBki+KPavXWDMENi\\n+pSlThxquK71D8u6vXuy\\n-----END PRIVATE KEY-----\\n';\nconst TOKEN_URI = 'https://oauth2.googleapis.com/token';\nfunction b64url(str) { return Buffer.from(str).toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nfunction b64urlBuf(buf) { return buf.toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nconst now = Math.floor(Date.now()/1000);\nconst hdr = b64url(JSON.stringify({alg:'RS256',typ:'JWT'}));\nconst pay = b64url(JSON.stringify({iss:SA_EMAIL,sub:SA_EMAIL,aud:TOKEN_URI,iat:now,exp:now+3600,scope:'https://www.googleapis.com/auth/cloud-platform'}));\nconst si = hdr + '.' + pay;\nconst signer = crypto.createSign('RSA-SHA256');\nsigner.update(si);\nconst jwt = si + '.' + b64urlBuf(signer.sign(SA_KEY));\nconst tokenRes = await this.helpers.httpRequest({method:'POST',url:TOKEN_URI,headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion='+jwt, timeout: 10000});\nif (!tokenRes.access_token) throw new Error('Token failed');\nconst TOKEN = tokenRes.access_token;\nconst creds = $('Publicar Credenciales').item.json;\nconst s = $input.item.json;\nconst EP = creds.EP;\nconst PJ = creds.PJ;\nconst LOC = creds.LOC;\nconst MDL = creds.MDL_EXTEND;\n\n// KEY DIFFERENCE: Use video.gcsUri + mimeType for video extension mode\n// Extension only supported on veo-3.1-generate-preview (NOT -001)\nconst veoRes = await this.helpers.httpRequest({\n  method: 'POST',\n  url: 'https://' + EP + '/v1/projects/' + PJ + '/locations/' + LOC + '/publishers/google/models/' + MDL + ':predictLongRunning',\n  headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + TOKEN },\n  body: JSON.stringify({\n    instances: [{ prompt: s.PROMPT_PART3, video: { gcsUri: s.video2_gcs_uri, mimeType: 'video/mp4' } }],\n    parameters: { storageUri: creds.STORAGE_URI_PART3, sampleCount: 1, generateAudio: true, personGeneration: 'allow_all', negativePrompt: 'different voice, voice change, new speaker, different accent, different tone, different pitch, background music, soundtrack, instrumental music, musical score, ambient music, piano, guitar, drums, orchestra, synthesizer, melody, cinematic score, transition animation, fade, dissolve, wipe, crossfade, jump cut, abrupt transition, scene change, new background, different setting, blurry, text, subtitles, watermark, frozen face, closed mouth, extra hands, extra fingers, extra arms, extra limbs, duplicate body parts, morphing body' }\n  }),\n  timeout: 30000\n});\nif (!veoRes.name) throw new Error('Veo Part 3 (extend) failed: ' + JSON.stringify(veoRes).substring(0, 300));\n\nreturn [{ json: { op3: veoRes.name, video1_gcs_uri: s.video1_gcs_uri, video2_gcs_uri: s.video2_gcs_uri, DURATION: s.DURATION, POST_ID: s.POST_ID, ORIGINAL_PROMPT: s.ORIGINAL_PROMPT } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        89440,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000015",
      "name": "Submit Part 3"
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        89664,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000016",
      "name": "Wait Part 3",
      "webhookId": "veo3-approved-wait-3"
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\nconst SA_EMAIL = 'vertex-veo@video-gen-msi.iam.gserviceaccount.com';\nconst SA_KEY = '-----BEGIN PRIVATE KEY-----\\nMIIEuwIBADANBgkqhkiG9w0BAQEFAASCBKUwggShAgEAAoIBAQDOuH1CtR7QVhT0\\n99yWCCuO2TkACYTjzWQTV8xXnvXNENgLuQjtv+iGXcLuIoFErYRW1aCpim3RwTep\\nCZisBEhCocUWUUdoNSxVoh9e21FRbY1U6ck2f73hLytIz2AtaJHhuy/MKsLjmkT2\\n2RGVnyu4+G6yXfCldVHtD4jHapXTUNkgyooCuQj+saqhtEsdjDbQTODTY4CUqLPI\\noMidS9yqyYRkzctpd2rwF3DtN42TV6dnhMY3ZPoZ5UpgXbseMAT5i9i3e35LQ0MK\\nVVxeSDOu7lCfA2hsdahBGF1nv186e+FsUXRKb+KhcFpxFWSKEKkxOjc/qkdEroY8\\nLjrat0DBAgMBAAECggEACALSyd/CgLDhUYf8eqz44SmOYa+8wGZAg1Zi8x9UJ70I\\nHlYuoCYQgQqHqBpat5pg10uilQdqD5elDE40pi/pS/nAbUe7lHCBFhV5EUA/E8CC\\n2mBP/aZwKZaeHw14TPIxOxX5uXgLwu3Cz+0kFxAKzfmEsrFcxtC32s/ADXhWM5Dr\\n7c/ilSUs3PbH5/wVTxjVkcpwN+hzl0Wv5u4BI65dq1zaMwT2gdTfDjmskNlEnupn\\n6nVxpmlRw1wNn/Z+C04VDOsAZtPJNSnnfQlVOFUgNvirgHudspmaYDqngO5583tr\\nwdBhwIy74NCLmff6uxFK3UB9HOl/rBjTCnrWxEl4kQKBgQDuWxFm8yfPtMO/m0Yt\\n9jRAAYFXQ7rM4fIFDVyUtHi85SiLo6fCxXvuxOgk4/D8MBxTbln3JttGEoLL6U26\\ntLfBIO7Yc9XDHYYKn7lYR3spa7+Y3Y3eqYQXjn4bY55p/9kPJlaNZhq+mFsapifE\\nBGUSVDE5i8iX/mLYk+zGH1OcKQKBgQDeBey0lXnJndQghY/TgMlrfkhMXhMk3vX3\\nN9yAJNlWlSsVPh7zN3YKbzMl+6JluU9acB9IIwMYlNJn4oadOP+s89k4bPSTi5H2\\nhrMSnMavYkPP9PRmCEMJfrbPefzvSUO4XrY6Idh2NKKZxzDJ0bG+rIQadxB4qHKF\\nlbiZSJUS2QJ/cZb0tBss3c9HegiFaWHrhJUzDmM4omsK611ywWtAHsUWjXVwfWGf\\nriood2wpbAWBekEcnqvl037+1i5Y3KFC8MbBDGYneNSZDHcR3QAzsYmnxTHQakxe\\npttBPcw7skg7KP0cQkZmeG4i/JAyYze08wcsbkAvWD/i21OjgsdrEQKBgQDLTI2E\\nheKw1Q5qgSJDvwewoD+/fdz1xBthtgr4Y8WHXKvIlcttVfmGcHBbdWEs2FRrMYPT\\nYAvztEI90dUFni2vxtG+szX47LJJFOpgPqJH8ii6AUjRLPuFdDwdG0yaJ3IVHtSp\\nwlgdVPEW8qggBR1GxV1phmDUuxmybHhOE4I9cQKBgHVGrcoRVdPlmFSRKYAlKrxZ\\nYNWqJP09bu+vSKGPYBo+zhYps58VjBRVjunPoQtSXYdK1aPnBMiMJPj0LVxB46fu\\nYV9mp1crPCpgLZW8EL9MawX0qp3xew6voBSIule4g2DH1yg7VBki+KPavXWDMENi\\n+pSlThxquK71D8u6vXuy\\n-----END PRIVATE KEY-----\\n';\nconst TOKEN_URI = 'https://oauth2.googleapis.com/token';\nfunction b64url(str) { return Buffer.from(str).toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nfunction b64urlBuf(buf) { return buf.toString('base64').replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=/g,''); }\nconst now = Math.floor(Date.now()/1000);\nconst hdr = b64url(JSON.stringify({alg:'RS256',typ:'JWT'}));\nconst pay = b64url(JSON.stringify({iss:SA_EMAIL,sub:SA_EMAIL,aud:TOKEN_URI,iat:now,exp:now+3600,scope:'https://www.googleapis.com/auth/cloud-platform'}));\nconst si = hdr + '.' + pay;\nconst signer = crypto.createSign('RSA-SHA256');\nsigner.update(si);\nconst jwt = si + '.' + b64urlBuf(signer.sign(SA_KEY));\nconst tokenRes = await this.helpers.httpRequest({method:'POST',url:TOKEN_URI,headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion='+jwt, timeout: 10000});\nif (!tokenRes.access_token) throw new Error('Token failed');\nconst TOKEN = tokenRes.access_token;\nconst creds = $('Publicar Credenciales').item.json;\nconst s = $input.item.json;\nconst EP = creds.EP;\nconst PJ = creds.PJ;\nconst LOC = creds.LOC;\nconst MDL = creds.MDL_EXTEND;\nconst res = await this.helpers.httpRequest({\n  method: 'POST',\n  url: 'https://' + EP + '/v1/projects/' + PJ + '/locations/' + LOC + '/publishers/google/models/' + MDL + ':fetchPredictOperation',\n  headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + TOKEN },\n  body: JSON.stringify({ operationName: s.op3 }),\n  timeout: 15000\n});\nlet videoUri = res.response?.videos?.[0]?.gcsUri || res.response?.videos?.[0]?.uri || '';\nif (!videoUri) throw new Error('Part 3 (extend) not ready: ' + JSON.stringify(res).substring(0, 400));\n\nreturn [{ json: { video1_gcs_uri: s.video1_gcs_uri, video2_gcs_uri: s.video2_gcs_uri, video3_gcs_uri: videoUri, POST_ID: s.POST_ID, ORIGINAL_PROMPT: s.ORIGINAL_PROMPT, DURATION: s.DURATION } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        89888,
        -1616
      ],
      "id": "e2b00002-bbbb-4002-c002-000000000017",
      "name": "Fetch Part 3"
    }
  ],
  "connections": {
    "Webhook - Video Approved": {
      "main": [
        [
          {
            "node": "Publicar Credenciales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Publicar Credenciales": {
      "main": [
        [
          {
            "node": "Format Approved Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Approved Input": {
      "main": [
        [
          {
            "node": "Download Image 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image 1": {
      "main": [
        [
          {
            "node": "Submit Part 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Submit Part 1": {
      "main": [
        [
          {
            "node": "Wait Part 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Part 1": {
      "main": [
        [
          {
            "node": "Fetch Part 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Part 1": {
      "main": [
        [
          {
            "node": "Submit Part 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Submit Part 2": {
      "main": [
        [
          {
            "node": "Wait Part 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Part 2": {
      "main": [
        [
          {
            "node": "Fetch Part 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Part 2": {
      "main": [
        [
          {
            "node": "Submit Part 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate URLs": {
      "main": [
        [
          {
            "node": "Update DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update DB": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Submit Part 3": {
      "main": [
        [
          {
            "node": "Wait Part 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Part 3": {
      "main": [
        [
          {
            "node": "Fetch Part 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Part 3": {
      "main": [
        [
          {
            "node": "Generate URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e"
  }
}