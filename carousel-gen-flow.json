{
  "name": "MSI Carousel Generator v4",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "msi-carousel-gen",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-400, 300],
      "id": "webhook-carousel-gen",
      "name": "Webhook - Carousel Gen",
      "webhookId": "msi-carousel-gen"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nlet data;\nif (input.body) {\n  if (typeof input.body === 'string') {\n    try { data = JSON.parse(input.body); } catch (e) { data = input; }\n  } else if (typeof input.body === 'object') {\n    data = input.body;\n  } else { data = input; }\n} else if (input.query) { data = input.query; }\nelse { data = input; }\n\nconst slides = data.slides || [];\nconst visual_style = data.visual_style || 'Modern 3D';\nconst topic = data.topic || '';\n\nconst color_primary = data.color_palette?.primary || data.color_primary || '#207CE5';\nconst color_secondary = data.color_palette?.secondary || data.color_secondary || '#004AAD';\nconst color_accent = data.color_palette?.accent || data.color_accent || '#FFFDF1';\nconst color_dark = data.color_palette?.dark || data.color_dark || '#2B2B2B';\n\nif (!slides || slides.length === 0) {\n  throw new Error('At least one slide is required.');\n}\n\nreturn [{ json: { slides, visual_style, topic, color_primary, color_secondary, color_accent, color_dark, total_slides: slides.length } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-180, 300],
      "id": "format-input",
      "name": "Format Input"
    },
    {
      "parameters": {
        "url": "https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png",
        "options": { "response": { "response": { "responseFormat": "file" } } }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [40, 300],
      "id": "download-logo",
      "name": "Download Logo"
    },
    {
      "parameters": {
        "jsCode": "const formInput = $('Format Input').item.json;\nconst logoItem = $input.item;\n\nlet logoBase64 = '';\nif (logoItem.binary && Object.keys(logoItem.binary).length > 0) {\n  const binaryKey = Object.keys(logoItem.binary)[0];\n  try {\n    const buffer = await this.helpers.getBinaryDataBuffer(0, binaryKey);\n    logoBase64 = buffer.toString('base64');\n  } catch (e) {\n    const bd = logoItem.binary[binaryKey];\n    if (bd.data && bd.data !== 'filesystem-v2') logoBase64 = bd.data;\n  }\n}\nif (!logoBase64 || logoBase64 === 'filesystem-v2') throw new Error('Failed to get logo');\n\nconst vs = formInput.visual_style;\nconst pc = formInput.color_primary;\nconst sc = formInput.color_secondary;\nconst ac = formInput.color_accent;\nconst dc = formInput.color_dark;\n\nlet style = '';\nif (vs.toLowerCase().includes('glass')) {\n  style = `GLASSMORPHISM: ${pc} to ${sc} gradient. Frosted glass panels, blur effects, hexagonal shapes, ${ac} connection lines, rim lighting.`;\n} else if (vs.toLowerCase().includes('3d') || vs.toLowerCase().includes('modern')) {\n  style = `MODERN 3D: ${pc} gradient with floating 3D objects (spheres, cubes). Glossy metallic surfaces, dramatic rim lighting, depth of field, particle effects in ${ac}. DEPTH and DIMENSION.`;\n} else if (vs.toLowerCase().includes('iso')) {\n  style = `ISOMETRIC: ${pc} background, isometric 3D architecture, server structures, ${ac} connection lines, technical grid.`;\n} else if (vs.toLowerCase().includes('data')) {\n  style = `DATA HERO: ${pc} background, charts/graphs as hero, data points with ${ac} lines, glowing indicators.`;\n} else {\n  style = `CORPORATE: ${pc} to ${sc} gradient, geometric shapes in ${ac}, professional lighting, subtle 3D depth.`;\n}\n\n// Return ALL slides as separate items\nconst items = formInput.slides.map((slide, i) => ({\n  json: {\n    slide_number: i + 1,\n    total_slides: formInput.total_slides,\n    headline: slide.headline,\n    subtext: slide.subtext || '',\n    style: style,\n    topic: formInput.topic,\n    pc, sc, ac, dc,\n    logo_base64: logoBase64\n  }\n}));\n\nconsole.log('Created', items.length, 'slide items');\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [260, 300],
      "id": "prepare-slides",
      "name": "Prepare Slides"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [480, 300],
      "id": "loop-slides",
      "name": "Loop Slides"
    },
    {
      "parameters": {
        "jsCode": "const s = $input.item.json;\n\nconst prompt = `Create a 4:5 portrait Instagram image.\n\nSTYLE: ${s.style}\n\nSLIDE ${s.slide_number}/${s.total_slides}\nHEADLINE: \"${s.headline}\"\nSUBTEXT: \"${s.subtext}\"\nTOPIC: ${s.topic || 'Technology'}\n\nREQUIREMENTS:\n- Display \"${s.headline}\" as bold text overlay in ${s.ac} color\n- Dark gradient behind text for readability\n- MSI logo (provided image) in BOTTOM RIGHT corner\n- DO NOT modify the logo\n- Professional Instagram quality\n- ALL ${s.total_slides} slides must look like they belong together`;\n\nreturn [{ json: { ...s, image_prompt: prompt } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 200],
      "id": "build-prompt",
      "name": "Build Prompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contents: [{ parts: [{ text: $json.image_prompt }, { inline_data: { mime_type: 'image/png', data: $json.logo_base64 } }] }], generationConfig: { responseModalities: ['IMAGE'], imageConfig: { aspectRatio: '4:5', imageSize: '2K' } } }) }}",
        "options": { "timeout": 120000 }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [920, 200],
      "id": "gemini",
      "name": "Gemini",
      "credentials": { "googlePalmApi": { "id": "oF4jKBK0jRbwEPWt", "name": "Google Gemini(PaLM) Api account" } }
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item;\nconst sd = $('Build Prompt').item.json;\n\nif (item.binary && Object.keys(item.binary).length > 0) {\n  return [{ json: { slide_number: sd.slide_number, total_slides: sd.total_slides, headline: sd.headline, subtext: sd.subtext }, binary: { data: item.binary[Object.keys(item.binary)[0]] } }];\n}\n\nconst candidates = item.json?.candidates || [];\nfor (const c of candidates) {\n  for (const p of (c?.content?.parts || [])) {\n    const d = p.inline_data || p.inlineData;\n    if (d) {\n      return [{ json: { slide_number: sd.slide_number, total_slides: sd.total_slides, headline: sd.headline, subtext: sd.subtext }, binary: { data: { data: d.data, mimeType: d.mime_type || 'image/png', fileName: `slide-${sd.slide_number}.png` } } }];\n    }\n  }\n}\nthrow new Error('No image for slide ' + sd.slide_number);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1140, 200],
      "id": "extract-img",
      "name": "Extract Image"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.imgbb.com/1/upload",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": { "parameters": [{ "name": "key", "value": "d5e3ee3c8c2fa1a29f6d6dc3c2c79447" }, { "parameterType": "formBinaryData", "name": "image", "inputDataFieldName": "data" }] },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1360, 200],
      "id": "upload",
      "name": "Upload ImgBB",
      "credentials": { "httpHeaderAuth": { "id": "zx6X4T7j4yDMYWKo", "name": "imgbb-api" } }
    },
    {
      "parameters": {
        "jsCode": "const sd = $('Extract Image').item.json;\nconst url = $input.item.json.data?.url || $input.item.json.data?.display_url;\nif (!url) throw new Error('No URL for slide ' + sd.slide_number);\nconsole.log('Slide', sd.slide_number, 'done:', url);\nreturn [{ json: { slide_number: sd.slide_number, total_slides: sd.total_slides, headline: sd.headline, subtext: sd.subtext || '', image_url: url } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1580, 200],
      "id": "collect-url",
      "name": "Collect URL"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "slides_data",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [700, 420],
      "id": "aggregate",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "jsCode": "const slides = $input.item.json.slides_data || [];\nconst sorted = slides.sort((a, b) => a.slide_number - b.slide_number);\nconst formatted = sorted.map(s => ({ slide_number: s.slide_number, headline: s.headline, subtext: s.subtext || '', image_url: s.image_url }));\nreturn [{ json: { success: true, message: `Carousel: ${formatted.length} slides`, data: { total_slides: formatted.length, slides: formatted } } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [920, 420],
      "id": "format-resp",
      "name": "Format Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": { "responseHeaders": { "entries": [{ "name": "Access-Control-Allow-Origin", "value": "*" }, { "name": "Access-Control-Allow-Methods", "value": "GET, POST, OPTIONS" }, { "name": "Access-Control-Allow-Headers", "value": "Content-Type" }] } }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1140, 420],
      "id": "respond",
      "name": "Respond"
    }
  ],
  "connections": {
    "Webhook - Carousel Gen": { "main": [[{ "node": "Format Input", "type": "main", "index": 0 }]] },
    "Format Input": { "main": [[{ "node": "Download Logo", "type": "main", "index": 0 }]] },
    "Download Logo": { "main": [[{ "node": "Prepare Slides", "type": "main", "index": 0 }]] },
    "Prepare Slides": { "main": [[{ "node": "Loop Slides", "type": "main", "index": 0 }]] },
    "Loop Slides": { 
      "main": [
        [{ "node": "Build Prompt", "type": "main", "index": 0 }],
        [{ "node": "Aggregate", "type": "main", "index": 0 }]
      ] 
    },
    "Build Prompt": { "main": [[{ "node": "Gemini", "type": "main", "index": 0 }]] },
    "Gemini": { "main": [[{ "node": "Extract Image", "type": "main", "index": 0 }]] },
    "Extract Image": { "main": [[{ "node": "Upload ImgBB", "type": "main", "index": 0 }]] },
    "Upload ImgBB": { "main": [[{ "node": "Collect URL", "type": "main", "index": 0 }]] },
    "Collect URL": { "main": [[{ "node": "Loop Slides", "type": "main", "index": 0 }]] },
    "Aggregate": { "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]] },
    "Format Response": { "main": [[{ "node": "Respond", "type": "main", "index": 0 }]] }
  },
  "pinData": {},
  "meta": { "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e" }
}
