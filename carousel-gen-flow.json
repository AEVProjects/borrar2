{
  "name": "MSI Carousel Generator v3",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "msi-carousel-gen",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-400, 300],
      "id": "webhook-carousel-gen",
      "name": "Webhook - Carousel Gen",
      "webhookId": "msi-carousel-gen"
    },
    {
      "parameters": {
        "jsCode": "// Extract carousel data from web form\nconst input = $input.item.json;\n\nconsole.log('==== CAROUSEL WEBHOOK INPUT ====');\n\nlet data;\nif (input.body) {\n  if (typeof input.body === 'string') {\n    try {\n      data = JSON.parse(input.body);\n    } catch (e) {\n      data = input;\n    }\n  } else if (typeof input.body === 'object') {\n    data = input.body;\n  } else {\n    data = input;\n  }\n} else if (input.query) {\n  data = input.query;\n} else {\n  data = input;\n}\n\nconst slides = data.slides || [];\nconst visual_style = data.visual_style || 'Modern 3D';\nconst topic = data.topic || '';\nconst context = data.context || '';\n\nconst color_primary = data.color_palette?.primary || data.color_primary || '#207CE5';\nconst color_secondary = data.color_palette?.secondary || data.color_secondary || '#004AAD';\nconst color_accent = data.color_palette?.accent || data.color_accent || '#FFFDF1';\nconst color_dark = data.color_palette?.dark || data.color_dark || '#2B2B2B';\n\nconsole.log('Slides:', slides.length);\nconsole.log('Visual style:', visual_style);\n\nif (!slides || slides.length === 0) {\n  throw new Error('CAROUSEL ERROR: At least one slide is required.');\n}\n\nif (slides.length > 10) {\n  throw new Error('CAROUSEL ERROR: Maximum 10 slides allowed.');\n}\n\nreturn [{\n  json: {\n    slides,\n    visual_style,\n    topic,\n    context,\n    color_primary,\n    color_secondary,\n    color_accent,\n    color_dark,\n    total_slides: slides.length\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-180, 300],
      "id": "format-carousel-input",
      "name": "Format Carousel Input"
    },
    {
      "parameters": {
        "url": "https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [40, 300],
      "id": "download-msi-logo",
      "name": "Download MSI Logo"
    },
    {
      "parameters": {
        "jsCode": "// Extract logo and create ONE ITEM PER SLIDE\nconst formInput = $('Format Carousel Input').item.json;\nconst logoItem = $input.item;\n\nconsole.log('==== PREPARE SLIDES ====');\n\n// Get logo base64\nlet logoBase64 = '';\nif (logoItem.binary && Object.keys(logoItem.binary).length > 0) {\n  const binaryKey = Object.keys(logoItem.binary)[0];\n  try {\n    const buffer = await this.helpers.getBinaryDataBuffer(0, binaryKey);\n    logoBase64 = buffer.toString('base64');\n    console.log('Logo base64 length:', logoBase64.length);\n  } catch (e) {\n    const binaryData = logoItem.binary[binaryKey];\n    if (binaryData.data && binaryData.data !== 'filesystem-v2') {\n      logoBase64 = binaryData.data;\n    }\n  }\n}\n\nif (!logoBase64 || logoBase64 === 'filesystem-v2') {\n  throw new Error('Failed to extract logo base64');\n}\n\n// DETAILED STYLE INSTRUCTIONS\nconst vs = formInput.visual_style;\nconst pc = formInput.color_primary;\nconst sc = formInput.color_secondary;\nconst ac = formInput.color_accent;\nconst dc = formInput.color_dark;\n\nlet styleInstructions = '';\n\nif (vs === 'Glassmorphism' || vs === 'glassmorphism') {\n  styleInstructions = `## GLASSMORPHISM STYLE\\n**SCENE:** Brand color (${pc}) to secondary (${sc}) gradient background. THREE frosted glass panels with technology icons visible through translucent layers. Semi-transparent hexagonal shapes. Subtle blur effects on glass edges. Connection lines in (${ac}).\\n\\n**VISUAL ELEMENTS:**\\n1. Three frosted glass panels with blur effect\\n2. Technology icons in white (gears, circuits, data symbols)\\n3. Semi-transparent hexagonal shapes (${ac} accents)\\n4. Connection lines between elements\\n5. Subtle glow effects on panel edges\\n6. Professional rim lighting for depth`;\n} else if (vs === 'Modern 3D' || vs === 'modern3d' || vs === 'Modern3D') {\n  styleInstructions = `## MODERN 3D STYLE\\n**SCENE:** Brand color (${pc}) gradient background with floating 3D geometric objects. Glossy spheres, cubes, and abstract tech shapes with realistic reflections and shadows. Dramatic lighting from multiple angles. Futuristic corporate aesthetic.\\n\\n**VISUAL ELEMENTS:**\\n1. Floating 3D geometric shapes (spheres, cubes, cylinders) in ${pc} and ${sc}\\n2. Glossy metallic surfaces with reflections\\n3. Dramatic rim lighting and shadows\\n4. Abstract tech objects (servers, nodes, connections)\\n5. Depth of field blur on background\\n6. Subtle particle effects or light rays in ${ac}\\n7. Professional corporate tech aesthetic with DEPTH and DIMENSION`;\n} else if (vs === 'Isometric' || vs === 'isometric') {\n  styleInstructions = `## ISOMETRIC ARCHITECTURE STYLE\\n**SCENE:** Brand color (${pc}) background with isometric 3D architecture. Clean geometric buildings, server rooms in isometric perspective. Flat colors with subtle gradients. Technical illustration style.\\n\\n**VISUAL ELEMENTS:**\\n1. Isometric buildings or server structures in ${pc} and ${sc}\\n2. Clean geometric shapes in isometric view\\n3. Network connection lines (${ac})\\n4. Subtle shadows for depth\\n5. Technical grid elements`;\n} else if (vs === 'Data Hero' || vs === 'datahero' || vs === 'DataHero') {\n  styleInstructions = `## DATA HERO STYLE\\n**SCENE:** Brand color (${pc}) background with prominent data visualizations. Charts, graphs, dashboards as main visual. Modern infographic aesthetic.\\n\\n**VISUAL ELEMENTS:**\\n1. Large chart or graph as hero element in brand colors\\n2. Data points with connection lines (${ac})\\n3. Glowing data indicators in ${pc}\\n4. Abstract data flow visualization\\n5. Clean grid or axis lines in ${sc}`;\n} else {\n  styleInstructions = `## PROFESSIONAL CORPORATE STYLE\\n**SCENE:** Clean brand color (${pc}) gradient to (${sc}). Professional design with abstract geometric elements. Modern, minimal aesthetic.\\n\\n**VISUAL ELEMENTS:**\\n1. Gradient background from ${pc} to ${sc}\\n2. Abstract geometric shapes in ${ac}\\n3. Technology icons in white or ${ac}\\n4. Professional lighting with depth\\n5. Subtle shadows and 3D perception`;\n}\n\n// Return ONE ITEM PER SLIDE - n8n will process each in parallel\nconst slideItems = formInput.slides.map((slide, index) => ({\n  json: {\n    slide_number: index + 1,\n    total_slides: formInput.total_slides,\n    headline: slide.headline,\n    subtext: slide.subtext || '',\n    visual_style: formInput.visual_style,\n    style_instructions: styleInstructions,\n    topic: formInput.topic,\n    color_primary: pc,\n    color_secondary: sc,\n    color_accent: ac,\n    color_dark: dc,\n    logo_base64: logoBase64\n  }\n}));\n\nconsole.log('Returning', slideItems.length, 'items for parallel processing');\nreturn slideItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [260, 300],
      "id": "prepare-slides",
      "name": "Prepare All Slides"
    },
    {
      "parameters": {
        "jsCode": "// Build image prompt for THIS slide\nconst slide = $input.item.json;\n\nconsole.log('Building prompt for slide', slide.slide_number);\n\nconst imagePrompt = `Generate a professional 4:5 portrait image for Instagram carousel slide ${slide.slide_number} of ${slide.total_slides}.\n\n${slide.style_instructions}\n\n## THIS SLIDE CONTENT\n**Headline:** \"${slide.headline}\"\n**Subtext:** \"${slide.subtext || ''}\"\n**Topic:** ${slide.topic || 'Technology'}\n\n## REQUIREMENTS\n1. Display headline \"${slide.headline}\" prominently as text overlay\n2. Bold sans-serif typography in ${slide.color_accent} color\n3. Text in lower third with dark gradient behind for readability\n4. MSI Technologies logo (provided) in BOTTOM RIGHT corner, small but visible\n5. DO NOT modify the logo - use it EXACTLY as provided\n\n## CAROUSEL CONSISTENCY\n- ALL ${slide.total_slides} slides must have IDENTICAL background style\n- Same lighting direction and intensity across all slides\n- Same color ratios and placement\n- Only TEXT and small icons change between slides\n\n## FORMAT\n4:5 portrait (1080x1350), professional Instagram quality`;\n\nreturn [{\n  json: {\n    slide_number: slide.slide_number,\n    total_slides: slide.total_slides,\n    headline: slide.headline,\n    subtext: slide.subtext,\n    image_prompt: imagePrompt,\n    logo_base64: slide.logo_base64\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 300],
      "id": "build-prompt",
      "name": "Build Image Prompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  contents: [{\n    parts: [\n      { text: $json.image_prompt },\n      { inline_data: { mime_type: 'image/png', data: $json.logo_base64 } }\n    ]\n  }],\n  generationConfig: {\n    responseModalities: ['IMAGE'],\n    imageConfig: {\n      aspectRatio: '4:5',\n      imageSize: '2K'\n    }\n  }\n}) }}",
        "options": {
          "response": {
            "response": {}
          },
          "timeout": 120000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [700, 300],
      "id": "gemini-generate",
      "name": "Gemini Generate",
      "credentials": {
        "googlePalmApi": {
          "id": "oF4jKBK0jRbwEPWt",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract image from Gemini response\nconst item = $input.item;\nconst slideData = $('Build Image Prompt').item.json;\n\nconsole.log('Extracting image for slide', slideData.slide_number);\n\n// Check binary first\nif (item.binary && Object.keys(item.binary).length > 0) {\n  const binaryKey = Object.keys(item.binary)[0];\n  return [{\n    json: {\n      slide_number: slideData.slide_number,\n      total_slides: slideData.total_slides,\n      headline: slideData.headline,\n      subtext: slideData.subtext\n    },\n    binary: { data: item.binary[binaryKey] }\n  }];\n}\n\n// Check inline_data in response\nconst candidates = item.json?.candidates || [];\nfor (const candidate of candidates) {\n  const parts = candidate?.content?.parts || [];\n  for (const part of parts) {\n    const inlineData = part.inline_data || part.inlineData;\n    if (inlineData) {\n      console.log('Found image for slide', slideData.slide_number);\n      return [{\n        json: {\n          slide_number: slideData.slide_number,\n          total_slides: slideData.total_slides,\n          headline: slideData.headline,\n          subtext: slideData.subtext\n        },\n        binary: {\n          data: {\n            data: inlineData.data,\n            mimeType: inlineData.mime_type || inlineData.mimeType || 'image/png',\n            fileName: `slide-${slideData.slide_number}.png`\n          }\n        }\n      }];\n    }\n  }\n}\n\nthrow new Error('No image returned for slide ' + slideData.slide_number);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [920, 300],
      "id": "extract-image",
      "name": "Extract Image"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.imgbb.com/1/upload",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "d5e3ee3c8c2fa1a29f6d6dc3c2c79447"
            },
            {
              "parameterType": "formBinaryData",
              "name": "image",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1140, 300],
      "id": "upload-imgbb",
      "name": "Upload to ImgBB",
      "credentials": {
        "httpHeaderAuth": {
          "id": "zx6X4T7j4yDMYWKo",
          "name": "imgbb-api"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Collect URL for this slide\nconst slideData = $('Extract Image').item.json;\nconst uploadResponse = $input.item.json;\n\nconst imageUrl = uploadResponse.data?.url || uploadResponse.data?.display_url;\nconsole.log('Slide', slideData.slide_number, 'uploaded:', imageUrl);\n\nif (!imageUrl) {\n  throw new Error('No URL for slide ' + slideData.slide_number);\n}\n\nreturn [{\n  json: {\n    slide_number: slideData.slide_number,\n    total_slides: slideData.total_slides,\n    headline: slideData.headline,\n    subtext: slideData.subtext || '',\n    image_url: imageUrl\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1360, 300],
      "id": "collect-url",
      "name": "Collect URL"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "slides_data",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [1580, 300],
      "id": "aggregate-all",
      "name": "Aggregate All Slides"
    },
    {
      "parameters": {
        "jsCode": "// Format final response\nconst slides = $input.item.json.slides_data;\n\nconsole.log('Aggregated', slides.length, 'slides');\n\nconst sorted = slides.sort((a, b) => a.slide_number - b.slide_number);\n\nconst formatted = sorted.map(s => ({\n  slide_number: s.slide_number,\n  headline: s.headline,\n  subtext: s.subtext || '',\n  image_url: s.image_url\n}));\n\nreturn [{\n  json: {\n    success: true,\n    message: `Carousel generated with ${formatted.length} slides`,\n    data: {\n      total_slides: formatted.length,\n      slides: formatted\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 300],
      "id": "format-response",
      "name": "Format Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2020, 300],
      "id": "respond-success",
      "name": "Respond Success"
    }
  ],
  "connections": {
    "Webhook - Carousel Gen": {
      "main": [[{ "node": "Format Carousel Input", "type": "main", "index": 0 }]]
    },
    "Format Carousel Input": {
      "main": [[{ "node": "Download MSI Logo", "type": "main", "index": 0 }]]
    },
    "Download MSI Logo": {
      "main": [[{ "node": "Prepare All Slides", "type": "main", "index": 0 }]]
    },
    "Prepare All Slides": {
      "main": [[{ "node": "Build Image Prompt", "type": "main", "index": 0 }]]
    },
    "Build Image Prompt": {
      "main": [[{ "node": "Gemini Generate", "type": "main", "index": 0 }]]
    },
    "Gemini Generate": {
      "main": [[{ "node": "Extract Image", "type": "main", "index": 0 }]]
    },
    "Extract Image": {
      "main": [[{ "node": "Upload to ImgBB", "type": "main", "index": 0 }]]
    },
    "Upload to ImgBB": {
      "main": [[{ "node": "Collect URL", "type": "main", "index": 0 }]]
    },
    "Collect URL": {
      "main": [[{ "node": "Aggregate All Slides", "type": "main", "index": 0 }]]
    },
    "Aggregate All Slides": {
      "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
    },
    "Format Response": {
      "main": [[{ "node": "Respond Success", "type": "main", "index": 0 }]]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e"
  }
}
