{
  "name": "MSI Carousel Generator v7",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "msi-carousel-gen",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [260, 300],
      "id": "webhook",
      "name": "Webhook",
      "webhookId": "msi-carousel-gen"
    },
    {
      "parameters": {
        "url": "https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png",
        "options": { "response": { "response": { "responseFormat": "file" } } }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [480, 300],
      "id": "download-logo",
      "name": "Download Logo"
    },
    {
      "parameters": {
        "jsCode": "// Parse input and get logo\nconst webhookData = $('Webhook').item.json;\nconst logoItem = $input.item;\n\n// Get logo base64\nlet logoBase64 = '';\nif (logoItem.binary) {\n  const binaryKey = Object.keys(logoItem.binary)[0];\n  try {\n    const buffer = await this.helpers.getBinaryDataBuffer(0, binaryKey);\n    logoBase64 = buffer.toString('base64');\n  } catch (e) {\n    const bd = logoItem.binary[binaryKey];\n    if (bd.data && bd.data !== 'filesystem-v2') logoBase64 = bd.data;\n  }\n}\nif (!logoBase64) throw new Error('Failed to get logo');\n\n// Parse webhook body\nlet data = webhookData;\nif (webhookData.body) {\n  if (typeof webhookData.body === 'string') {\n    try { data = JSON.parse(webhookData.body); } catch(e) { data = webhookData; }\n  } else {\n    data = webhookData.body;\n  }\n}\n\nconst slides = data.slides || [];\nif (slides.length === 0) throw new Error('No slides provided');\n\n// MSI Brand Colors - MANDATORY for visual consistency\nconst brandColors = {\n  primary: data.color_primary || '#207CE5',\n  secondary: data.color_secondary || '#004AAD',\n  accent: data.color_accent || '#FFFDF1',\n  dark: data.color_dark || '#2B2B2B'\n};\n\n// Visual consistency parameters\nconst visualConsistency = {\n  font_headline: data.font_headline || 'ITC Avant Garde Bold',\n  font_subtext: data.font_subtext || 'Poppins SemiBold',\n  font_body: data.font_body || 'Quicksand Medium',\n  font_size_headline: data.font_size_headline || '48-56pt',\n  font_size_subtext: data.font_size_subtext || '24-32pt',\n  logo_position: data.logo_position || 'bottom-right',\n  background_style: data.background_style || 'solid_primary'\n};\n\nreturn [{\n  json: {\n    slides: slides,\n    total: slides.length,\n    visual_style: data.visual_style || 'Modern 3D',\n    topic: data.topic || 'Technology',\n    context: data.context || '',\n    color_primary: brandColors.primary,\n    color_secondary: brandColors.secondary,\n    color_accent: brandColors.accent,\n    color_dark: brandColors.dark,\n    brand_colors: brandColors,\n    visual_consistency: visualConsistency,\n    logo_base64: logoBase64\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 300],
      "id": "parse-input",
      "name": "Parse Input"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Create an Instagram carousel strategy for:\n\nTopic: {{ $json.topic }}\nNumber of Slides: {{ $json.total }}\nVisual Style: {{ $json.visual_style }}\nContext: {{ $json.context || 'None provided' }}\n\nSlide Headlines:\n{{ $json.slides.map((s, i) => `Slide ${i+1}: ${s.headline}`).join('\\n') }}\n\nNote: All images will be in 4:5 portrait format for Instagram.",
        "options": {
          "systemMessage": "# LANGUAGE REQUIREMENT\nALWAYS respond in English regardless of input language.\n\n# ROLE: Strategic Content Analyst for MSI Technologies - INSTAGRAM CAROUSEL SPECIALIST\n\n## OUTPUT FORMAT\n---CAROUSEL STRATEGY---\nTheme: [Overarching narrative that connects all slides]\nHook (Slide 1): [Why people stop scrolling - the attention grabber]\nFlow: [How each slide leads to the next]\nCTA (Final Slide): [Clear call to action]\nHashtags: [5-7 hashtags including #MSITechnologies]\n\n---VISUAL CONSISTENCY NOTES---\nUser's Visual Style: [Copy exactly from user input]\nUnifying Elements: [What visual elements MUST stay consistent across ALL slides]\nColor Strategy: [How to use the brand colors across slides]\nFormat: 4:5 Portrait Instagram Carousel\n\n---SLIDE BREAKDOWN---\n[For each slide: purpose, emotional beat, key visual focus]\n\n## MSI CONTEXT\nMSI Technologies helps businesses modernize infrastructure and implement innovative technology solutions.\n\n## CAROUSEL-SPECIFIC RULES\n1. Each slide must COMPEL the user to swipe to the next\n2. First slide = pattern interrupt, must stop the scroll\n3. Last slide = clear CTA with value proposition\n4. Middle slides = build value and maintain interest\n5. Visual style MUST be identical across all slides\n6. Brand blue #207CE5 backgrounds MANDATORY for consistency"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [920, 300],
      "id": "agent-strategy",
      "name": "Agent 1: Carousel Strategy"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [1000, 520],
      "id": "openai-strategy",
      "name": "OpenAI for Strategy",
      "credentials": {
        "openAiApi": {
          "id": "13Oqly3WdRAzZVXL",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Agent 1: Carousel Strategy').item.json.output }}\n\n---SLIDES TO WRITE COPY FOR---\n{{ $('Parse Input').item.json.slides.map((s, i) => `Slide ${i+1}: ${s.headline}`).join('\\n') }}",
        "options": {
          "systemMessage": "# LANGUAGE REQUIREMENT\nALWAYS respond in English.\n\n# ROLE: Instagram Carousel Copy Writer for MSI Technologies\n\nWrite compelling copy for EACH slide of the carousel.\n\n## OUTPUT FORMAT\nFor each slide, output:\n\n**SLIDE [N]: [Headline]**\nCaption: [2-3 sentences max, punchy and direct]\nSubtext: [Optional supporting line for the image]\n\n## CAROUSEL COPY RULES\n- Slide 1: Hook - must stop the scroll (question, bold statement, or surprising fact)\n- Middle slides: Build value, each one a mini-story\n- Final slide: Clear CTA - what should they do next?\n\n## VOICE\n- Senior tech professional sharing insights\n- Confident but not arrogant\n- Direct and actionable\n\n## NEVER USE\n- \"In today's digital landscape\"\n- \"Revolutionize/Transform your business\"\n- \"Cutting-edge/Game-changing\"\n- Excessive emojis (max 1-2 per slide)\n\n## REQUIREMENTS\n- Keep each caption under 30 words\n- Make each slide independently valuable\n- BUT connected to the overall narrative\n- Natural flow between slides\n\n## FOR FINAL SLIDE ONLY\nInclude contact info:\nðŸ“© contact@msitechnologiesinc.com\nðŸŒ msitechnologiesinc.com"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [1140, 300],
      "id": "agent-copywriter",
      "name": "Agent 2: Carousel Copy Writer"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [1220, 520],
      "id": "openai-copywriter",
      "name": "OpenAI for Copy Writer",
      "credentials": {
        "openAiApi": {
          "id": "13Oqly3WdRAzZVXL",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge agent outputs with original data (WITHOUT logo to save memory)\nconst parseInput = $('Parse Input').item.json;\nconst strategy = $('Agent 1: Carousel Strategy').item.json.output;\nconst copy = $('Agent 2: Carousel Copy Writer').item.json.output;\n\n// Don't pass logo_base64 through agents - it's too heavy\nconst { logo_base64, ...dataWithoutLogo } = parseInput;\n\nreturn [{\n  json: {\n    ...dataWithoutLogo,\n    strategy: strategy,\n    carousel_copy: copy\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1360, 300],
      "id": "merge-agent-outputs",
      "name": "Merge Agent Outputs"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": { "caseSensitive": false, "typeValidation": "loose" },
                "conditions": [{ "leftValue": "={{ $json.visual_style }}", "rightValue": "Glassmorphism", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Glassmorphism"
            },
            {
              "conditions": {
                "options": { "caseSensitive": false, "typeValidation": "loose" },
                "conditions": [{ "leftValue": "={{ $json.visual_style }}", "rightValue": "Modern 3D", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Modern3D"
            },
            {
              "conditions": {
                "options": { "caseSensitive": false, "typeValidation": "loose" },
                "conditions": [{ "leftValue": "={{ $json.visual_style }}", "rightValue": "Isometric", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Isometric"
            },
            {
              "conditions": {
                "options": { "caseSensitive": false, "typeValidation": "loose" },
                "conditions": [{ "leftValue": "={{ $json.visual_style }}", "rightValue": "Data Hero", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DataHero"
            },
            {
              "conditions": {
                "options": { "caseSensitive": false, "typeValidation": "loose" },
                "conditions": [{ "leftValue": "={{ $json.visual_style }}", "rightValue": "Realistic", "operator": { "type": "string", "operation": "contains" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Realistic"
            }
          ]
        },
        "options": { "fallbackOutput": "extra" }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [1580, 300],
      "id": "route-style",
      "name": "Route by Visual Style"
    },
    {
      "parameters": {
        "jsCode": "// GLASSMORPHISM Style Instructions\nconst input = $input.item.json;\nconst pc = input.color_primary;\nconst sc = input.color_secondary;\nconst ac = input.color_accent;\nconst dc = input.color_dark;\n\nconst styleInstructions = `## GLASSMORPHISM STYLE\n**SCENE:** Brand color (${pc}) to secondary color (${sc}) gradient background. THREE frosted glass panels arranged in layered composition with technology icons visible through translucent layers. Semi-transparent hexagonal shapes scattered. Subtle blur effects on glass edges. Connection lines in accent color (${ac}).\n\n**COLOR PALETTE:**\n- Primary: ${pc}\n- Secondary: ${sc}\n- Accent/Text: ${ac}\n- Dark: ${dc}\n\n**VISUAL ELEMENTS:**\n1. Three frosted glass panels with blur effect\n2. Technology icons in white on panels (gears, circuits, data symbols)\n3. Semi-transparent hexagonal shapes (${ac} accents)\n4. Connection lines between elements (${ac})\n5. Subtle glow effects on panel edges\n6. Professional rim lighting for depth`;\n\nreturn [{ json: { ...input, style_instructions: styleInstructions } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 100],
      "id": "style-glass",
      "name": "Style: Glassmorphism"
    },
    {
      "parameters": {
        "jsCode": "// MODERN 3D Style Instructions\nconst input = $input.item.json;\nconst pc = input.color_primary;\nconst sc = input.color_secondary;\nconst ac = input.color_accent;\nconst dc = input.color_dark;\n\nconst styleInstructions = `## MODERN 3D STYLE\n**SCENE:** Brand color (${pc}) gradient background with floating 3D geometric objects. Glossy spheres, cubes, and abstract tech shapes with realistic reflections and shadows. Dramatic lighting from multiple angles creating depth. Professional, futuristic corporate aesthetic.\n\n**COLOR PALETTE:**\n- Primary: ${pc}\n- Secondary: ${sc}\n- Accent/Text: ${ac}\n- Dark: ${dc}\n\n**VISUAL ELEMENTS:**\n1. Floating 3D geometric shapes (spheres, cubes, cylinders)\n2. Glossy metallic surfaces with reflections\n3. Dramatic rim lighting and shadows\n4. Abstract tech objects (servers, nodes, connections)\n5. Depth of field blur on background elements\n6. Subtle particle effects or light rays`;\n\nreturn [{ json: { ...input, style_instructions: styleInstructions } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 220],
      "id": "style-modern3d",
      "name": "Style: Modern 3D"
    },
    {
      "parameters": {
        "jsCode": "// ISOMETRIC Style Instructions\nconst input = $input.item.json;\nconst pc = input.color_primary;\nconst sc = input.color_secondary;\nconst ac = input.color_accent;\nconst dc = input.color_dark;\n\nconst styleInstructions = `## ISOMETRIC ARCHITECTURE STYLE\n**SCENE:** Brand color (${pc}) background with isometric 3D architecture. Clean geometric buildings, server rooms, or tech infrastructure in isometric perspective. Flat colors with subtle gradients. Professional technical illustration style.\n\n**COLOR PALETTE:**\n- Primary: ${pc}\n- Secondary: ${sc}\n- Accent/Text: ${ac}\n- Dark: ${dc}\n\n**VISUAL ELEMENTS:**\n1. Isometric buildings or server structures\n2. Clean geometric shapes in isometric view\n3. Network connection lines between structures (${ac})\n4. Small human figures for scale (optional)\n5. Subtle shadows for depth\n6. Technical grid or blueprint elements`;\n\nreturn [{ json: { ...input, style_instructions: styleInstructions } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 340],
      "id": "style-iso",
      "name": "Style: Isometric"
    },
    {
      "parameters": {
        "jsCode": "// DATA HERO Style Instructions\nconst input = $input.item.json;\nconst pc = input.color_primary;\nconst sc = input.color_secondary;\nconst ac = input.color_accent;\nconst dc = input.color_dark;\n\nconst styleInstructions = `## DATA HERO / VISUALIZATION STYLE\n**SCENE:** Brand color (${pc}) background with prominent data visualizations as hero element. Charts, graphs, dashboards, or data flow diagrams as main visual. Clean, modern infographic aesthetic with professional corporate feel.\n\n**COLOR PALETTE:**\n- Primary: ${pc}\n- Secondary: ${sc}\n- Accent/Text: ${ac}\n- Dark: ${dc}\n\n**VISUAL ELEMENTS:**\n1. Large chart or graph as hero element (bar, line, pie, or dashboard)\n2. Data points and nodes with connection lines (${ac})\n3. Glowing data indicators and metrics\n4. Abstract data flow visualization\n5. Clean grid or axis lines\n6. Subtle animated feel (arrows, flow indicators)`;\n\nreturn [{ json: { ...input, style_instructions: styleInstructions } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 460],
      "id": "style-data",
      "name": "Style: Data Hero"
    },
    {
      "parameters": {
        "jsCode": "// REALISTIC PHOTOGRAPHY Style Instructions (NO GRADIENT)\nconst input = $input.item.json;\nconst pc = input.color_primary;\nconst sc = input.color_secondary;\nconst ac = input.color_accent;\nconst dc = input.color_dark;\n\nconst styleInstructions = `## PHOTOREALISTIC STOCK PHOTOGRAPHY\nGenerate a professional stock photograph that looks EXACTLY like it was shot by a commercial photographer for Getty Images or Shutterstock. This must be indistinguishable from real photography.\n\n**COLOR PALETTE TO USE:**\n- Primary Brand Color: ${pc}\n- Secondary Color: ${sc}\n- Accent/Text Color: ${ac}\n- Dark Color: ${dc}\n\n### ABSOLUTE PROHIBITIONS FOR THIS STYLE\n- NO glowing effects of ANY kind\n- NO luminous or light-emitting elements\n- NO light rays, god rays, or beam effects\n- NO surreal or fantasy elements whatsoever\n- NO floating objects (everything must obey gravity)\n- NO neon colors or oversaturated hues\n- NO dreamy, ethereal, or mystical atmosphere\n- NO abstract distortions or warping\n- NO lens flares or bloom effects\n- NO magical elements or impossible physics\n- NO futuristic holograms or sci-fi elements\n- NO glowing screens or monitors (realistic brightness only)\n- NO supernatural lighting\n- EVERYTHING must look like it could exist in a real photograph\n\n### SUBJECT & APPEARANCE\n- 1-2 professional people, age 30-42, tech industry professionals\n- Expression: genuine micro-expressions - slight asymmetry in smile, natural eye crinkles, relaxed brow\n- Skin: visible pores, natural texture variations, subtle imperfections\n- Hair: individual strands visible, natural flyaways, realistic shine patterns\n- Professional clothing: oxford shirts, quality sweaters, blazers\n\n### ENVIRONMENT\n- Background: shallow depth of field (f/1.8-2.8 bokeh)\n- Setting: modern office with glass partitions (blurred), neutral wall, bright workspace\n- Props if visible: realistic laptop, quality notebook, coffee cup\n\n### LIGHTING\n- Primary: soft natural window light from camera-left (45-degree angle)\n- Shadows: soft gradual transitions, visible but not harsh\n- Color temperature: slightly warm (5500-6000K)\n\n### CAMERA SPECS\n- 85mm f/1.4 portrait lens simulation\n- Shallow depth of field, subtle film grain\n- Natural, slightly desaturated colors`;\n\nreturn [{ json: { ...input, style_instructions: styleInstructions } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 580],
      "id": "style-realistic",
      "name": "Style: Realistic"
    },
    {
      "parameters": {
        "jsCode": "// DEFAULT CORPORATE Style Instructions\nconst input = $input.item.json;\nconst pc = input.color_primary;\nconst sc = input.color_secondary;\nconst ac = input.color_accent;\nconst dc = input.color_dark;\n\nconst styleInstructions = `## DEFAULT CORPORATE STYLE\n**SCENE:** Clean brand color (${pc}) gradient background. Professional corporate design with abstract geometric elements. Modern, minimal aesthetic suitable for social media.\n\n**COLOR PALETTE:**\n- Primary: ${pc}\n- Secondary: ${sc}\n- Accent/Text: ${ac}\n- Dark: ${dc}\n\n**VISUAL ELEMENTS:**\n1. Solid brand color background or subtle gradient to secondary\n2. Abstract geometric shapes (hexagons, circles, lines) in accent color\n3. Technology icons relevant to the topic\n4. Clean accent lines or borders (${ac})\n5. Professional lighting effects\n6. Subtle depth through shadows or glows`;\n\nreturn [{ json: { ...input, style_instructions: styleInstructions } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 700],
      "id": "style-default",
      "name": "Style: Default"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=CAROUSEL STRATEGY:\n{{ $json.strategy }}\n\nCARROUSEL COPY:\n{{ $json.carousel_copy }}\n\nVISUAL STYLE: {{ $json.visual_style }}\nNUMBER OF SLIDES: {{ $json.total }}\n\nCOLOR PALETTE TO USE:\n- Primary Color: {{ $json.color_primary }}\n- Secondary Color: {{ $json.color_secondary }}\n- Accent/Text Color: {{ $json.color_accent }}\n- Dark Color: {{ $json.color_dark }}\n\nSTYLE INSTRUCTIONS:\n{{ $json.style_instructions }}\n\nSLIDES TO CREATE:\n{{ $json.slides.map((s, i) => `Slide ${i+1}: ${s.headline}`).join('\\n') }}",
        "options": {
          "systemMessage": "# ROLE: Image Prompt Engineer for MSI Technologies - CAROUSEL SPECIALIST\n\nCreate Gemini 3 Pro image generation prompts for EACH SLIDE of the carousel using the STYLE INSTRUCTIONS and COLOR PALETTE provided.\n\n## CRITICAL VISUAL CONSISTENCY RULES (MANDATORY)\n1. ALL slides MUST have IDENTICAL visual style - same backgrounds, same effects, same color treatment\n2. EXACT SAME background color (MSI Blue #207CE5) on ALL slides - NO variations\n3. EXACT SAME font styles: ITC Avant Garde Bold for headlines, Poppins SemiBold for subtext\n4. EXACT SAME font sizes: Headlines 48-56pt, Subtext 24-32pt\n5. Logo position ALWAYS bottom-right, same size across all slides\n6. Only the HEADLINE text changes between slides\n7. Visual elements should create a cohesive series when viewed together\n\n## CRITICAL PROHIBITIONS (NEVER INCLUDE)\n- NO glowing effects, NO luminous elements, NO light rays\n- NO surreal or fantasy elements\n- NO floating objects defying gravity (unless style specifically calls for it)\n- NO neon colors or oversaturated hues\n- NEVER modify, alter, distort, or recreate the MSI logo - use it EXACTLY as provided\n- NO emojis in any text\n\n## TEXT RENDERING\n- **Headline**: Text in Accent color (#FFFDF1) from palette, ITC Avant Garde Bold, 48-56pt\n- **Subtext**: Poppins SemiBold, 24-32pt\n- Clean, elegant typography\n- IMPORTANT: Do NOT use hyphens or dashes in the text\n\n## LOGO PLACEMENT\n- MSI Technologies logo: Use EXACTLY as provided - NO modifications\n- Place logo in BOTTOM RIGHT corner, consistent across ALL slides\n- Keep branding subtle but visible\n\n## OUTPUT FORMAT\nFor EACH slide, output:\n\n**SLIDE [N] PROMPT:**\n[Complete Gemini prompt for that slide, including all visual instructions and the specific headline for that slide]\n\n---\n\n**VISUAL CONSISTENCY CHECKLIST:**\n- Background: SOLID #207CE5 (MSI Blue)\n- Font: ITC Avant Garde Bold for headlines\n- Size: 48-56pt headlines\n- Logo: Bottom-right, unchanged\n- Style: [Exact same visual treatment]\n\n## REMEMBER\nThe carousel must look like a professional series - when users swipe through, each slide should feel like part of the same story with IDENTICAL visual DNA."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [2020, 300],
      "id": "agent-image-prompt",
      "name": "Agent 3: Image Prompts"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [2100, 520],
      "id": "openai-image-prompt",
      "name": "OpenAI for Image Prompts",
      "credentials": {
        "openAiApi": {
          "id": "13Oqly3WdRAzZVXL",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Generate SLIDE 1 Prompt from Agent output\n// Get original data from Merge Agent Outputs (slides data) and Parse Input (logo)\nconst mergeData = $('Merge Agent Outputs').item.json;\nconst parseInput = $('Parse Input').item.json;\nconst agentOutput = $input.item.json.output || '';\n\nconst slides = mergeData.slides;\nconst slide = slides[0];\nconst ac = mergeData.color_accent;\nconst dc = mergeData.color_dark;\nconst styleInstructions = mergeData.style_instructions || $input.item.json.style_instructions || '';\nconst topic = mergeData.topic;\nconst total = mergeData.total;\n// Get logo directly from Parse Input to avoid passing it through agents\nconst logo = parseInput.logo_base64;\n\n// Extract slide 1 prompt from agent output or create default\nlet slidePrompt = '';\nconst slide1Match = agentOutput.match(/\\*\\*SLIDE 1 PROMPT:\\*\\*([\\s\\S]*?)(?=\\*\\*SLIDE 2|---\\*\\*VISUAL|$)/i);\nif (slide1Match) {\n  slidePrompt = slide1Match[1].trim();\n} else {\n  // Fallback prompt\n  slidePrompt = `Create a 4:5 portrait Instagram carousel image.\n\n${styleInstructions}\n\nHEADLINE: \"${slide.headline}\"\nTOPIC: ${topic}\n\nCRITICAL REQUIREMENTS:\n1. HEADLINE TEXT: Bold, clear \"${slide.headline}\" text in ${ac} color\n2. TEXT AREA: Place text in a readable area with good contrast\n3. MSI LOGO: Place the provided logo in BOTTOM RIGHT corner - DO NOT modify\n4. QUALITY: Professional Instagram-ready, high resolution\n5. This is slide 1 of ${total} - establish the visual style for the series`;\n}\n\nreturn [{ json: { \n  slide_num: 1, \n  headline: slide.headline, \n  subtext: slide.subtext || '', \n  prompt: slidePrompt, \n  logo: logo, \n  remaining_slides: slides.slice(1), \n  total: total, \n  style_instructions: styleInstructions, \n  topic: topic, \n  color_accent: ac, \n  color_dark: dc, \n  agent_output: agentOutput,\n  results: [] \n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2240, 300],
      "id": "slide1-prompt",
      "name": "Slide 1 Prompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contents: [{ parts: [{ text: $json.prompt }, { inline_data: { mime_type: 'image/png', data: $json.logo } }] }], generationConfig: { responseModalities: ['IMAGE'], imageConfig: { aspectRatio: '4:5', imageSize: '2K' } } }) }}",
        "options": { "timeout": 120000 }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2460, 300],
      "id": "gemini1",
      "name": "Gemini 1",
      "credentials": { "googlePalmApi": { "id": "oF4jKBK0jRbwEPWt", "name": "Google Gemini(PaLM) Api account" } }
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Slide 1 Prompt').item.json;\nconst resp = $input.item.json;\n\nlet imgData = '';\nconst candidates = resp.candidates || [];\nfor (const c of candidates) {\n  for (const p of (c?.content?.parts || [])) {\n    const d = p.inline_data || p.inlineData;\n    if (d && d.data) { imgData = d.data; break; }\n  }\n  if (imgData) break;\n}\nif (!imgData) throw new Error('No image for slide 1');\n\nreturn [{ json: { ...prev, img_data: imgData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2680, 300],
      "id": "extract1",
      "name": "Extract 1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.imgbb.com/1/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": { "parameters": [{ "name": "key", "value": "d5e3ee3c8c2fa1a29f6d6dc3c2c79447" }, { "name": "image", "value": "={{ $json.img_data }}" }] },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2900, 300],
      "id": "upload1",
      "name": "Upload 1"
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Extract 1').item.json;\nconst upload = $input.item.json;\nconst url = upload.data?.url || upload.data?.display_url;\n\nconst results = [{ slide_number: 1, headline: prev.headline, subtext: prev.subtext, image_url: url }];\n\nif (prev.remaining_slides.length === 0) {\n  return [{ json: { done: true, results: results } }];\n}\n\nconst next = prev.remaining_slides[0];\n\n// Extract slide 2 prompt from agent output or create default\nlet slidePrompt = '';\nconst slide2Match = prev.agent_output.match(/\\*\\*SLIDE 2 PROMPT:\\*\\*([\\s\\S]*?)(?=\\*\\*SLIDE 3|---\\*\\*VISUAL|$)/i);\nif (slide2Match) {\n  slidePrompt = slide2Match[1].trim();\n} else {\n  slidePrompt = `Create a 4:5 portrait Instagram carousel image.\n\n${prev.style_instructions}\n\nSLIDE 2 of ${prev.total}\nHEADLINE: \"${next.headline}\"\nTOPIC: ${prev.topic}\n\nCRITICAL: MUST match slide 1 style EXACTLY - same colors, same effects, same composition.\n\n1. HEADLINE TEXT: Bold \"${next.headline}\" in ${prev.color_accent} color\n2. MSI LOGO: BOTTOM RIGHT corner - DO NOT modify\n3. Match slide 1 visual style exactly`;\n}\n\nreturn [{ json: { done: false, slide_num: 2, headline: next.headline, subtext: next.subtext || '', prompt: slidePrompt, logo: prev.logo, remaining_slides: prev.remaining_slides.slice(1), total: prev.total, style_instructions: prev.style_instructions, topic: prev.topic, color_accent: prev.color_accent, color_dark: prev.color_dark, agent_output: prev.agent_output, results: results } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3120, 300],
      "id": "collect1",
      "name": "Collect 1"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "leftValue": "={{ $json.done }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }],
          "combinator": "and"
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3340, 300],
      "id": "check1",
      "name": "Done?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contents: [{ parts: [{ text: $json.prompt }, { inline_data: { mime_type: 'image/png', data: $json.logo } }] }], generationConfig: { responseModalities: ['IMAGE'], imageConfig: { aspectRatio: '4:5', imageSize: '2K' } } }) }}",
        "options": { "timeout": 120000 }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3560, 420],
      "id": "gemini2",
      "name": "Gemini 2",
      "credentials": { "googlePalmApi": { "id": "oF4jKBK0jRbwEPWt", "name": "Google Gemini(PaLM) Api account" } }
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Collect 1').item.json;\nconst resp = $input.item.json;\n\nlet imgData = '';\nconst candidates = resp.candidates || [];\nfor (const c of candidates) {\n  for (const p of (c?.content?.parts || [])) {\n    const d = p.inline_data || p.inlineData;\n    if (d && d.data) { imgData = d.data; break; }\n  }\n  if (imgData) break;\n}\nif (!imgData) throw new Error('No image for slide 2');\n\nreturn [{ json: { ...prev, img_data: imgData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3780, 420],
      "id": "extract2",
      "name": "Extract 2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.imgbb.com/1/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": { "parameters": [{ "name": "key", "value": "d5e3ee3c8c2fa1a29f6d6dc3c2c79447" }, { "name": "image", "value": "={{ $json.img_data }}" }] },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4000, 420],
      "id": "upload2",
      "name": "Upload 2"
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Extract 2').item.json;\nconst upload = $input.item.json;\nconst url = upload.data?.url || upload.data?.display_url;\n\nconst results = [...prev.results, { slide_number: 2, headline: prev.headline, subtext: prev.subtext, image_url: url }];\n\nif (prev.remaining_slides.length === 0) {\n  return [{ json: { done: true, results: results } }];\n}\n\nconst next = prev.remaining_slides[0];\n\n// Extract slide 3 prompt from agent output or create default\nlet slidePrompt = '';\nconst slide3Match = prev.agent_output.match(/\\*\\*SLIDE 3 PROMPT:\\*\\*([\\s\\S]*?)(?=\\*\\*SLIDE 4|---\\*\\*VISUAL|$)/i);\nif (slide3Match) {\n  slidePrompt = slide3Match[1].trim();\n} else {\n  slidePrompt = `Create a 4:5 portrait Instagram carousel image.\n\n${prev.style_instructions}\n\nSLIDE 3 of ${prev.total}\nHEADLINE: \"${next.headline}\"\nTOPIC: ${prev.topic}\n\nCRITICAL: MUST match slides 1 and 2 style EXACTLY.\n\n1. HEADLINE TEXT: Bold \"${next.headline}\" in ${prev.color_accent} color\n2. MSI LOGO: BOTTOM RIGHT corner - DO NOT modify\n3. Match previous slides visual style exactly`;\n}\n\nreturn [{ json: { done: false, slide_num: 3, headline: next.headline, subtext: next.subtext || '', prompt: slidePrompt, logo: prev.logo, remaining_slides: prev.remaining_slides.slice(1), total: prev.total, style_instructions: prev.style_instructions, topic: prev.topic, color_accent: prev.color_accent, color_dark: prev.color_dark, agent_output: prev.agent_output, results: results } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4220, 420],
      "id": "collect2",
      "name": "Collect 2"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "leftValue": "={{ $json.done }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }],
          "combinator": "and"
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [4440, 420],
      "id": "check2",
      "name": "Done? 2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contents: [{ parts: [{ text: $json.prompt }, { inline_data: { mime_type: 'image/png', data: $json.logo } }] }], generationConfig: { responseModalities: ['IMAGE'], imageConfig: { aspectRatio: '4:5', imageSize: '2K' } } }) }}",
        "options": { "timeout": 120000 }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4660, 540],
      "id": "gemini3",
      "name": "Gemini 3",
      "credentials": { "googlePalmApi": { "id": "oF4jKBK0jRbwEPWt", "name": "Google Gemini(PaLM) Api account" } }
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Collect 2').item.json;\nconst resp = $input.item.json;\n\nlet imgData = '';\nconst candidates = resp.candidates || [];\nfor (const c of candidates) {\n  for (const p of (c?.content?.parts || [])) {\n    const d = p.inline_data || p.inlineData;\n    if (d && d.data) { imgData = d.data; break; }\n  }\n  if (imgData) break;\n}\nif (!imgData) throw new Error('No image for slide 3');\n\nreturn [{ json: { ...prev, img_data: imgData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4880, 540],
      "id": "extract3",
      "name": "Extract 3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.imgbb.com/1/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": { "parameters": [{ "name": "key", "value": "d5e3ee3c8c2fa1a29f6d6dc3c2c79447" }, { "name": "image", "value": "={{ $json.img_data }}" }] },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5100, 540],
      "id": "upload3",
      "name": "Upload 3"
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Extract 3').item.json;\nconst upload = $input.item.json;\nconst url = upload.data?.url || upload.data?.display_url;\n\nconst results = [...prev.results, { slide_number: 3, headline: prev.headline, subtext: prev.subtext, image_url: url }];\n\nreturn [{ json: { done: true, results: results } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5320, 540],
      "id": "collect3",
      "name": "Collect 3"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst slides = data.results.sort((a, b) => a.slide_number - b.slide_number);\n\nreturn [{ json: { success: true, message: `Generated ${slides.length} carousel slides`, data: { total_slides: slides.length, slides: slides } } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5540, 300],
      "id": "format-final",
      "name": "Format Final"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": { "responseHeaders": { "entries": [{ "name": "Access-Control-Allow-Origin", "value": "*" }, { "name": "Access-Control-Allow-Methods", "value": "GET, POST, OPTIONS" }, { "name": "Access-Control-Allow-Headers", "value": "Content-Type" }] } }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [5760, 300],
      "id": "respond",
      "name": "Respond"
    }
  ],
  "connections": {
    "Webhook": { "main": [[{ "node": "Download Logo", "type": "main", "index": 0 }]] },
    "Download Logo": { "main": [[{ "node": "Parse Input", "type": "main", "index": 0 }]] },
    "Parse Input": { "main": [[{ "node": "Agent 1: Carousel Strategy", "type": "main", "index": 0 }]] },
    "Agent 1: Carousel Strategy": { "main": [[{ "node": "Agent 2: Carousel Copy Writer", "type": "main", "index": 0 }]] },
    "Agent 2: Carousel Copy Writer": { "main": [[{ "node": "Merge Agent Outputs", "type": "main", "index": 0 }]] },
    "Merge Agent Outputs": { "main": [[{ "node": "Route by Visual Style", "type": "main", "index": 0 }]] },
    "OpenAI for Strategy": { "ai_languageModel": [[{ "node": "Agent 1: Carousel Strategy", "type": "ai_languageModel", "index": 0 }]] },
    "OpenAI for Copy Writer": { "ai_languageModel": [[{ "node": "Agent 2: Carousel Copy Writer", "type": "ai_languageModel", "index": 0 }]] },
    "OpenAI for Image Prompts": { "ai_languageModel": [[{ "node": "Agent 3: Image Prompts", "type": "ai_languageModel", "index": 0 }]] },
    "Route by Visual Style": { 
      "main": [
        [{ "node": "Style: Glassmorphism", "type": "main", "index": 0 }],
        [{ "node": "Style: Modern 3D", "type": "main", "index": 0 }],
        [{ "node": "Style: Isometric", "type": "main", "index": 0 }],
        [{ "node": "Style: Data Hero", "type": "main", "index": 0 }],
        [{ "node": "Style: Realistic", "type": "main", "index": 0 }],
        [{ "node": "Style: Default", "type": "main", "index": 0 }]
      ] 
    },
    "Style: Glassmorphism": { "main": [[{ "node": "Agent 3: Image Prompts", "type": "main", "index": 0 }]] },
    "Style: Modern 3D": { "main": [[{ "node": "Agent 3: Image Prompts", "type": "main", "index": 0 }]] },
    "Style: Isometric": { "main": [[{ "node": "Agent 3: Image Prompts", "type": "main", "index": 0 }]] },
    "Style: Data Hero": { "main": [[{ "node": "Agent 3: Image Prompts", "type": "main", "index": 0 }]] },
    "Style: Realistic": { "main": [[{ "node": "Agent 3: Image Prompts", "type": "main", "index": 0 }]] },
    "Style: Default": { "main": [[{ "node": "Agent 3: Image Prompts", "type": "main", "index": 0 }]] },
    "Agent 3: Image Prompts": { "main": [[{ "node": "Slide 1 Prompt", "type": "main", "index": 0 }]] },
    "Slide 1 Prompt": { "main": [[{ "node": "Gemini 1", "type": "main", "index": 0 }]] },
    "Gemini 1": { "main": [[{ "node": "Extract 1", "type": "main", "index": 0 }]] },
    "Extract 1": { "main": [[{ "node": "Upload 1", "type": "main", "index": 0 }]] },
    "Upload 1": { "main": [[{ "node": "Collect 1", "type": "main", "index": 0 }]] },
    "Collect 1": { "main": [[{ "node": "Done?", "type": "main", "index": 0 }]] },
    "Done?": { 
      "main": [
        [{ "node": "Format Final", "type": "main", "index": 0 }],
        [{ "node": "Gemini 2", "type": "main", "index": 0 }]
      ] 
    },
    "Gemini 2": { "main": [[{ "node": "Extract 2", "type": "main", "index": 0 }]] },
    "Extract 2": { "main": [[{ "node": "Upload 2", "type": "main", "index": 0 }]] },
    "Upload 2": { "main": [[{ "node": "Collect 2", "type": "main", "index": 0 }]] },
    "Collect 2": { "main": [[{ "node": "Done? 2", "type": "main", "index": 0 }]] },
    "Done? 2": { 
      "main": [
        [{ "node": "Format Final", "type": "main", "index": 0 }],
        [{ "node": "Gemini 3", "type": "main", "index": 0 }]
      ] 
    },
    "Gemini 3": { "main": [[{ "node": "Extract 3", "type": "main", "index": 0 }]] },
    "Extract 3": { "main": [[{ "node": "Upload 3", "type": "main", "index": 0 }]] },
    "Upload 3": { "main": [[{ "node": "Collect 3", "type": "main", "index": 0 }]] },
    "Collect 3": { "main": [[{ "node": "Format Final", "type": "main", "index": 0 }]] },
    "Format Final": { "main": [[{ "node": "Respond", "type": "main", "index": 0 }]] }
  },
  "pinData": {},
  "meta": { "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e" }
}
