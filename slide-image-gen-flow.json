{
    "name": "MSI Slide Image Gen v2",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "msi-slide-gen",
                "responseMode": "onReceived",
                "options": {}
            },
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                0,
                0
            ],
            "id": "webhook-slide-gen",
            "name": "Webhook - Slide Gen",
            "webhookId": "msi-slide-gen-webhook"
        },
        {
            "parameters": {
                "url": "https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png",
                "options": {
                    "response": {
                        "response": {
                            "responseFormat": "file"
                        }
                    }
                }
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                220,
                0
            ],
            "id": "download-logo",
            "name": "Download MSI Logo"
        },
        {
            "parameters": {
                "jsCode": "// Prepare Gemini Input - Build complete slide image prompt\nconst inputData = $('Webhook - Slide Gen').item.json;\nconst input = inputData.body || inputData;\nconst logoItem = $('Download MSI Logo').item;\n\n// Get logo base64\nlet logoBase64 = '';\nif (logoItem.binary && Object.keys(logoItem.binary).length > 0) {\n  const binaryKey = Object.keys(logoItem.binary)[0];\n  const binaryData = logoItem.binary[binaryKey];\n  \n  try {\n    const buffer = await this.helpers.getBinaryDataBuffer(0, binaryKey);\n    logoBase64 = buffer.toString('base64');\n  } catch (e) {\n     if (binaryData.data && binaryData.data !== 'filesystem-v2') {\n         logoBase64 = binaryData.data;\n     }\n  }\n}\n\n// Extract all slide content fields\nconst slideNumber = parseInt(input.slide_number) || 1;\nconst headline = input.headline || '';\nconst subtext = input.subtext || '';\nconst bodyText = input.body_text || '';\nconst topic = input.topic || 'Technology';\n\n// Extract source from visual_style JSON - CRITICAL: source is stored here\nlet source = '';\ntry {\n  if (input.visual_style) {\n    const vs = typeof input.visual_style === 'string' ? JSON.parse(input.visual_style) : input.visual_style;\n    source = vs.source || '';\n  }\n} catch (e) {\n  source = '';\n}\n// Fallback - if source is empty or just whitespace, use default\nif (!source || source.trim() === '') {\n  source = 'Industry Report';\n}\n\n// Generate dynamic tagline for Slide 1 based on topic\nconst topicLower = topic.toLowerCase();\nlet topicTagline = 'Our Latest Tech News';\nif (topicLower.includes('ai') || topicLower.includes('artificial intelligence') || topicLower.includes('machine learning')) {\n  topicTagline = 'Our Latest AI News';\n} else if (topicLower.includes('security') || topicLower.includes('cyber')) {\n  topicTagline = 'Our Latest Security News';\n} else if (topicLower.includes('cloud')) {\n  topicTagline = 'Our Latest Cloud News';\n} else if (topicLower.includes('data')) {\n  topicTagline = 'Our Latest Data News';\n} else if (topicLower.includes('digital') || topicLower.includes('transformation')) {\n  topicTagline = 'Our Latest Digital News';\n} else if (topicLower.includes('bpo') || topicLower.includes('outsourcing')) {\n  topicTagline = 'Our Latest Business News';\n} else if (topicLower.includes('blockchain') || topicLower.includes('crypto')) {\n  topicTagline = 'Our Latest Blockchain News';\n} else if (topicLower.includes('automation') || topicLower.includes('rpa')) {\n  topicTagline = 'Our Latest Automation News';\n}\n\n// Determine background color: Slides 1,3,5 = BLUE / Slides 2,4 = WHITE\nconst isBlueSlide = (slideNumber === 1 || slideNumber === 3 || slideNumber === 5);\n\n// TYPOGRAPHY SPECS - MSI Brand Fonts (consistent across all slides)\n// CRITICAL FOR IMAGE GENERATION: Use these EXACT font names\nconst typoSpecs = `\nTYPOGRAPHY - USE THESE EXACT FONTS:\n- ALL HEADINGS: Use \"ITC Avant Garde Gothic\" font (or Avant Garde, Century Gothic as fallback). Bold weight, 32-36pt size.\n- ALL BODY/PARAGRAPHS: Use \"Quicksand\" font. Regular weight, 18-20pt size, max 3 lines.\n- Source text: Quicksand font, 12-14pt, Regular weight.\n- Tagline/Subtext: Quicksand font, 14-16pt, Regular weight.\n- Pagination: Quicksand font, 14pt, Regular weight (NOT bold).\n- IMPORTANT: Maintain consistent font sizes across ALL 5 slides for visual coherence.\n`;\n\n// Pagination for content slides (2,3,4): numbered 1-4 (not X/5)\n// Slide 2 = page 1, Slide 3 = page 2, Slide 4 = page 3, etc.\nconst paginationNumber = slideNumber - 1; // Slides 2-4 become pages 1-3\n\n// Build the COMPLETE image generation prompt based on slide type\nlet fullPrompt = '';\n\nif (slideNumber === 1) {\n  // COVER SLIDE - Blue background\n  fullPrompt = `Create a professional Instagram carousel COVER slide (4:5 aspect ratio, 1080x1350 pixels) for MSI Technologies.\n\nCRITICAL DESIGN RULES:\n- Background: SOLID MSI Blue (#207CE5) - MUST be blue, NOT white\n- DO NOT add any bar, strip, or section above the main content\n- DO NOT add any header area or colored strip at the top of the slide\n- The entire background should be uniform blue (#207CE5)\n- NO PAGINATION on cover slide\n${typoSpecs}\nLAYOUT:\n- MSI Logo: White version, TOP RIGHT corner (small, 40-50px)\n- Tagline: \\\"${topicTagline}\\\" (Quicksand font, 16pt, regular, white, centered vertically)\n- Main Headline: \\\"${headline}\\\" (ITC Avant Garde font, 36pt, BOLD, white, centered below tagline)\n- Swipe indicator: Arrow pointing RIGHT + \\\"Swipe\\\" text in WHITE, BOTTOM RIGHT corner (Quicksand font)\n\nSTYLE: Ultra-clean, minimalist. SOLID Blue background (#207CE5), white text only. Professional tech brand feel.`;\n\n} else if (slideNumber === 5) {\n  // CTA SLIDE - Blue background\n  fullPrompt = `Create a professional Instagram carousel CTA slide (4:5 aspect ratio, 1080x1350 pixels) for MSI Technologies.\n\nCRITICAL DESIGN RULES:\n- Background: SOLID MSI Blue (#207CE5) - MUST be blue, NOT white\n- DO NOT add any bar, strip, or section at the top\n- DO NOT add any header area - clean solid blue background\n- NO PAGINATION on CTA slide\n${typoSpecs}\nLAYOUT:\n- MSI Logo: White version, TOP RIGHT corner (small, 40-50px)\n- MSI Logo (large): White version, centered, prominent (above CTA headline)\n- CTA Headline: \\\"${headline}\\\" (ITC Avant Garde font, 36pt, BOLD, white, centered)\n\nCONTACT SECTION (bottom center, white text):\n- Quicksand font, 14pt\n- Envelope icon + \\\"contact@msitechnologiesinc.com\\\"\n- Globe icon + \\\"msitechnologiesinc.com\\\"\n\nSTYLE: Clean, professional CTA design. SOLID Blue background (#207CE5), white elements only.`;\n\n} else if (slideNumber === 3) {\n  // CONTENT SLIDE 3 - Blue background for text area\n  fullPrompt = `Create a professional Instagram carousel CONTENT slide (4:5 aspect ratio, 1080x1350 pixels) for MSI Technologies.\n\nCRITICAL DESIGN RULES:\n- Layout: 55% top = PHOTO, 45% bottom = TEXT on MSI Blue (#207CE5)\n- DO NOT add any bar, strip, header, or section ABOVE the photo\n- The photo MUST start at the very TOP EDGE of the slide (pixel 0)\n- NO colored strip or header between top edge and photo\n- Text area background: SOLID MSI Blue (#207CE5)\n${typoSpecs}\nLAYOUT:\n- MSI Logo: White version, TOP RIGHT corner INSIDE the photo area (small, 40-50px)\n- PAGINATION: \\\"${paginationNumber}\\\" in WHITE, BOTTOM LEFT corner of text area (Quicksand font, 14pt, regular weight)\n\nVISUAL AREA (top 55% - starts at pixel 0, no gap):\n- Professional photography related to: ${headline}\n- Photo fills ENTIRE top portion edge-to-edge, starting from very top\n- Subtle blue tint overlay OK\n\nTEXT AREA (bottom 45% - MSI Blue #207CE5 background):\n- Headline: \\\"${headline}\\\" (ITC Avant Garde font, 32pt, BOLD, WHITE)\n- Body: \\\"${bodyText}\\\" (Quicksand font, 18pt, regular, WHITE, max 3 lines)\n- Source: \\\"Source: ${source}\\\" (Quicksand font, 12pt, light blue #B8D4F0, below body text)\n\nSTYLE: Clean, professional news design. Photo on top, Blue text area on bottom.`;\n\n} else {\n  // CONTENT SLIDES 2, 4 - White background for text area\n  fullPrompt = `Create a professional Instagram carousel CONTENT slide (4:5 aspect ratio, 1080x1350 pixels) for MSI Technologies.\n\nCRITICAL DESIGN RULES:\n- Layout: 55% top = PHOTO, 45% bottom = TEXT on WHITE (#FFFFFF)\n- DO NOT add any bar, strip, header, or section ABOVE the photo\n- The photo MUST start at the very TOP EDGE of the slide (pixel 0)\n- NO colored strip or header between top edge and photo\n- Text area background: Clean WHITE (#FFFFFF)\n${typoSpecs}\nLAYOUT:\n- MSI Logo: Blue version (#207CE5), TOP RIGHT corner INSIDE the photo area (small, 40-50px)\n- PAGINATION: \\\"${paginationNumber}\\\" in dark gray, BOTTOM LEFT corner of text area (Quicksand font, 14pt, regular weight)\n\nVISUAL AREA (top 55% - starts at pixel 0, no gap):\n- Professional photography related to: ${headline}\n- Photo fills ENTIRE top portion edge-to-edge, starting from very top\n- NO overlay, NO text on image\n\nTEXT AREA (bottom 45% - WHITE background):\n- Headline: \\\"${headline}\\\" (ITC Avant Garde font, 32pt, BOLD, MSI Blue #207CE5)\n- Body: \\\"${bodyText}\\\" (Quicksand font, 18pt, regular, dark gray #2B2B2B, max 3 lines)\n- Source: \\\"Source: ${source}\\\" (Quicksand font, 12pt, gray #888888, below body text)\n\nSTYLE: Clean, professional news design. Photo on top, White text area on bottom.`;\n}\n\nreturn [{\n  json: {\n    image_prompt: fullPrompt,\n    slide_id: input.slide_id,\n    carousel_id: input.carousel_id,\n    slide_number: slideNumber,\n    headline: headline,\n    subtext: subtext,\n    body_text: bodyText,\n    source: source,\n    topic: topic,\n    topic_tagline: topicTagline,\n    is_blue_slide: isBlueSlide,\n    logo_base64: logoBase64\n  }\n}];"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                440,
                0
            ],
            "id": "prepare-gemini",
            "name": "Prepare Gemini Input"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
                "authentication": "predefinedCredentialType",
                "nodeCredentialType": "googlePalmApi",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ JSON.stringify({\n  contents: [{\n    parts: [\n      { text: $json.image_prompt },\n      { inline_data: { mime_type: 'image/png', data: $json.logo_base64 } }\n    ]\n  }],\n  generationConfig: {\n    responseModalities: ['TEXT', 'IMAGE']\n  }\n}) }}",
                "options": {
                    "response": {
                        "response": {}
                    },
                    "timeout": 120000
                }
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                660,
                0
            ],
            "id": "generate-image",
            "name": "Generate Image",
            "credentials": {
                "googlePalmApi": {
                    "id": "oF4jKBK0jRbwEPWt",
                    "name": "Google Gemini(PaLM) Api account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Extract image binary from Gemini response\nconst item = $input.item;\nconst preparedData = $('Prepare Gemini Input').item.json;\nconst candidates = item.json?.candidates || [];\n\nlet imageData = null;\nlet mimeType = 'image/png';\n\n// Search through all parts for image data\nfor (const candidate of candidates) {\n  const parts = candidate?.content?.parts || [];\n  for (const part of parts) {\n    const inlineData = part?.inline_data || part?.inlineData;\n    if (inlineData && inlineData.data) {\n      imageData = inlineData.data;\n      mimeType = inlineData.mime_type || inlineData.mimeType || 'image/png';\n      break;\n    }\n  }\n  if (imageData) break;\n}\n\nif (imageData) {\n  return [{\n    json: {\n      slide_id: preparedData.slide_id,\n      carousel_id: preparedData.carousel_id,\n      slide_number: preparedData.slide_number\n    },\n    binary: {\n      data: {\n        data: imageData,\n        mimeType: mimeType,\n        fileName: `slide_${preparedData.slide_number}.png`\n      }\n    }\n  }];\n}\n\nthrow new Error('No image generated. Response: ' + JSON.stringify(item.json).substring(0, 500));"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                880,
                0
            ],
            "id": "extract-binary",
            "name": "Extract Binary"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://api.imgbb.com/1/upload",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "contentType": "multipart-form-data",
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "key",
                            "value": "d5e3ee3c8c2fa1a29f6d6dc3c2c79447"
                        },
                        {
                            "parameterType": "formBinaryData",
                            "name": "image",
                            "inputDataFieldName": "=data"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1100,
                0
            ],
            "id": "upload-imgbb",
            "name": "Upload to ImgBB",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "zx6X4T7j4yDMYWKo",
                    "name": "imgbb-api"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "=UPDATE carousel_slides \nSET image_url = '{{ $json.data.url }}', \n    updated_at = NOW()\nWHERE id = '{{ $('Extract Binary').item.json.slide_id }}'\nRETURNING *",
                "options": {}
            },
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 2.5,
            "position": [
                1320,
                0
            ],
            "id": "update-slide-db",
            "name": "Update Slide DB",
            "credentials": {
                "postgres": {
                    "id": "WnTYs2zvPoE7hDJE",
                    "name": "Postgres account"
                }
            }
        }
    ],
    "connections": {
        "Webhook - Slide Gen": {
            "main": [
                [
                    {
                        "node": "Download MSI Logo",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Download MSI Logo": {
            "main": [
                [
                    {
                        "node": "Prepare Gemini Input",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Gemini Input": {
            "main": [
                [
                    {
                        "node": "Generate Image",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Image": {
            "main": [
                [
                    {
                        "node": "Extract Binary",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Binary": {
            "main": [
                [
                    {
                        "node": "Upload to ImgBB",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upload to ImgBB": {
            "main": [
                [
                    {
                        "node": "Update Slide DB",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "settings": {
        "executionOrder": "v1"
    }
}