{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "70738d02-4bd8-4dac-853f-ba4836aafaf5",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        42528,
        9328
      ],
      "id": "300ae9e0-fd76-4933-a655-81ad64dd6f62",
      "name": "Webhook - Generate Content",
      "webhookId": "70738d02-4bd8-4dac-853f-ba4836aafaf5"
    },
    {
      "parameters": {
        "jsCode": "// Extraer datos del formulario web\nconst input = $input.item.json;\n\nconsole.log('==== WEBHOOK INPUT ====');\nconsole.log('Raw input keys:', Object.keys(input));\nconsole.log('Body type:', typeof input.body);\nconsole.log('Body value:', input.body);\n\n// Parsear el body si es un string JSON\nlet data;\nif (input.body) {\n  if (typeof input.body === 'string') {\n    try {\n      data = JSON.parse(input.body);\n      console.log('Parsed JSON body successfully');\n    } catch (e) {\n      console.error('Failed to parse body as JSON:', e.message);\n      data = input;\n    }\n  } else if (typeof input.body === 'object') {\n    data = input.body;\n    console.log('Body is already an object');\n  } else {\n    data = input;\n  }\n} else if (input.query) {\n  data = input.query;\n  console.log('Using input.query');\n} else {\n  data = input;\n  console.log('Using input directly');\n}\n\nconsole.log('Extracted data:', JSON.stringify(data, null, 2));\n\n// Construir variables (soportar snake_case y camelCase)\nconst topic = data.topic || '';\nconst post_type = data.post_type || data.postType || '';\nconst visual_style = data.visual_style || data.visualStyle || '';\nconst orientation = data.orientation || '';\nconst headline = data.headline || '';\nconst data_points = data.data_points || data.dataPoints || '';\nconst context = data.context || '';\n\nconsole.log('Final variables:', {topic, post_type, visual_style, orientation, headline, data_points, context});\nconsole.log('==== END WEBHOOK INPUT ====');\n\nreturn [{\n  json: {\n    topic,\n    post_type,\n    visual_style,\n    orientation,\n    headline,\n    data_points,\n    context\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        42752,
        9328
      ],
      "id": "925c75b4-e093-46f1-87b1-1630753d1f4a",
      "name": "Format Form Input"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Create a content strategy for:\n\nTopic: {{ $json.topic }}\nPost Type: {{ $json.post_type }}\nVisual Style: {{ $json.visual_style }}\nHeadline: {{ $json.headline }}\nData Points: {{ $json.data_points || 'None provided' }}\nContext: {{ $json.context || 'None provided' }}\n\nNote: All images will be in 4:5 portrait format.",
        "options": {
          "systemMessage": "=# LANGUAGE REQUIREMENT\nALWAYS respond in English regardless of input language. Even if the user writes in Spanish, French, or any other language, your output MUST be in English.\n\n# ROLE: Strategic Content Analyst for MSI Technologies\n\n## YOUR TASK\nAnalyze the user's content request and provide strategic guidance for both LinkedIn copy and visual design.\n\n## OUTPUT FORMAT\nYou MUST output your response in this EXACT structure:\n\n---CONTENT STRATEGY---\nHook: [Compelling first line]\nBody: [Main message with examples]\nCTA: [Call to action as question]\nHashtags: [3-5 relevant hashtags including #MSITechnologies]\n\n---VISUAL STRATEGY---\nUser's Visual Style: [Copy exactly from user input]\nScene Concept: [How to visualize the topic using the user's chosen style]\nFormat: 4:5 Portrait\nComposition: [Vertical layout optimized for portrait format]\n\n---GRAPHIC ELEMENTS---\n[2-3 specific visual elements that match the user's visual style]\n\n---IN-IMAGE TEXT---\n[Copy EXACT headline from user input - character by character]\n\n---DATA POINTS---\n[Only list data points if user explicitly provided them. If none provided, write \"None provided - focus on insights and examples instead of statistics\"]\n\n---COLOR GUIDANCE---\nALWAYS use backgrounds with brand blue #207CE5 or darker variations. Use white and black for text and accents. Professional, clean aesthetic.\n\n## MSI CONTEXT\nMSI Technologies is a technology solutions company that helps businesses modernize their infrastructure, optimize operations, and implement innovative technology solutions. Focus on digital transformation, technical excellence, and business impact.\n\n## CONTENT STRATEGY RULES\n1. NO generic corporate language\n2. Use specific data and real examples ONLY if user provided them - NEVER invent statistics\n3. Keep hook under 150 characters\n4. Be technical but accessible\n5. Always end with conversational CTA\n\n## VISUAL STRATEGY RULES\n1. RESPECT the user's chosen Visual Style - adapt your scene concept to match it\n2. ALWAYS use brand blue #207CE5 backgrounds or darker blue variations. NEVER white or light backgrounds\n3. Use white and black for text and accents - clean, professional contrast\n4. Suggest 2-3 graphic elements that fit the user's style with premium, professional aesthetic\n5. Keep compositions clean for vertical 4:5 format with sophisticated lighting\n6. Allow subtitles or supporting text if needed to effectively convey the message\n\nREMEMBER: The user's Visual Style choice is PRIMARY - your strategy should enhance it, not replace it. Copy the user's headline exactly. Brand blue #207CE5 backgrounds MANDATORY. NEVER invent data or statistics. All images are 4:5 portrait format."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        42976,
        9328
      ],
      "id": "0f4f3960-c677-49ea-abb2-f686344cb63f",
      "name": "Agent 1: Strategy Analyzer"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Agent 1: Strategy Analyzer').item.json.output }}",
        "options": {
          "systemMessage": "# LANGUAGE REQUIREMENT\nALWAYS respond in English regardless of input language. Even if the user writes in Spanish, French, or any other language, your output MUST be in English.\n\n# ROLE: LinkedIn Copy Writer for MSI Technologies\n\nYou receive a CONTENT STRATEGY and create LinkedIn post copy. Output ONLY the post text - no labels, no metadata, no character counts.\n\n## STRUCTURE\n- Hook (First 2 lines): Specific stat, question, or concrete statement\n- Body: Include data points, line breaks every 2-3 sentences\n- CTA: Conversational question\n\n## VOICE\n- Senior engineer who's solved this 50 times\n- Direct and honest, not salesy\n- Technical but accessible\n\n## NEVER USE\n- \"In today's digital landscape\"\n- \"Revolutionize/Transform your business\"\n- \"Cutting-edge/Game-changing\"\n- \"Unlock the power of\"\n- \"Seamlessly integrate\"\n- \"Best-in-class\"\n\n## REQUIREMENTS\n- English only\n- Maximum 100 words (approximately 600-700 characters)\n- Use specific numbers/stats ONLY if user provided them - NEVER invent data\n- NO emojis\n- Always end with #MSITechnologies + relevant hashtags\n\n## CONTACT INFO (ALWAYS INCLUDE)\nAt the end of EVERY post, BEFORE the hashtags, include a clear contact invitation with visual separator:\n- Format exactly like this (with the line above):\n  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  üì© Let's talk ‚Üí contact@msitechnologiesinc.com\n  üåê msitechnologiesinc.com\n- The line separator and icons make it stand out\n- This is your clear call-to-action for readers ready to connect\n\n## EXAMPLE (with user-provided data)\nMost digital transformation projects fail because teams focus on technology first instead of business outcomes. We've seen 60% of companies struggle with adoption after investing millions.\n\nThe fix isn't more tools. It's better strategy:\n- Start with clear business objectives\n- Involve end-users from day one\n- Measure impact, not just implementation\n\nWe helped a healthcare client improve operational efficiency by 47% in 90 days through targeted technology optimization. The secret? Focus on people and processes, not just tech.\n\nWhat's been your biggest challenge with technology adoption?\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüì© Let's talk ‚Üí contact@msitechnologiesinc.com\nüåê msitechnologiesinc.com\n\n#MSITechnologies #DigitalTransformation #TechStrategy\n\nNOTE: If no data points provided, focus on concrete insights, real scenarios, and actionable advice instead of statistics."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        43328,
        9328
      ],
      "id": "2b2bfa24-5340-482c-ab47-e937e0917a6c",
      "name": "Agent 2: Copy Writer"
    },
    {
      "parameters": {
        "jsCode": "// Generar instrucciones espec√≠ficas seg√∫n el estilo visual seleccionado\nconst visualStyle = $('Format Form Input').item.json.visual_style || 'Modern 3D';\n\nconst styleInstructions = {\n  'Realistic Photography': `\n## REALISTIC PHOTOGRAPHY STYLE\nGenerate a PHOTOREALISTIC STOCK PHOTO that looks like a candid professional photograph - NOT AI-generated.\n\n**SUBJECT:**\n- 1-2 professional people in tech industry, age 28-45\n- Diverse representation, authentic natural expression\n- Natural skin texture, realistic proportions - avoid artificial smoothness\n\n**CLOTHING:**\n- Business casual or tech casual\n- Fitted button-down, polo, blazer, or modern minimalist sweater\n- Clean and professional but approachable\n\n**BACKGROUND:**\n- Clean minimal professional background\n- Soft blurred modern office, neutral gray wall, or bright workspace with soft focus\n- Natural lighting with subtle shadows\n- NO complex patterns, NO graphics, NO surreal elements\n\n**CAMERA:**\n- Professional camera, 85mm portrait lens, f/2.8 aperture\n- Natural depth of field, soft window lighting\n- Real human with natural imperfections\n- Should look like Getty Images or Shutterstock photo\n\n**BRAND INTEGRATION:**\n- Brand blue (#207CE5) as subtle color grading overlay\n- Text overlaid on photo with good contrast`,\n\n  'Glassmorphism': `\n## GLASSMORPHISM STYLE\nCreate a modern Glassmorphism design with frosted glass panels and depth.\n\n**GLASS PANELS:**\n- 2-3 frosted glass panels with subtle blur effect\n- Layered composition creating depth\n- Semi-transparent with visible content behind\n- Subtle white glowing edges\n\n**BACKGROUND:**\n- Brand blue (#207CE5) to secondary blue (#004AAD) gradient\n- Soft abstract shapes or patterns behind glass\n\n**VISUAL ELEMENTS:**\n- Technology icons visible through glass (gears, circuits, data symbols)\n- Semi-transparent hexagonal shapes scattered\n- Connection lines in off-white linking elements\n- Professional rim lighting creating depth\n\n**AESTHETIC:**\n- Premium, sophisticated vertical composition\n- Modern and sleek Apple/Microsoft style`,\n\n  'Modern 3D': `\n## MODERN 3D STYLE\nCreate a modern 3D rendered corporate visual with depth and dimension.\n\n**3D ELEMENTS:**\n- Clean geometric 3D shapes (cubes, spheres, abstract forms)\n- Floating technology-related 3D objects\n- Smooth surfaces with realistic materials\n- Professional studio lighting with soft shadows\n\n**BACKGROUND:**\n- Brand blue (#207CE5) gradient background\n- Subtle depth with ambient occlusion\n\n**VISUAL ELEMENTS:**\n- 3D tech icons or abstract representations\n- Clean geometric patterns\n- Soft reflections and highlights\n- Premium material finish (matte, glossy accents)\n\n**AESTHETIC:**\n- Modern corporate 3D visualization\n- Clean, minimal, professional`,\n\n  'Isometric': `\n## ISOMETRIC STYLE\nCreate an isometric illustration with clean geometric perspective.\n\n**ISOMETRIC ELEMENTS:**\n- Isometric tech infrastructure (servers, networks, buildings)\n- Clean 30-degree angle perspective\n- Flat colors with subtle shadows\n- Connected systems showing flow\n\n**BACKGROUND:**\n- Brand blue (#207CE5) solid or gradient\n- Clean minimal backdrop\n\n**VISUAL ELEMENTS:**\n- Isometric office/tech equipment\n- Data flow lines connecting elements\n- Small human figures for scale (optional)\n- Icons integrated into isometric scene\n\n**AESTHETIC:**\n- Clean vector-style isometric illustration\n- Tech infographic look`,\n\n  'Data Visualization': `\n## DATA VISUALIZATION STYLE\nCreate a data-driven visual with charts and metrics.\n\n**DATA ELEMENTS:**\n- Clean charts (bar, line, pie, or abstract data viz)\n- Metrics and KPIs displayed prominently\n- Data nodes and connection lines\n- Growth indicators and trend arrows\n\n**BACKGROUND:**\n- Brand blue (#207CE5) gradient\n- Subtle grid or data pattern\n\n**VISUAL ELEMENTS:**\n- Dashboard-style layout\n- Glowing data points\n- Network/connection visualizations\n- Clean iconography\n\n**AESTHETIC:**\n- Professional analytics dashboard\n- Data-driven corporate style`,\n\n  'Minimalist': `\n## MINIMALIST STYLE\nCreate ultra-clean minimal design with focus on typography.\n\n**DESIGN:**\n- Solid brand blue (#207CE5) background\n- Maximum whitespace utilization\n- Single accent element if any\n- Focus on typography hierarchy\n\n**BACKGROUND:**\n- Pure solid color or very subtle gradient\n- NO complex elements, NO photos\n\n**VISUAL ELEMENTS:**\n- One simple geometric shape as accent (optional)\n- Clean horizontal line separator (optional)\n- Logo and text only\n\n**AESTHETIC:**\n- Ultra-clean corporate minimalism\n- Swiss/Bauhaus design influence`\n};\n\n// Obtener instrucciones del estilo o usar default\nlet selectedStyle = styleInstructions[visualStyle];\nif (!selectedStyle) {\n  // Buscar coincidencia parcial\n  const styleKey = Object.keys(styleInstructions).find(key => \n    visualStyle.toLowerCase().includes(key.toLowerCase()) ||\n    key.toLowerCase().includes(visualStyle.toLowerCase())\n  );\n  selectedStyle = styleInstructions[styleKey] || styleInstructions['Modern 3D'];\n}\n\nreturn [{\n  json: {\n    visual_style: visualStyle,\n    style_instructions: selectedStyle,\n    headline: $('Format Form Input').item.json.headline,\n    strategy_output: $('Agent 1: Strategy Analyzer').item.json.output,\n    post_id: $('Save Post to DB').item.json.id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        43792,
        9328
      ],
      "id": "style-instructions-node",
      "name": "Get Style Instructions"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO social_posts (topic, post_type, visual_style, orientation, headline, data_points, context, strategy_analysis, status, created_at, updated_at)\nVALUES (\n  '{{ $('Format Form Input').item.json.topic.replace(/'/g, \"''\") }}', '{{ $json.output.replace(/'/g, \"''\") }}', '{{ $('Format Form Input').item.json.visual_style.replace(/'/g, \"''\") }}', '{{ $('Format Form Input').item.json.orientation.replace(/'/g, \"''\") }}', '{{ $('Format Form Input').item.json.headline.replace(/'/g, \"''\") }}', '{{ $('Format Form Input').item.json.data_points.replace(/'/g, \"''\") }}', '{{ $('Format Form Input').item.json.context.replace(/'/g, \"''\") }}', '{{ $('Agent 1: Strategy Analyzer').item.json.output.replace(/'/g, \"''\") }}', 'copy_completed', NOW(), NOW()\n)\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        43680,
        9328
      ],
      "id": "68ab5723-cc8f-4062-afed-b7b89357daf3",
      "name": "Save Post to DB",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=STRATEGY ANALYSIS:\n{{ $json.strategy_output }}\n\nUSER INPUT:\nHeadline: {{ $json.headline }}\nVisual Style: {{ $json.visual_style }}\nFormat: 4:5 Portrait\n\nSTYLE-SPECIFIC INSTRUCTIONS:\n{{ $json.style_instructions }}",
        "options": {
          "systemMessage": "# ROLE: AI Image Prompt Engineer for MSI Technologies\n\nCreate an image generation prompt for Gemini 3 Pro based on the STRATEGY ANALYSIS and STYLE-SPECIFIC INSTRUCTIONS provided.\n\n## MSI BRAND COLORS (ALWAYS USE)\n- Brand Blue #207CE5 (primary)\n- Secondary Blue #004AAD (gradients, depth)\n- Off-White #FFFDF1 (text)\n- Dark Gray #2B2B2B (accents)\n\n## TEXT RENDERING\nRequest NATIVE TEXT RENDERING for crystal clear text:\n- Headline: EXACT text from input, bold sans-serif, 60-80pt, off-white (#FFFDF1), upper third\n- 2-3 Content lines below headline: 28-36pt, off-white\n- NO drop shadows - clean flat text\n\n## LOGO PLACEMENT\n- Place MSI logo in one corner (provided as reference image)\n- Use EXACTLY as provided - no modifications\n- Add contact badge: 'msitechnologiesinc.com'\n\n## OUTPUT STRUCTURE\n\n**SCENE DESCRIPTION:**\n[Apply the STYLE-SPECIFIC INSTRUCTIONS. Be detailed and specific.]\n\n**COLOR PALETTE:**\n[Brand blue #207CE5 primary, accents in off-white and dark gray]\n\n**HEADLINE TEXT:**\n\"Native text rendering: '[EXACT HEADLINE]' - Bold sans-serif, 70pt, off-white (#FFFDF1), NO shadows\"\n\n**CONTENT LINES:**\n\"2-3 supporting lines below headline, 28-32pt, off-white, clean spacing\"\n\n**VISUAL ELEMENTS:**\n[3-5 specific elements matching the style]\n\n**BRANDING:**\nMSI logo in [corner], contact badge nearby\n\n**FORMAT:**\n4:5 portrait\n\nFOLLOW THE STYLE-SPECIFIC INSTRUCTIONS PROVIDED. Output in English only."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        43904,
        9328
      ],
      "id": "ea8f3659-6822-446c-a422-5c6cbccad8d1",
      "name": "Agent 3: Image Prompt Engineer"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE social_posts \nSET image_prompt = '{{ $json.output.replace(/'/g, \"''\") }}',\n    status = 'prompt_completed',\n    updated_at = NOW()\nWHERE id = '{{ $('Get Style Instructions').item.json.post_id }}'\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        44256,
        9328
      ],
      "id": "a7cd9f98-25c2-423b-a0e5-eae0ef5fd23e",
      "name": "Update Image Prompt in DB",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "url": "https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        44480,
        9328
      ],
      "id": "e7388793-1934-46d8-8295-94c649e7e357",
      "name": "Download MSI Logo"
    },
    {
      "parameters": {
        "jsCode": "// Merge prompt data with logo binary for multi-image Gemini API call\nconst promptData = $('Update Image Prompt in DB').item.json;\nconst logoItem = $('Download MSI Logo').item;\n\nconsole.log('==== PREPARE MULTI-IMAGE INPUT ====');\nconsole.log('Prompt data:', {\n  id: promptData.id,\n  image_prompt_length: promptData.image_prompt?.length || 0,\n  orientation: promptData.orientation\n});\nconsole.log('Logo binary keys:', Object.keys(logoItem.binary || {}));\n\n// Get logo binary data and convert to base64\nlet logoBase64 = '';\nif (logoItem.binary && Object.keys(logoItem.binary).length > 0) {\n  const binaryKey = Object.keys(logoItem.binary)[0];\n  const binaryData = logoItem.binary[binaryKey];\n  \n  console.log('Binary data structure:', {\n    hasData: !!binaryData.data,\n    dataType: typeof binaryData.data,\n    dataValue: binaryData.data,\n    mimeType: binaryData.mimeType,\n    id: binaryData.id\n  });\n  \n  // In n8n filesystem mode, we need to use helpers to get the actual data\n  try {\n    // Use $binary helper to get the actual buffer content\n    const buffer = await this.helpers.getBinaryDataBuffer(logoItem.json.index || 0, binaryKey);\n    logoBase64 = buffer.toString('base64');\n    console.log('Logo base64 extracted from buffer, length:', logoBase64.length);\n    console.log('First 50 chars:', logoBase64.substring(0, 50));\n  } catch (e) {\n    console.error('Failed to get binary buffer:', e.message);\n    \n    // Fallback: try direct access\n    if (typeof binaryData.data === 'string' && binaryData.data !== 'filesystem-v2') {\n      logoBase64 = binaryData.data;\n    } else if (Buffer.isBuffer(binaryData.data)) {\n      logoBase64 = binaryData.data.toString('base64');\n    } else if (binaryData.data instanceof Uint8Array) {\n      logoBase64 = Buffer.from(binaryData.data).toString('base64');\n    }\n  }\n} else {\n  console.log('WARNING: No logo binary found');\n}\n\nif (!logoBase64 || logoBase64 === 'filesystem-v2') {\n  throw new Error('Failed to extract logo base64 data. Got: ' + logoBase64);\n}\n\nconsole.log('==== END PREPARE MULTI-IMAGE INPUT ====');\n\nreturn [{\n  json: {\n    image_prompt: promptData.image_prompt,\n    logo_base64: logoBase64,\n    post_id: promptData.id,\n    orientation: promptData.orientation\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44704,
        9328
      ],
      "id": "946e4b61-e404-4d31-9b93-f941c3e21579",
      "name": "Prepare for Image Gen"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE social_posts SET status = 'image_generated', updated_at = NOW() WHERE id = '{{ $('Prepare for Image Gen').item.json.post_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        44816,
        9328
      ],
      "id": "status-generating-image",
      "name": "Status: Generating Image",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  contents: [{\n    parts: [\n      { text: $('Prepare for Image Gen').item.json.image_prompt },\n      { inline_data: { mime_type: 'image/png', data: $('Prepare for Image Gen').item.json.logo_base64 } }\n    ]\n  }],\n  generationConfig: {\n    responseModalities: ['IMAGE'],\n    imageConfig: {\n      aspectRatio: '4:5',\n      imageSize: '2K'\n    }\n  }\n}) }}",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        44928,
        9328
      ],
      "id": "51c0c92e-88b8-4586-a63d-72d05a782b66",
      "name": "Generate Image",
      "credentials": {
        "googlePalmApi": {
          "id": "oF4jKBK0jRbwEPWt",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract image binary from Gemini REST API response\nconst item = $input.item;\n\nconsole.log('==== CHECK IMAGE BINARY ====');\nconsole.log('Item binary keys:', Object.keys(item.binary || {}));\nconsole.log('Item json keys:', Object.keys(item.json || {}));\n\n// Check if binary data exists (from HTTP Request node)\nif (item.binary && Object.keys(item.binary).length > 0) {\n  const binaryKey = Object.keys(item.binary)[0];\n  console.log('Found binary key:', binaryKey);\n  console.log('Binary data size:', item.binary[binaryKey]?.data?.length || 0);\n  \n  // Rename binary to 'data' for ImgBB\n  return [{\n    json: item.json,\n    binary: {\n      data: item.binary[binaryKey]\n    }\n  }];\n}\n\n// Check if response has inline_data or inlineData (Gemini API structure - support both formats)\nconst parts = item.json?.candidates?.[0]?.content?.parts?.[0];\nconst inlineData = parts?.inline_data || parts?.inlineData;\n\nif (inlineData) {\n  console.log('Found inline image data from Gemini API');\n  console.log('Mime type:', inlineData.mime_type || inlineData.mimeType);\n  console.log('Data size:', inlineData.data?.length || 0);\n  \n  // Convert base64 to binary for ImgBB\n  return [{\n    json: item.json,\n    binary: {\n      data: {\n        data: inlineData.data,\n        mimeType: inlineData.mime_type || inlineData.mimeType || 'image/png',\n        fileName: 'generated-image.png'\n      }\n    }\n  }];\n}\n\nconsole.log('ERROR: No binary data found in Gemini output');\nthrow new Error('No se gener√≥ imagen. Verifica que el modelo Gemini est√© configurado correctamente.');\n\nconsole.log('==== END CHECK IMAGE BINARY ====');"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45152,
        9328
      ],
      "id": "df4a187f-baea-48b1-9836-3ba2f1cfc239",
      "name": "Check and Prepare Binary"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.imgbb.com/1/upload",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "d5e3ee3c8c2fa1a29f6d6dc3c2c79447"
            },
            {
              "parameterType": "formBinaryData",
              "name": "image",
              "inputDataFieldName": "=data"
            }
          ]
        },
        "options": {}
      },
      "id": "bbf8aafd-92d4-4093-bca6-c020096ff42c",
      "name": "Upload to ImgBB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        45376,
        9328
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "zx6X4T7j4yDMYWKo",
          "name": "imgbb-api"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE social_posts \nSET image_url = '{{ $json.data.url }}', \n    status = 'completed',\n    updated_at = NOW()\nWHERE id = '{{ $('Prepare for Image Gen').item.json.post_id }}'\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        45600,
        9328
      ],
      "id": "632385f0-400e-4d69-bca7-109ce045e87f",
      "name": "Update DB with Image URL",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "success",
              "name": "success",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "message",
              "name": "message",
              "value": "=‚úÖ Content generated successfully!\n\nüìù Post ID: {{ $json.id }}\nüìå Topic: {{ $json.topic }}\nüé® Type: {{ $json.post_type }}\nüñºÔ∏è Image: {{ $json.image_url }}\n‚è∞ Created: {{ $json.created_at }}",
              "type": "string"
            },
            {
              "id": "post_id",
              "name": "post_id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "image_url",
              "name": "image_url",
              "value": "={{ $json.image_url }}",
              "type": "string"
            },
            {
              "id": "post_copy",
              "name": "post_copy",
              "value": "={{ $json.post_copy }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        45824,
        9328
      ],
      "id": "267a7236-4b8b-4829-95b3-624e4ab460f1",
      "name": "Format Success Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"message\": \"Content generated successfully\", \"data\": $json } }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        46048,
        9328
      ],
      "id": "eb29f774-3c6e-43fc-9fb0-65c0c9c93160",
      "name": "Respond to Webhook - Generate"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        43056,
        9552
      ],
      "id": "a4023ec4-811c-46f9-98ed-07a7ab486d19",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "13Oqly3WdRAzZVXL",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "connections": {
    "Webhook - Generate Content": {
      "main": [
        [
          {
            "node": "Format Form Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Form Input": {
      "main": [
        [
          {
            "node": "Agent 1: Strategy Analyzer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent 1: Strategy Analyzer": {
      "main": [
        [
          {
            "node": "Agent 2: Copy Writer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent 2: Copy Writer": {
      "main": [
        [
          {
            "node": "Save Post to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Post to DB": {
      "main": [
        [
          {
            "node": "Get Style Instructions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Style Instructions": {
      "main": [
        [
          {
            "node": "Agent 3: Image Prompt Engineer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent 3: Image Prompt Engineer": {
      "main": [
        [
          {
            "node": "Update Image Prompt in DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Image Prompt in DB": {
      "main": [
        [
          {
            "node": "Download MSI Logo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download MSI Logo": {
      "main": [
        [
          {
            "node": "Prepare for Image Gen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Image Gen": {
      "main": [
        [
          {
            "node": "Status: Generating Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status: Generating Image": {
      "main": [
        [
          {
            "node": "Generate Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Image": {
      "main": [
        [
          {
            "node": "Check and Prepare Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check and Prepare Binary": {
      "main": [
        [
          {
            "node": "Upload to ImgBB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to ImgBB": {
      "main": [
        [
          {
            "node": "Update DB with Image URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update DB with Image URL": {
      "main": [
        [
          {
            "node": "Format Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Success Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook - Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agent 1: Strategy Analyzer",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Agent 2: Copy Writer",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Agent 3: Image Prompt Engineer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e"
  }
}