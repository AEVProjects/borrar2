{
  "name": "MSI Video Generation - Veo 3.1",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "msi-video-gen",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -200,
        300
      ],
      "id": "webhook-video-gen",
      "name": "Webhook - Video Gen",
      "webhookId": "msi-video-gen"
    },
    {
      "parameters": {
        "jsCode": "// Extract data from web form for video generation\nconst input = $input.item.json;\n\nconsole.log('==== VIDEO GEN WEBHOOK INPUT ====');\nconsole.log('Raw input:', JSON.stringify(input));\n\n// Parse the body if it's a JSON string\nlet data;\nif (input.body) {\n  if (typeof input.body === 'string') {\n    try {\n      data = JSON.parse(input.body);\n    } catch (e) {\n      data = input;\n    }\n  } else if (typeof input.body === 'object') {\n    data = input.body;\n  } else {\n    data = input;\n  }\n} else if (input.query) {\n  data = input.query;\n} else {\n  data = input;\n}\n\n// Extract variables for video generation\nconst prompt = data.prompt || data.video_prompt || '';\nconst duration = data.duration || '5s';\nconst aspect_ratio = data.aspect_ratio || '9:16';\nconst style = data.style || 'cinematic';\nconst reference_image_url = data.reference_image_url || null;\nconst post_id = data.post_id || null;\nconst topic = data.topic || '';\n\nconsole.log('Variables:', { prompt, duration, aspect_ratio, style, reference_image_url, post_id, topic });\n\nif (!prompt) {\n  throw new Error('VIDEO GEN ERROR: prompt is required for video generation.');\n}\n\nreturn [{\n  json: {\n    prompt,\n    duration,\n    aspect_ratio,\n    style,\n    reference_image_url,\n    post_id,\n    topic\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20,
        300
      ],
      "id": "format-video-input",
      "name": "Format Video Input"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Create a professional video prompt for Veo 3.1 based on this request:\n\nUser Prompt: {{ $json.prompt }}\nStyle: {{ $json.style }}\nDuration: {{ $json.duration }} (MUST be exactly this duration with smooth ending)\nAspect Ratio: 9:16 (Vertical)\nTopic: {{ $json.topic || 'General' }}\n\nIMPORTANT REQUIREMENTS:\n1. The video MUST be exactly {{ $json.duration }} long with a smooth, natural ending (fade out or gradual conclusion)\n2. Include a watermark logo in the bottom right corner throughout the entire video (logo will be provided as reference image)\n3. The logo should be subtle but visible, not obstructing the main content\n\nGenerate an optimized, detailed prompt for Veo 3.1 video generation.",
        "options": {
          "systemMessage": "# ROLE: Video Prompt Specialist for Veo 3.1\n\nYou are an expert at creating prompts for Google's Veo 3.1 video generation model.\n\n## OUTPUT FORMAT\nReturn ONLY the optimized video prompt, nothing else. No explanations, no labels.\n\n## RULES\n1. Be specific about camera movements (pan, zoom, dolly, tracking shot)\n2. Include lighting descriptions (golden hour, studio lighting, neon, etc.)\n3. Specify the mood and atmosphere\n4. Add details about motion and dynamics\n5. Keep it under 500 characters for best results\n6. Focus on visual elements that Veo handles well:\n   - Smooth camera movements\n   - Realistic lighting and shadows\n   - Natural motion and physics\n   - Cinematic compositions\n7. CRITICAL: Always end with smooth conclusion (fade out, slow zoom, or natural ending) - NEVER abrupt cuts\n8. ALWAYS include: 'with watermark logo in bottom right corner' in the prompt\n\n## DURATION\n- Specify the exact duration requested\n- Add 'smooth fade out' or 'gradual ending' to avoid abrupt cuts\n- Example: '5 second video with smooth fade out at the end'\n\n## BRANDING\n- A watermark logo will be provided as reference image\n- Logo placement: bottom right corner, small but legible\n- Logo should not obstruct main content\n- Mention 'watermark logo in bottom right' in prompt\n\n## STYLE GUIDELINES\n- cinematic: Add film-quality elements, shallow depth of field, dramatic lighting\n- professional: Clean, corporate feel, steady shots, neutral lighting\n- dynamic: Fast cuts implied, energetic movement, bold compositions\n- minimal: Simple, clean, focused on single subject\n- artistic: Creative angles, unique compositions, experimental feel"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        680,
        300
      ],
      "id": "agent-video-prompt",
      "name": "Agent: Video Prompt Optimizer"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        760,
        520
      ],
      "id": "openai-video-prompt",
      "name": "OpenAI for Video Prompt",
      "credentials": {
        "openAiApi": {
          "id": "13Oqly3WdRAzZVXL",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for Veo 3.1 video generation\nconst formInput = $('Format Video Input').item.json;\nconst optimizedPrompt = $input.item.json.output;\n\nconsole.log('==== PREPARE VIDEO GEN REQUEST ====');\nconsole.log('Optimized prompt:', optimizedPrompt);\n\n// Append duration and vertical format instructions\nconst promptWithEnhancements = `${optimizedPrompt}. ${formInput.duration} video, STRICTLY VERTICAL 9:16 portrait orientation, with smooth fade out ending. Include watermark logo in bottom right corner throughout the video.`;\n\nconsole.log('Enhanced prompt:', promptWithEnhancements);\n\nreturn [{\n  json: {\n    prompt: promptWithEnhancements,\n    original_prompt: formInput.prompt,\n    duration: formInput.duration,\n    aspect_ratio: '9:16',\n    style: formInput.style,\n    post_id: formInput.post_id,\n    topic: formInput.topic\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ],
      "id": "prepare-video-request",
      "name": "Prepare Video Request"
    },
    {
      "parameters": {
        "url": "https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        480
      ],
      "id": "download-logo",
      "name": "Download MSI Logo"
    },
    {
      "parameters": {
        "jsCode": "// Merge video request data with logo binary and convert to base64\nconst videoData = $('Prepare Video Request').item.json;\nconst logoItem = $input.item;\n\nconsole.log('==== MERGE VIDEO DATA WITH LOGO ====');\nconsole.log('Has logo binary:', !!logoItem.binary);\n\nlet logoBase64 = '';\nlet logoMimeType = 'image/png';\n\nif (logoItem.binary && Object.keys(logoItem.binary).length > 0) {\n  const binaryKey = Object.keys(logoItem.binary)[0];\n  const binaryData = logoItem.binary[binaryKey];\n  logoMimeType = binaryData.mimeType || 'image/png';\n  \n  try {\n    const buffer = await this.helpers.getBinaryDataBuffer(logoItem.json.index || 0, binaryKey);\n    logoBase64 = buffer.toString('base64');\n    console.log('Logo base64 extracted, length:', logoBase64.length);\n  } catch (e) {\n    console.error('Failed to get logo buffer:', e.message);\n    if (typeof binaryData.data === 'string' && binaryData.data !== 'filesystem-v2') {\n      logoBase64 = binaryData.data;\n    }\n  }\n}\n\nif (!logoBase64) {\n  throw new Error('Failed to extract logo base64 data');\n}\n\nreturn [{\n  json: {\n    ...videoData,\n    logo_base64: logoBase64,\n    logo_mime_type: logoMimeType\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        480
      ],
      "id": "merge-with-logo",
      "name": "Merge with Logo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/veo-3.0-generate-preview:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  contents: [{\n    parts: [\n      {\n        text: $json.prompt + ' IMPORTANT: This must be a VERTICAL video in 9:16 portrait aspect ratio. The reference image shows the logo watermark to include in bottom right corner.'\n      },\n      {\n        inline_data: {\n          mime_type: $json.logo_mime_type,\n          data: $json.logo_base64\n        }\n      }\n    ]\n  }],\n  generationConfig: {\n    responseModalities: ['VIDEO'],\n    videoConfig: {\n      aspectRatio: '9:16',\n      durationSeconds: parseInt($json.duration) || 5\n    }\n  }\n}) }}",
        "options": {
          "timeout": 300000,
          "response": {
            "response": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1340,
        300
      ],
      "id": "veo-generate-video",
      "name": "Veo 3.1 Generate Video (HTTP)",
      "credentials": {
        "googlePalmApi": {
          "id": "oF4jKBK0jRbwEPWt",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Process Veo 3.1 HTTP response\nconst item = $input.item;\nconst response = item.json;\nconst preparedData = $('Prepare Video Request').item.json;\n\nconsole.log('==== VEO 3.1 HTTP RESPONSE ====');\nconsole.log('Response keys:', Object.keys(response));\nconsole.log('Response structure:', JSON.stringify(response, null, 2).substring(0, 1000));\n\nlet videoBase64 = '';\nlet mimeType = 'video/mp4';\n\n// Check Veo response structure - video comes in candidates[].content.parts[]\ntry {\n  if (response.candidates && response.candidates.length > 0) {\n    const candidate = response.candidates[0];\n    \n    if (candidate.content && candidate.content.parts) {\n      for (const part of candidate.content.parts) {\n        // Check for inline_data (video binary)\n        const inlineData = part.inline_data || part.inlineData;\n        if (inlineData && inlineData.data) {\n          videoBase64 = inlineData.data;\n          mimeType = inlineData.mime_type || inlineData.mimeType || 'video/mp4';\n          console.log('Found video in inline_data, mime:', mimeType);\n          break;\n        }\n        \n        // Check for video_metadata with uri\n        if (part.video_metadata || part.videoMetadata) {\n          console.log('Video metadata found:', part.video_metadata || part.videoMetadata);\n        }\n        \n        // Check for file_data\n        const fileData = part.file_data || part.fileData;\n        if (fileData) {\n          console.log('File data found:', fileData);\n          // May need to download from URI\n          if (fileData.file_uri || fileData.fileUri) {\n            throw new Error('Video returned as file URI - need additional download step: ' + (fileData.file_uri || fileData.fileUri));\n          }\n        }\n      }\n    }\n  }\n  \n  // Alternative: check for generatedVideos array\n  if (!videoBase64 && response.generatedVideos && response.generatedVideos.length > 0) {\n    const video = response.generatedVideos[0];\n    if (video.video) {\n      videoBase64 = video.video.bytesBase64Encoded || video.video.data || '';\n      mimeType = video.video.mimeType || 'video/mp4';\n    } else {\n      videoBase64 = video.bytesBase64Encoded || video.data || '';\n      mimeType = video.mimeType || 'video/mp4';\n    }\n    console.log('Found video in generatedVideos');\n  }\n  \n  // Check for direct video data\n  if (!videoBase64 && response.video) {\n    videoBase64 = response.video.bytesBase64Encoded || response.video.data || '';\n    mimeType = response.video.mimeType || 'video/mp4';\n  }\n  \n  // Check for operation/long-running response (Veo may return async operation)\n  if (!videoBase64 && (response.name || response.operation)) {\n    const opName = response.name || response.operation;\n    console.log('Received async operation:', opName);\n    throw new Error('Veo returned async operation. Operation name: ' + opName + '. May need polling endpoint.');\n  }\n  \n} catch (e) {\n  console.error('Error parsing Veo response:', e.message);\n  throw e;\n}\n\nconsole.log('Has video base64:', !!videoBase64, videoBase64 ? `(${videoBase64.length} chars)` : '');\nconsole.log('MIME type:', mimeType);\n\nif (!videoBase64) {\n  console.log('Full response for debugging:', JSON.stringify(response, null, 2));\n  throw new Error('No video data found in Veo response. Check API response structure.');\n}\n\n// Create a data URL for the video\nconst videoDataUrl = `data:${mimeType};base64,${videoBase64}`;\n\nconsole.log('Video data URL created, length:', videoDataUrl.length);\n\nreturn [{\n  json: {\n    video_base64: videoBase64,\n    video_data_url: videoDataUrl,\n    mime_type: mimeType,\n    has_video: true,\n    post_id: preparedData.post_id,\n    prompt: preparedData.prompt,\n    original_prompt: preparedData.original_prompt\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        300
      ],
      "id": "process-video-response",
      "name": "Process Video Response"
    },
    {
      "parameters": {
        "jsCode": "// Convert base64 video to binary for YouTube upload\nconst videoBase64 = $json.video_base64;\nconst prompt = $json.prompt || 'MSI Content';\nconst postId = $json.post_id;\nconst mimeType = $json.mime_type || 'video/mp4';\n\nif (!videoBase64) {\n  throw new Error('No video base64 data available for YouTube upload');\n}\n\n// Convert base64 to binary buffer\nconst binaryData = Buffer.from(videoBase64, 'base64');\n\n// Generate title (truncate if too long, YouTube max is 100 chars)\nlet title = prompt.substring(0, 97);\nif (prompt.length > 97) title += '...';\n\n// Generate a filename\nconst fileName = `msi_video_${Date.now()}.mp4`;\n\nconsole.log('Preparing YouTube upload:', {\n  title,\n  dataSize: binaryData.length,\n  postId,\n  fileName\n});\n\n// Return with proper binary format for n8n YouTube node\nreturn {\n  json: {\n    title,\n    description: `Generated with AI\\n\\nPrompt: ${prompt}\\n\\nPost ID: ${postId || 'N/A'}`,\n    post_id: postId,\n    original_prompt: prompt\n  },\n  binary: {\n    data: {\n      data: binaryData.toString('base64'),\n      mimeType: mimeType,\n      fileName: fileName\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        300
      ],
      "id": "prepare-youtube-upload",
      "name": "Prepare YouTube Upload"
    },
    {
      "parameters": {
        "resource": "video",
        "operation": "upload",
        "title": "={{ $json.title }}",
        "categoryId": "28",
        "options": {
          "description": "={{ $json.description }}",
          "privacyStatus": "unlisted",
          "tags": "ai,content,msi"
        }
      },
      "type": "n8n-nodes-base.youTube",
      "typeVersion": 1,
      "position": [
        2000,
        300
      ],
      "id": "upload-to-youtube",
      "name": "Upload to YouTube",
      "credentials": {
        "youTubeOAuth2Api": {
          "id": "Mku9dCuHHXi7CGsE",
          "name": "YouTube account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract YouTube URL from response\nconst response = $input.item.json;\nconst preparedData = $('Prepare YouTube Upload').item.json;\n\nconsole.log('==== YOUTUBE UPLOAD RESPONSE ====');\nconsole.log('Response keys:', Object.keys(response));\n\n// YouTube response structure: { id: 'video_id', uploadId: 'video_id', snippet: { ... }, status: { ... } }\nconst videoId = response.id || response.uploadId;\nconst youtubeUrl = `https://youtu.be/${videoId}`;\n\nconsole.log('YouTube URL:', youtubeUrl);\nconsole.log('Video ID:', videoId);\n\nreturn [{\n  json: {\n    youtube_url: youtubeUrl,\n    youtube_video_id: videoId,\n    post_id: preparedData.post_id,\n    title: preparedData.title,\n    prompt: preparedData.original_prompt\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        300
      ],
      "id": "extract-youtube-url",
      "name": "Extract YouTube URL"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE social_posts \nSET youtube_url = '{{ $json.youtube_url }}',\n    status = 'video_completed',\n    updated_at = NOW()\nWHERE id = '{{ $json.post_id }}' AND '{{ $json.post_id }}' != '' AND '{{ $json.post_id }}' IS NOT NULL\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2440,
        300
      ],
      "id": "update-db-youtube",
      "name": "Update DB with YouTube",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Video uploaded to YouTube successfully', data: { youtube_url: $json.youtube_url, youtube_video_id: $json.youtube_video_id || $json.youtube_url?.split('v=')[1], post_id: $json.id || $json.post_id, prompt: $json.prompt } }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        2660,
        300
      ],
      "id": "respond-video-success",
      "name": "Respond Success"
    }
  ],
  "connections": {
    "Webhook - Video Gen": {
      "main": [
        [
          {
            "node": "Format Video Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Video Input": {
      "main": [
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent: Video Prompt Optimizer": {
      "main": [
        [
          {
            "node": "Prepare Video Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI for Video Prompt": {
      "ai_languageModel": [
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Video Request": {
      "main": [
        [
          {
            "node": "Download MSI Logo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download MSI Logo": {
      "main": [
        [
          {
            "node": "Merge with Logo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge with Logo": {
      "main": [
        [
          {
            "node": "Veo 3.1 Generate Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Veo 3.1 Generate Video": {
      "main": [
        [
          {
            "node": "Process Video Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Video Response": {
      "main": [
        [
          {
            "node": "Prepare YouTube Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare YouTube Upload": {
      "main": [
        [
          {
            "node": "Upload to YouTube",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to YouTube": {
      "main": [
        [
          {
            "node": "Extract YouTube URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract YouTube URL": {
      "main": [
        [
          {
            "node": "Update DB with YouTube",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update DB with YouTube": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e"
  }
}
