{
  "name": "MSI Video Generation - Veo 3.1",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "msi-video-gen",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -200,
        300
      ],
      "id": "webhook-video-gen",
      "name": "Webhook - Video Gen",
      "webhookId": "msi-video-gen"
    },
    {
      "parameters": {
        "jsCode": "// Extract data from web form for video generation\nconst input = $input.item.json;\n\nconsole.log('==== VIDEO GEN WEBHOOK INPUT ====');\nconsole.log('Raw input:', JSON.stringify(input));\n\n// Parse the body if it's a JSON string\nlet data;\nif (input.body) {\n  if (typeof input.body === 'string') {\n    try {\n      data = JSON.parse(input.body);\n    } catch (e) {\n      data = input;\n    }\n  } else if (typeof input.body === 'object') {\n    data = input.body;\n  } else {\n    data = input;\n  }\n} else if (input.query) {\n  data = input.query;\n} else {\n  data = input;\n}\n\n// Extract variables for video generation\nconst prompt = data.prompt || data.video_prompt || '';\nconst duration = data.duration || '5s';\nconst aspect_ratio = data.aspect_ratio || '9:16';\nconst style = data.style || 'cinematic';\nconst reference_image_url = data.reference_image_url || null;\nconst post_id = data.post_id || null;\nconst topic = data.topic || '';\n\nconsole.log('Variables:', { prompt, duration, aspect_ratio, style, reference_image_url, post_id, topic });\n\nif (!prompt) {\n  throw new Error('VIDEO GEN ERROR: prompt is required for video generation.');\n}\n\nreturn [{\n  json: {\n    prompt,\n    duration,\n    aspect_ratio,\n    style,\n    reference_image_url,\n    post_id,\n    topic\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20,
        300
      ],
      "id": "format-video-input",
      "name": "Format Video Input"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-post-id",
              "leftValue": "={{ $json.post_id !== null && $json.post_id !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        240,
        300
      ],
      "id": "check-has-post-id",
      "name": "Has Post ID?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE social_posts SET status = 'video_generation_started', updated_at = NOW() WHERE id = '{{ $json.post_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        460,
        200
      ],
      "id": "status-video-started",
      "name": "Status: Video Started",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Create a professional video prompt for Veo 3.1 based on this request:\n\nUser Prompt: {{ $json.prompt }}\nStyle: {{ $json.style }}\nDuration: {{ $json.duration }}\nAspect Ratio: {{ $json.aspect_ratio }}\nTopic: {{ $json.topic || 'General' }}\n\nGenerate an optimized, detailed prompt for Veo 3.1 video generation.",
        "options": {
          "systemMessage": "# ROLE: Video Prompt Specialist for Veo 3.1\n\nYou are an expert at creating prompts for Google's Veo 3.1 video generation model.\n\n## OUTPUT FORMAT\nReturn ONLY the optimized video prompt, nothing else. No explanations, no labels.\n\n## RULES\n1. Be specific about camera movements (pan, zoom, dolly, tracking shot)\n2. Include lighting descriptions (golden hour, studio lighting, neon, etc.)\n3. Specify the mood and atmosphere\n4. Add details about motion and dynamics\n5. Keep it under 500 characters for best results\n6. Focus on visual elements that Veo handles well:\n   - Smooth camera movements\n   - Realistic lighting and shadows\n   - Natural motion and physics\n   - Cinematic compositions\n\n## STYLE GUIDELINES\n- cinematic: Add film-quality elements, shallow depth of field, dramatic lighting\n- professional: Clean, corporate feel, steady shots, neutral lighting\n- dynamic: Fast cuts implied, energetic movement, bold compositions\n- minimal: Simple, clean, focused on single subject\n- artistic: Creative angles, unique compositions, experimental feel"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        680,
        300
      ],
      "id": "agent-video-prompt",
      "name": "Agent: Video Prompt Optimizer"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        760,
        520
      ],
      "id": "openai-video-prompt",
      "name": "OpenAI for Video Prompt",
      "credentials": {
        "openAiApi": {
          "id": "13Oqly3WdRAzZVXL",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for Veo 3.1 video generation\nconst formInput = $('Format Video Input').item.json;\nconst optimizedPrompt = $input.item.json.output;\n\nconsole.log('==== PREPARE VIDEO GEN REQUEST ====');\nconsole.log('Optimized prompt:', optimizedPrompt);\n\nreturn [{\n  json: {\n    prompt: optimizedPrompt,\n    original_prompt: formInput.prompt,\n    duration: formInput.duration,\n    aspect_ratio: formInput.aspect_ratio,\n    style: formInput.style,\n    reference_image_url: formInput.reference_image_url,\n    post_id: formInput.post_id,\n    topic: formInput.topic\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ],
      "id": "prepare-video-request",
      "name": "Prepare Video Request"
    },
    {
      "parameters": {
        "resource": "video",
        "prompt": "={{ $json.prompt }}",
        "modelId": {
          "__rl": true,
          "value": "models/veo-3.1-fast-generate-preview",
          "mode": "list",
          "cachedResultName": "models/veo-3.1-fast-generate-preview"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        1120,
        300
      ],
      "id": "veo-generate-video",
      "name": "Veo 3.1 Generate Video",
      "credentials": {
        "googlePalmApi": {
          "id": "oF4jKBK0jRbwEPWt",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Process Veo 3.1 response - Native n8n Gemini node\n// The node returns the video data directly, not a URL\nconst response = $input.item.json;\nconst preparedData = $('Prepare Video Request').item.json;\n\nconsole.log('==== VEO 3.1 RESPONSE ====');\nconsole.log('Response keys:', Object.keys(response));\nconsole.log('Response type check:', typeof response);\n\nlet videoBase64 = '';\nlet mimeType = 'video/mp4';\n\n// The native n8n Gemini node returns video data directly\n// Check various possible response structures\nif (typeof response === 'string') {\n  // Direct base64 string\n  videoBase64 = response;\n} else if (response.data) {\n  // { data: base64string } or { data: { ... } }\n  videoBase64 = typeof response.data === 'string' ? response.data : (response.data.video || response.data.bytesBase64Encoded || '');\n  mimeType = response.mimeType || response.data.mimeType || mimeType;\n} else if (response.video) {\n  // { video: base64string } or { video: { bytesBase64Encoded: ... } }\n  videoBase64 = typeof response.video === 'string' ? response.video : (response.video.bytesBase64Encoded || response.video.data || '');\n  mimeType = response.video.mimeType || mimeType;\n} else if (response.bytesBase64Encoded) {\n  videoBase64 = response.bytesBase64Encoded;\n  mimeType = response.mimeType || mimeType;\n} else if (response.generatedVideos && response.generatedVideos.length > 0) {\n  const video = response.generatedVideos[0];\n  videoBase64 = video.video?.bytesBase64Encoded || video.bytesBase64Encoded || '';\n  mimeType = video.video?.mimeType || video.mimeType || mimeType;\n} else if (response.output) {\n  videoBase64 = typeof response.output === 'string' ? response.output : (response.output.bytesBase64Encoded || '');\n} else if (response.result) {\n  videoBase64 = typeof response.result === 'string' ? response.result : (response.result.bytesBase64Encoded || '');\n}\n\n// If we still don't have it, check if the response itself looks like base64\nif (!videoBase64) {\n  // Check all keys for base64-like content\n  for (const key of Object.keys(response)) {\n    const val = response[key];\n    if (typeof val === 'string' && val.length > 1000) {\n      // Likely base64 data\n      videoBase64 = val;\n      console.log(`Found video data in key: ${key}`);\n      break;\n    }\n  }\n}\n\nconsole.log('Has video base64:', !!videoBase64, videoBase64 ? `(${videoBase64.length} chars)` : '');\nconsole.log('MIME type:', mimeType);\n\nif (!videoBase64) {\n  console.log('Full response for debugging:', JSON.stringify(response, null, 2).substring(0, 2000));\n  throw new Error('No video data found in Veo response. Check logs for response structure.');\n}\n\n// Create a data URL for the video\nconst videoDataUrl = `data:${mimeType};base64,${videoBase64}`;\n\nconsole.log('Video data URL created, length:', videoDataUrl.length);\n\nreturn [{\n  json: {\n    video_base64: videoBase64,\n    video_data_url: videoDataUrl,\n    mime_type: mimeType,\n    has_video: true,\n    post_id: preparedData.post_id,\n    prompt: preparedData.prompt,\n    original_prompt: preparedData.original_prompt\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1340,
        300
      ],
      "id": "process-video-response",
      "name": "Process Video Response"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-has-post-id-update",
              "leftValue": "={{ $json.post_id !== null && $json.post_id !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1560,
        300
      ],
      "id": "check-update-db",
      "name": "Update DB?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE social_posts \nSET video_url = '{{ $json.video_data_url }}',\n    status = 'video_completed',\n    updated_at = NOW()\nWHERE id = '{{ $json.post_id }}'\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1780,
        200
      ],
      "id": "update-db-video",
      "name": "Update DB with Video",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pass through for no DB update case\nconst data = $input.item.json;\n\nreturn [{\n  json: {\n    video_url: data.video_data_url,\n    video_base64: data.video_base64,\n    id: data.post_id,\n    prompt: data.prompt\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        400
      ],
      "id": "passthrough-no-db",
      "name": "Passthrough (No DB)"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Video generated successfully', data: { video_url: $json.video_url || $json.video_data_url, video_base64: $json.video_base64 ? true : false, post_id: $json.id || $json.post_id, prompt: $json.prompt } }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        2000,
        300
      ],
      "id": "respond-video-success",
      "name": "Respond Success"
    }
  ],
  "connections": {
    "Webhook - Video Gen": {
      "main": [
        [
          {
            "node": "Format Video Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Video Input": {
      "main": [
        [
          {
            "node": "Has Post ID?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Post ID?": {
      "main": [
        [
          {
            "node": "Status: Video Started",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status: Video Started": {
      "main": [
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent: Video Prompt Optimizer": {
      "main": [
        [
          {
            "node": "Prepare Video Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI for Video Prompt": {
      "ai_languageModel": [
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Video Request": {
      "main": [
        [
          {
            "node": "Veo 3.1 Generate Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Veo 3.1 Generate Video": {
      "main": [
        [
          {
            "node": "Process Video Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Video Response": {
      "main": [
        [
          {
            "node": "Update DB?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update DB?": {
      "main": [
        [
          {
            "node": "Update DB with Video",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Passthrough (No DB)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update DB with Video": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Passthrough (No DB)": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e"
  }
}
