{
  "name": "MSI Video Generation - Veo 3.1",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "msi-video-gen",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -200,
        300
      ],
      "id": "webhook-video-gen",
      "name": "Webhook - Video Gen",
      "webhookId": "msi-video-gen"
    },
    {
      "parameters": {
        "jsCode": "// Extract data from web form for video generation\nconst input = $input.item.json;\n\nconsole.log('==== VIDEO GEN WEBHOOK INPUT ====');\nconsole.log('Raw input:', JSON.stringify(input));\n\n// Parse the body if it's a JSON string\nlet data;\nif (input.body) {\n  if (typeof input.body === 'string') {\n    try {\n      data = JSON.parse(input.body);\n    } catch (e) {\n      data = input;\n    }\n  } else if (typeof input.body === 'object') {\n    data = input.body;\n  } else {\n    data = input;\n  }\n} else if (input.query) {\n  data = input.query;\n} else {\n  data = input;\n}\n\n// Extract variables for video generation\nconst prompt = data.prompt || data.video_prompt || '';\nconst duration = data.duration || '5s';\nconst aspect_ratio = data.aspect_ratio || '9:16';\nconst style = data.style || 'cinematic';\nconst reference_image_url = data.reference_image_url || null;\nconst post_id = data.post_id || null;\nconst topic = data.topic || '';\n\nconsole.log('Variables:', { prompt, duration, aspect_ratio, style, reference_image_url, post_id, topic });\n\nif (!prompt) {\n  throw new Error('VIDEO GEN ERROR: prompt is required for video generation.');\n}\n\nreturn [{\n  json: {\n    prompt,\n    duration,\n    aspect_ratio,\n    style,\n    reference_image_url,\n    post_id,\n    topic\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20,
        300
      ],
      "id": "format-video-input",
      "name": "Format Video Input"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-post-id",
              "leftValue": "={{ $json.post_id !== null && $json.post_id !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        240,
        300
      ],
      "id": "check-has-post-id",
      "name": "Has Post ID?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE social_posts SET status = 'video_generation_started', updated_at = NOW() WHERE id = '{{ $json.post_id }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        460,
        200
      ],
      "id": "status-video-started",
      "name": "Status: Video Started",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Create a professional video prompt for Veo 3.1 based on this request:\n\nUser Prompt: {{ $json.prompt }}\nStyle: {{ $json.style }}\nDuration: {{ $json.duration }} (MUST be exactly this duration with smooth ending)\nAspect Ratio: 9:16 (Vertical)\nTopic: {{ $json.topic || 'General' }}\n\nIMPORTANT REQUIREMENTS:\n1. The video MUST be exactly {{ $json.duration }} long with a smooth, natural ending (fade out or gradual conclusion)\n2. Include the MSI Technologies logo (https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png) in the bottom right corner throughout the entire video\n3. The logo should be subtle but visible, not obstructing the main content\n\nGenerate an optimized, detailed prompt for Veo 3.1 video generation.",
        "options": {
          "systemMessage": "# ROLE: Video Prompt Specialist for Veo 3.1\n\nYou are an expert at creating prompts for Google's Veo 3.1 video generation model.\n\n## OUTPUT FORMAT\nReturn ONLY the optimized video prompt, nothing else. No explanations, no labels.\n\n## RULES\n1. Be specific about camera movements (pan, zoom, dolly, tracking shot)\n2. Include lighting descriptions (golden hour, studio lighting, neon, etc.)\n3. Specify the mood and atmosphere\n4. Add details about motion and dynamics\n5. Keep it under 500 characters for best results\n6. Focus on visual elements that Veo handles well:\n   - Smooth camera movements\n   - Realistic lighting and shadows\n   - Natural motion and physics\n   - Cinematic compositions\n7. CRITICAL: Always end with smooth conclusion (fade out, slow zoom, or natural ending) - NEVER abrupt cuts\n8. ALWAYS include: 'MSI Technologies logo (https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png) visible in bottom right corner throughout' in the prompt\n\n## DURATION\n- Specify the exact duration requested\n- Add 'smooth fade out' or 'gradual ending' to avoid abrupt cuts\n- Example: '5 second video with smooth fade out at the end'\n\n## BRANDING\n- MSI Technologies logo (https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png) must be present throughout the video\n- Logo placement: bottom right corner, small but legible\n- Logo should not obstruct main content\n\n## STYLE GUIDELINES\n- cinematic: Add film-quality elements, shallow depth of field, dramatic lighting\n- professional: Clean, corporate feel, steady shots, neutral lighting\n- dynamic: Fast cuts implied, energetic movement, bold compositions\n- minimal: Simple, clean, focused on single subject\n- artistic: Creative angles, unique compositions, experimental feel"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        680,
        300
      ],
      "id": "agent-video-prompt",
      "name": "Agent: Video Prompt Optimizer"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        760,
        520
      ],
      "id": "openai-video-prompt",
      "name": "OpenAI for Video Prompt",
      "credentials": {
        "openAiApi": {
          "id": "13Oqly3WdRAzZVXL",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for Veo 3.1 video generation\nconst formInput = $('Format Video Input').item.json;\nconst optimizedPrompt = $input.item.json.output;\n\nconsole.log('==== PREPARE VIDEO GEN REQUEST ====');\nconsole.log('Optimized prompt:', optimizedPrompt);\n\n// Append logo and duration instructions to the prompt\nconst promptWithEnhancements = `${optimizedPrompt}. ${formInput.duration} video with smooth fade out ending. MSI Technologies logo (https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png) visible in bottom right corner throughout the entire video.`;\n\nconsole.log('Enhanced prompt:', promptWithEnhancements);\n\nreturn [{\n  json: {\n    prompt: promptWithEnhancements,\n    original_prompt: formInput.prompt,\n    duration: formInput.duration,\n    aspect_ratio: '9:16',\n    style: formInput.style,\n    reference_image_url: formInput.reference_image_url,\n    post_id: formInput.post_id,\n    topic: formInput.topic\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ],
      "id": "prepare-video-request",
      "name": "Prepare Video Request"
    },
    {
      "parameters": {
        "resource": "video",
        "prompt": "={{ $json.prompt }}",
        "modelId": {
          "__rl": true,
          "value": "models/veo-3.1-fast-generate-preview",
          "mode": "list",
          "cachedResultName": "models/veo-3.1-fast-generate-preview"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        1120,
        300
      ],
      "id": "veo-generate-video",
      "name": "Veo 3.1 Generate Video",
      "credentials": {
        "googlePalmApi": {
          "id": "oF4jKBK0jRbwEPWt",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Process Veo 3.1 response - can be binary or base64\nconst item = $input.item;\nconst response = item.json;\nconst preparedData = $('Prepare Video Request').item.json;\n\nconsole.log('==== VEO 3.1 RESPONSE ====');\nconsole.log('Response keys:', Object.keys(response));\nconsole.log('Has binary:', !!item.binary, item.binary ? Object.keys(item.binary) : 'none');\nconsole.log('Response type check:', typeof response);\n\nlet videoBase64 = '';\nlet mimeType = 'video/mp4';\n\n// FIRST: Check if video came as binary file (most common with n8n Gemini node)\nif (item.binary && Object.keys(item.binary).length > 0) {\n  console.log('Video came as binary file');\n  const binaryKey = Object.keys(item.binary)[0];\n  const binaryData = item.binary[binaryKey];\n  \n  console.log('Binary data structure:', {\n    hasData: !!binaryData.data,\n    dataType: typeof binaryData.data,\n    mimeType: binaryData.mimeType,\n    fileName: binaryData.fileName\n  });\n  \n  // Get the binary buffer and convert to base64\n  try {\n    const buffer = await this.helpers.getBinaryDataBuffer(item.json.index || 0, binaryKey);\n    videoBase64 = buffer.toString('base64');\n    mimeType = binaryData.mimeType || 'video/mp4';\n    console.log('Converted binary to base64, length:', videoBase64.length);\n  } catch (e) {\n    console.error('Failed to get binary buffer:', e.message);\n    // Fallback: try direct access if it's already base64\n    if (typeof binaryData.data === 'string' && binaryData.data !== 'filesystem-v2') {\n      videoBase64 = binaryData.data;\n    } else if (Buffer.isBuffer(binaryData.data)) {\n      videoBase64 = binaryData.data.toString('base64');\n    }\n  }\n}\n\n// SECOND: Check JSON response structures (fallback)\nif (!videoBase64) {\n  console.log('Checking JSON response structures...');\n  \n  if (typeof response === 'string') {\n    videoBase64 = response;\n  } else if (response.data) {\n    videoBase64 = typeof response.data === 'string' ? response.data : (response.data.video || response.data.bytesBase64Encoded || '');\n    mimeType = response.mimeType || response.data.mimeType || mimeType;\n  } else if (response.video) {\n    videoBase64 = typeof response.video === 'string' ? response.video : (response.video.bytesBase64Encoded || response.video.data || '');\n    mimeType = response.video.mimeType || mimeType;\n  } else if (response.bytesBase64Encoded) {\n    videoBase64 = response.bytesBase64Encoded;\n    mimeType = response.mimeType || mimeType;\n  } else if (response.generatedVideos && response.generatedVideos.length > 0) {\n    const video = response.generatedVideos[0];\n    videoBase64 = video.video?.bytesBase64Encoded || video.bytesBase64Encoded || '';\n    mimeType = video.video?.mimeType || video.mimeType || mimeType;\n  } else if (response.output) {\n    videoBase64 = typeof response.output === 'string' ? response.output : (response.output.bytesBase64Encoded || '');\n  } else if (response.result) {\n    videoBase64 = typeof response.result === 'string' ? response.result : (response.result.bytesBase64Encoded || '');\n  }\n  \n  // Last resort: check all keys for base64-like content\n  if (!videoBase64) {\n    for (const key of Object.keys(response)) {\n      const val = response[key];\n      if (typeof val === 'string' && val.length > 1000) {\n        videoBase64 = val;\n        console.log(`Found video data in key: ${key}`);\n        break;\n      }\n    }\n  }\n}\n\nconsole.log('Has video base64:', !!videoBase64, videoBase64 ? `(${videoBase64.length} chars)` : '');\nconsole.log('MIME type:', mimeType);\n\nif (!videoBase64) {\n  console.log('Full response for debugging:', JSON.stringify(response, null, 2).substring(0, 2000));\n  console.log('Binary keys:', item.binary ? Object.keys(item.binary) : 'none');\n  throw new Error('No video data found in Veo response. Video may not have been generated.');\n}\n\n// Create a data URL for the video\nconst videoDataUrl = `data:${mimeType};base64,${videoBase64}`;\n\nconsole.log('Video data URL created, length:', videoDataUrl.length);\n\nreturn [{\n  json: {\n    video_base64: videoBase64,\n    video_data_url: videoDataUrl,\n    mime_type: mimeType,\n    has_video: true,\n    post_id: preparedData.post_id,\n    prompt: preparedData.prompt,\n    original_prompt: preparedData.original_prompt\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1340,
        300
      ],
      "id": "process-video-response",
      "name": "Process Video Response"
    },
    {
      "parameters": {
        "jsCode": "// Convert base64 video to binary for YouTube upload\nconst videoBase64 = $json.video_base64;\nconst prompt = $json.prompt || 'MSI Content';\nconst postId = $json.post_id;\n\nif (!videoBase64) {\n  throw new Error('No video base64 data available for YouTube upload');\n}\n\n// Convert base64 to binary\nconst binaryData = Buffer.from(videoBase64, 'base64');\n\n// Generate title (truncate if too long, YouTube max is 100 chars)\nlet title = prompt.substring(0, 97);\nif (prompt.length > 97) title += '...';\n\nconsole.log('Preparing YouTube upload:', {\n  title,\n  dataSize: binaryData.length,\n  postId\n});\n\nreturn [{\n  json: {\n    title,\n    description: `Generated with AI\\n\\nPrompt: ${prompt}\\n\\nPost ID: ${postId || 'N/A'}`,\n    post_id: postId,\n    original_prompt: prompt\n  },\n  binary: {\n    data: binaryData\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        200
      ],
      "id": "prepare-youtube-upload",
      "name": "Prepare YouTube Upload"
    },
    {
      "parameters": {
        "resource": "video",
        "operation": "upload",
        "title": "={{ $json.title }}",
        "categoryId": "28",
        "options": {
          "description": "={{ $json.description }}",
          "privacyStatus": "unlisted",
          "tags": "ai,content,msi"
        }
      },
      "type": "n8n-nodes-base.youTube",
      "typeVersion": 1,
      "position": [
        2220,
        200
      ],
      "id": "upload-to-youtube",
      "name": "Upload to YouTube",
      "credentials": {
        "youTubeOAuth2Api": {
          "id": "Mku9dCuHHXi7CGsE",
          "name": "YouTube account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract YouTube URL from response\nconst response = $input.item.json;\nconst preparedData = $('Prepare YouTube Upload').item.json;\n\nconsole.log('==== YOUTUBE UPLOAD RESPONSE ====');\nconsole.log('Response keys:', Object.keys(response));\n\n// YouTube response structure: { id: 'video_id', uploadId: 'video_id', snippet: { ... }, status: { ... } }\nconst videoId = response.id || response.uploadId;\nconst youtubeUrl = `https://youtu.be/${videoId}`;\n\nconsole.log('YouTube URL:', youtubeUrl);\nconsole.log('Video ID:', videoId);\n\nreturn [{\n  json: {\n    youtube_url: youtubeUrl,\n    youtube_video_id: videoId,\n    post_id: preparedData.post_id,\n    title: preparedData.title,\n    prompt: preparedData.original_prompt\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2440,
        200
      ],
      "id": "extract-youtube-url",
      "name": "Extract YouTube URL"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-has-post-id-update",
              "leftValue": "={{ $json.post_id !== null && $json.post_id !== '' && $json.post_id !== undefined }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2660,
        200
      ],
      "id": "check-has-post-id-for-db",
      "name": "Has Post ID for DB?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE social_posts \nSET youtube_url = '{{ $json.youtube_url }}',\n    status = 'video_completed',\n    updated_at = NOW()\nWHERE id = '{{ $json.post_id }}'\nRETURNING *",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2880,
        100
      ],
      "id": "update-db-youtube",
      "name": "Update DB with YouTube",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Video uploaded to YouTube successfully', data: { youtube_url: $json.youtube_url, youtube_video_id: $json.youtube_video_id || $json.youtube_url?.split('v=')[1], post_id: $json.id || $json.post_id, prompt: $json.prompt } }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        3100,
        200
      ],
      "id": "respond-video-success",
      "name": "Respond Success"
    }
  ],
  "connections": {
    "Webhook - Video Gen": {
      "main": [
        [
          {
            "node": "Format Video Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Video Input": {
      "main": [
        [
          {
            "node": "Has Post ID?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Post ID?": {
      "main": [
        [
          {
            "node": "Status: Video Started",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status: Video Started": {
      "main": [
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent: Video Prompt Optimizer": {
      "main": [
        [
          {
            "node": "Prepare Video Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI for Video Prompt": {
      "ai_languageModel": [
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Video Request": {
      "main": [
        [
          {
            "node": "Veo 3.1 Generate Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Veo 3.1 Generate Video": {
      "main": [
        [
          {
            "node": "Process Video Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Video Response": {
      "main": [
        [
          {
            "node": "Prepare YouTube Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare YouTube Upload": {
      "main": [
        [
          {
            "node": "Upload to YouTube",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to YouTube": {
      "main": [
        [
          {
            "node": "Extract YouTube URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract YouTube URL": {
      "main": [
        [
          {
            "node": "Has Post ID for DB?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Post ID for DB?": {
      "main": [
        [
          {
            "node": "Update DB with YouTube",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update DB with YouTube": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e"
  }
}
