{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "msi-video-gen",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        50944,
        3808
      ],
      "id": "1378b2ba-6379-44f6-865c-fa1e699928c7",
      "name": "Webhook - Video Gen",
      "webhookId": "msi-video-gen"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nconsole.log('==== RECEIVED WEBHOOK DATA ====');\nconsole.log('Full input:', JSON.stringify(input, null, 2));\n\nlet data;\n\n// Handle different input formats\nif (input.body) {\n  if (typeof input.body === 'string') {\n    try { \n      data = JSON.parse(input.body); \n      console.log('Parsed body as JSON');\n    } catch (e) { \n      data = input.body; \n      console.log('Body is string, not JSON');\n    }\n  } else if (typeof input.body === 'object') {\n    data = input.body;\n    console.log('Body is already object');\n  } else { \n    data = input; \n  }\n} else if (input.query) {\n  data = input.query;\n  console.log('Using query params');\n} else {\n  data = input;\n  console.log('Using raw input');\n}\n\n// Extract parameters with fallbacks\nconst prompt = data.prompt || data.video_prompt || data.text || '';\nconst duration = String(data.duration || '8');\nconst aspect_ratio = data.aspect_ratio || data.aspectRatio || '9:16';\nconst style = data.style || 'cinematic';\nconst post_id = data.post_id || data.postId || null;\nconst topic = data.topic || '';\nconst logo_url = data.logo_url || null;\nconst start_image_url = data.start_image_url || null;\n\nconsole.log('Extracted data:', { prompt, duration, aspect_ratio, style, post_id, topic, logo_url, start_image_url });\nconsole.log('==== END WEBHOOK DATA ====');\n\nif (!prompt || prompt.length < 3) {\n  throw new Error('VIDEO GEN ERROR: prompt is required and must be at least 3 characters.');\n}\n\nreturn [{ \n  json: { \n    prompt, \n    duration, \n    aspect_ratio, \n    style, \n    post_id, \n    topic,\n    logo_url,\n    start_image_url\n  } \n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        51168,
        3808
      ],
      "id": "881e9587-56ae-4eed-8668-6bea6f900ecd",
      "name": "Format Video Input"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are a professional video prompt engineer for Google Veo 3.1, specializing in MSI Technologies corporate content.\n\nYour task: Transform the user's video request into a photorealistic, cinematic prompt optimized for Veo 3.1.\n\n## USER REQUEST:\n{{ $json.prompt }}\n\n## TOPIC/CONTEXT:\n{{ $json.topic || 'Corporate technology content' }}\n\n## REQUIREMENTS:\n- Duration: {{ $json.duration }} seconds (complete scene, no cuts)\n- Aspect Ratio: {{ $json.aspect_ratio }}\n- Style: {{ $json.style }}\n- Brand: MSI Technologies (must be visible naturally)\n\n## YOUR INSTRUCTIONS:\n\nCreate a SINGLE, detailed prompt (no bullet points, just flowing descriptive text) that includes:\n\n1. **ENVIRONMENT & SETTING**: Specific location with depth and detail (office, data center, conference room, etc.)\n\n2. **LIGHTING** (CRITICAL - Avoid overexposure):\n   - Use: \"soft diffused lighting\", \"balanced exposure\", \"natural window light\"\n   - Add: \"controlled highlights\", \"proper shadows\", \"cinematic color grading\"\n   - AVOID: \"bright\", \"perfect lighting\", \"high-key\"\n\n3. **MSI TECHNOLOGIES BRANDING** (Natural integration):\n   - Logo visible on: wall displays, screens, signage, materials\n   - Brand colors (#207CE5 blue) in: screen interfaces, accent elements\n   - Text: \"MSI Technologies\" should appear naturally in the environment\n\n4. **CAMERA MOVEMENT**: Smooth, professional (slow push-in, gentle pan, tracking shot, crane)\n\n5. **TEXT ON SCREEN** (MANDATORY):\n   - What text appears and when (e.g., \"Text fades in at center: 'Cloud Excellence'\")\n   - Style: modern sans-serif, MSI blue (#207CE5)\n   - Animation: smooth fade-in or slide-in\n\n6. **VISUAL DETAILS**: Objects, textures, depth (3-5 elements minimum - desks, monitors, plants, equipment)\n\n7. **EXPOSURE CONTROL**: Always end with \"balanced exposure, no overexposure, controlled highlights, proper shadow detail\"\n\n## OUTPUT FORMAT:\nReturn ONLY the optimized prompt as a single paragraph of flowing descriptive text. No preamble, no explanations, no bullet points - just the video prompt itself.\n\nExample output style:\n\"Modern MSI Technologies data center with rows of server racks, soft overhead lighting creating balanced exposure and natural shadows. MSI Technologies logo prominently displayed on the entrance wall. Camera slowly tracks forward through the corridor. At 4 seconds, text fades in at lower third: 'Enterprise Infrastructure'. Monitors show real-time data dashboards with MSI blue interface elements. Cinematic color grading with rich blacks and controlled highlights, no overexposure, proper shadow detail. 8 seconds, photorealistic.\"",
        "options": {
          "systemMessage": "# ROLE: Senior Director of Photography (DoP) - MSI Technologies\n\nYou are an expert in photorealistic cinematography. Your JOB is to convert user requests into prompts that look like REAL FILM, not CGI, always featuring MSI Technologies branding naturally.\n\n## CRITICAL RULES FOR REALISM:\n1. **Kill the \"Corporate Cleanliness\":** Avoid describing scenes as \"clean\", \"perfect\", or \"modern white office\". Real offices have clutter, shadows, and mixed lighting.\n2. **Lighting Control:** NEVER ask for \"Brand Color Lighting\" (e.g., don't ask for blue lights everywhere). Use natural light sources (windows, lamps). If MSI Technologies blue is needed, put it on an object (a shirt, a mug, a screen, logo on wall), NOT the whole room's lighting.\n3. **Exposure Fix:** To stop overexposure, use terms like: \"Moody lighting\", \"Soft shadows\", \"High dynamic range\", \"Filmic tone mapping\".\n4. **Text Handling:** Veo 3.1 struggles with \"floating text\". ALWAYS place text on physical objects (Screens, Badges, Papers, Walls). This anchors the reality.\n\n## BRANDING STRATEGY - MSI TECHNOLOGIES:\nInstead of \"MSI Technologies Brand Colors everywhere\", use \"Subtle MSI Technologies branding elements in the background\". This looks professional:\n- Logo on wall displays, monitor screens, signage\n- \"MSI Technologies\" text naturally integrated into the scene\n- Brand colors in accents, not overwhelming\n- Professional, not like a cheap ad\n\nGenerate a single, dense, descriptive prompt focused on TEXTURE, LIGHTING, and natural MSI Technologies brand integration."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        51392,
        3808
      ],
      "id": "e7d67d6f-7544-4f49-bb67-fab0e554f5cf",
      "name": "Agent: Video Prompt Optimizer"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        51472,
        4032
      ],
      "id": "a16c3d98-4d61-4beb-ac0a-de1309b94019",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "oF4jKBK0jRbwEPWt",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "project-id",
              "name": "PROJECT_ID",
              "type": "string",
              "value": "gen-lang-client-0521438560"
            },
            {
              "id": "model-version",
              "name": "MODEL_VERSION",
              "type": "string",
              "value": "veo-3.1-generate-001"
            },
            {
              "id": "location",
              "name": "LOCATION",
              "type": "string",
              "value": "us-central1"
            },
            {
              "id": "api-endpoint",
              "name": "API_ENDPOINT",
              "type": "string",
              "value": "us-central1-aiplatform.googleapis.com"
            },
            {
              "id": "text-prompt",
              "name": "TEXT_PROMPT",
              "type": "string",
              "value": "={{ $('Agent: Video Prompt Optimizer').item.json.output }}. {{ $('Format Video Input').item.json.duration }} second video, {{ $('Format Video Input').item.json.aspect_ratio }} aspect ratio, professional quality."
            },
            {
              "id": "duration",
              "name": "DURATION",
              "type": "string",
              "value": "={{ $('Format Video Input').item.json.duration }}"
            },
            {
              "id": "aspect-ratio",
              "name": "ASPECT_RATIO",
              "type": "string",
              "value": "={{ $('Format Video Input').item.json.aspect_ratio }}"
            },
            {
              "id": "post-id",
              "name": "POST_ID",
              "type": "string",
              "value": "={{ $('Format Video Input').item.json.post_id }}"
            },
            {
              "id": "original-prompt",
              "name": "ORIGINAL_PROMPT",
              "type": "string",
              "value": "={{ $('Format Video Input').item.json.prompt }}"
            },
            {
              "id": "logo-url",
              "name": "LOGO_URL",
              "type": "string",
              "value": "={{ $('Format Video Input').item.json.logo_url || 'https://i.ibb.co/S7mKXdxr/MSI-Technologies-Icon.png' }}"
            },
            {
              "id": "start-image-url",
              "name": "START_IMAGE_URL",
              "type": "string",
              "value": "={{ $('Format Video Input').item.json.start_image_url }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        51744,
        3808
      ],
      "id": "fb21cae3-3a90-4787-a8a5-4166157bb7b2",
      "name": "Settings"
    },
    {
      "parameters": {
        "url": "={{ $('Settings').item.json.LOGO_URL }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        51968,
        3808
      ],
      "id": "4b22fd5f-7b2b-477b-9d87-cb04f0148ab5",
      "name": "Download MSI Logo"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        52192,
        3808
      ],
      "id": "f583ec1a-45db-4490-81a4-e57c931c68f2",
      "name": "Logo to Base64"
    },
    {
      "parameters": {
        "jsCode": "// Merge settings with logo base64 data\nconst settings = $('Settings').item.json;\nconst logoData = $input.item.json;\n\n// Check if we have a start image URL\nconst hasStartImage = settings.START_IMAGE_URL && settings.START_IMAGE_URL !== 'null' && settings.START_IMAGE_URL !== '';\n\nif (hasStartImage) {\n  console.log('Start image URL provided:', settings.START_IMAGE_URL);\n  // We need to download the start image instead\n  return [{\n    json: {\n      ...settings,\n      LOGO_BASE64: logoData.data,\n      LOGO_MIME_TYPE: logoData.mimeType || 'image/png',\n      HAS_START_IMAGE: true,\n      USE_START_IMAGE_AS_BASE: true\n    }\n  }];\n} else {\n  console.log('No start image, using logo as base');\n  return [{\n    json: {\n      ...settings,\n      LOGO_BASE64: logoData.data,\n      LOGO_MIME_TYPE: logoData.mimeType || 'image/png',\n      HAS_START_IMAGE: false,\n      USE_START_IMAGE_AS_BASE: false\n    }\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        52416,
        3808
      ],
      "id": "c57d548e-202d-47da-8fc8-22b683058597",
      "name": "Merge Settings with Logo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-start-image",
              "leftValue": "={{ $json.HAS_START_IMAGE }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        52540,
        3808
      ],
      "id": "check-start-image-123",
      "name": "Check if Start Image"
    },
    {
      "parameters": {
        "url": "={{ $json.START_IMAGE_URL }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        52740,
        3680
      ],
      "id": "download-start-image-456",
      "name": "Download Start Image"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        52940,
        3680
      ],
      "id": "start-image-to-base64-789",
      "name": "Start Image to Base64"
    },
    {
      "parameters": {
        "jsCode": "// Replace logo data with start image data\nconst settings = $('Merge Settings with Logo').item.json;\nconst startImageData = $input.item.json;\n\nconsole.log('Using start image as base for video generation');\n\nreturn [{\n  json: {\n    ...settings,\n    START_IMAGE_BASE64: startImageData.data,\n    START_IMAGE_MIME_TYPE: startImageData.mimeType || 'image/jpeg',\n    FINAL_IMAGE_BASE64: startImageData.data,\n    FINAL_IMAGE_MIME_TYPE: startImageData.mimeType || 'image/jpeg'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        53140,
        3680
      ],
      "id": "merge-start-image-abc",
      "name": "Merge Start Image Data"
    },
    {
      "parameters": {
        "jsCode": "// Use logo as base image (no start image provided)\nconst settings = $input.item.json;\n\nconsole.log('No start image provided, using logo as base');\n\nreturn [{\n  json: {\n    ...settings,\n    FINAL_IMAGE_BASE64: settings.LOGO_BASE64,\n    FINAL_IMAGE_MIME_TYPE: settings.LOGO_MIME_TYPE\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        52740,
        3920
      ],
      "id": "use-logo-as-base-def",
      "name": "Use Logo as Base"
    },
    {
      "parameters": {
        "jsCode": "// Generate OAuth2 Access Token from Service Account\nconst crypto = require('crypto');\n\n// ========== SERVICE ACCOUNT CREDENTIALS ==========\nconst serviceAccount = {\n  \"type\": \"service_account\",\n  \"project_id\": \"gen-lang-client-0521438560\",\n  \"private_key_id\": \"353528a978e83fdd043e74b03d0096604b3ccd77\",\n  \"private_key\": \"-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCc8VpJosYd8D0N\\nmFLmh1b7UOsHgm5ZZBvjSkPUhcFXXoEnOoouhWPD5hEl7ziA+3vWpbHLWb5sm0dv\\nqUhHJWwMMbE5eBxmR7m/Cacpy5ZiOVw+180aZqq6e1AsKlEzRvdz66FSgpCeYtmS\\n2nnc8fGwxfB06qpXsxLVQYnwnKzOlKOv9cfXC/29vrbXoPwez9lkVyySa11iGtYA\\nzMU2LjiPrxvcDTbhb1JYD/050fT/m3z2NgclsV6uCEQxNLXOJriJxNuSKhmZufis\\nsoO/rlj/V+RFTrHEQ8zn3nbm6/W2ZANZt94AOo31t5TR6Idt9PxgjodSHJYLEm+0\\nOXC6bAf3AgMBAAECggEASvGn81Ti9YX0qarNH5+OZkmASmA7EL3Q4Wtj07chmfab\\nhx+Zv9hbyT7yfmJrYZB11Qzfx6Lt35AQ/13fkXXp0DLklfRo32Ct7u+Nn1REVlhc\\n1/eWTl6rdYyQPt7gUrO3U+g3655EsBW1Hz7sBZmVmBwVlMdAm8t8GVEILVmr3aN1\\n5CzVUaLtk9UNQDApUfxgdD2kutWTjqM2j3jsgceST6p98dqV2U8HiOXonpMgt02+\\n3PqApJNu4HQhdMzYwX67vKLuqanlZllLlBp8TWvbP3Roo2p57pD8oamT0BKWDUcX\\nfwT19NJOXqRTim6oalvGklTuwhI9+EJJPlAwN7+rAQKBgQDc+sNzQC4Eph4we6g5\\nBQe5QGIchou/ey1vJ+UGbM8vy6bkuy9dPbDZ/XUZTPOYkTPHKvRu544DTIQzH0qJ\\nfG5NKUIYdOInJm8y+r0JybMrrKl0b04/Nrlueb4RjesASMSq3BTVMK5+6Mb4vx7y\\nLS3mYUc8TF+kBEEaw0H4Fwlu9wKBgQC10JcC0kbtCF/MmHwSq9w0PfgbHT3NoZH7\\nyOWeXPfRLybn+I4MMYW3y5KSL5RM3Gxtve2I/HjJPpprZSUJXfMgRLrVkFRV1iFp\\nA/v1vAxoMlYGk3Oh74rwmmMmU7hhPSNL5HxIDHdXVZb5jrOvqIIBcZ6n2qhaCVXH\\nmtjl3QbvAQKBgBxiUWyiV8bdF4+espLwZHeVH4UOezDTP5jBhRd4LnyzKfLDYGgX\\nnnnBpqLjUX7NV9tDVzZPo9wkne57HHXgd8KNhCHkEZB5zVq8/j8dm1gGy5VbHq/b\\n9aGNHa7fjcnxjuFrd3mS0TcX60bUNcNhrj2jTSUfokFNEpe/cN/PBbUtAoGAaSms\\nnyonciT83Gd6pIYZiXIqluxT+iOxP7SU9AOMJ8ehNl2zM+RVFtk9/yZcHhUE9nj7\\n8tctuiFmyiWnxYI9BXYbpzmjPj7r9kUisKFDf+VVktoo8QqQD9kM7ndQV5Y4W0Ze\\niIIFaVONTu22iyzpfZJNlYNJC0MJBbpQKKyuvQECgYEA2q4N8oL3VJwZAuyIVXOm\\ng9SH9dq4pRunQbXJpxaP2mklGNEbLV1YURVGA0oyQE5oh3/4s/LdMERUFkaYBBnl\\nyrcLRELtnjswAy3b2tEp4ULP/rx5MRY4qjNonUrzoXAs937zDIcyjO6/ekxE28sO\\nXk4daXQsjz4PY3lVvJcnKFA=\\n-----END PRIVATE KEY-----\\n\",\n  \"client_email\": \"vertex-express@gen-lang-client-0521438560.iam.gserviceaccount.com\",\n  \"client_id\": \"113579530477823292475\",\n  \"token_uri\": \"https://oauth2.googleapis.com/token\"\n};\n\nconst settings = $input.item.json;\n\n// ========== JWT GENERATION ==========\nfunction base64url(str) {\n  return Buffer.from(str).toString('base64')\n    .replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\n}\n\nfunction base64urlBuffer(buffer) {\n  return buffer.toString('base64')\n    .replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\n}\n\nconst now = Math.floor(Date.now() / 1000);\nconst header = { alg: 'RS256', typ: 'JWT' };\nconst payload = {\n  iss: serviceAccount.client_email,\n  sub: serviceAccount.client_email,\n  aud: serviceAccount.token_uri,\n  iat: now,\n  exp: now + 3600,\n  scope: 'https://www.googleapis.com/auth/cloud-platform'\n};\n\nconst headerB64 = base64url(JSON.stringify(header));\nconst payloadB64 = base64url(JSON.stringify(payload));\nconst signatureInput = `${headerB64}.${payloadB64}`;\n\n// Sign the JWT\nconst privateKey = serviceAccount.private_key;\nconst sign = crypto.createSign('RSA-SHA256');\nsign.update(signatureInput);\nconst signature = sign.sign(privateKey);\nconst signatureB64 = base64urlBuffer(signature);\nconst jwt = `${signatureInput}.${signatureB64}`;\n\n// ========== EXCHANGE JWT FOR ACCESS TOKEN ==========\nconst tokenResponse = await this.helpers.httpRequest({\n  method: 'POST',\n  url: serviceAccount.token_uri,\n  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n  body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`\n});\n\nif (!tokenResponse.access_token) {\n  throw new Error('Failed to get access token: ' + JSON.stringify(tokenResponse));\n}\n\nconsole.log('Access token generated successfully');\n\nreturn [{\n  json: {\n    ...settings,\n    ACCESS_TOKEN: tokenResponse.access_token\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        53340,
        3808
      ],
      "id": "1f201578-7a1b-4259-b96e-5d49a386d65d",
      "name": "Generate Access Token"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{ $json.API_ENDPOINT }}/v1/projects/{{ $json.PROJECT_ID }}/locations/{{ $json.LOCATION }}/publishers/google/models/{{ $json.MODEL_VERSION }}:predictLongRunning",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.ACCESS_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  instances: [{\n    prompt: $json.TEXT_PROMPT + \", balanced natural lighting, controlled exposure, no overexposure, cinematic color grading, 8k, photorealistic, proper shadows, rich detail\",\n    image: {\n      bytesBase64Encoded: $json.FINAL_IMAGE_BASE64,\n      mimeType: $json.FINAL_IMAGE_MIME_TYPE\n    }\n  }],\n  parameters: {\n    aspectRatio: $json.ASPECT_RATIO,\n    sampleCount: 1,\n    durationSeconds: $json.DURATION,\n    personGeneration: 'allow_all',\n    addWatermark: false,\n    includeRaiReason: true,\n    generateAudio: true,\n    negativePrompt: \"overexposed, blown highlights, washed out, too bright, high-key lighting, flat lighting, loss of detail, white crush, cartoon, 3d render, animation, anime, illustration, painting, plastic skin, mannequin, smooth skin, bad anatomy, distorted face, disfigured, cgi, blender, low quality, grainy, blurry, watermark, floating letters, distorted hands, extra fingers\"\n  }\n}) }}",
        "options": {
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        53564,
        3808
      ],
      "id": "3c59b4d2-4d69-43c9-b55a-9b23fa87c8ea",
      "name": "Vertex AI - VEO3"
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "minutes"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        53788,
        3808
      ],
      "id": "d383491f-a08c-441d-820b-b7634d159697",
      "name": "Wait 2 Minutes",
      "webhookId": "veo3-wait"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{ $('Generate Access Token').item.json.API_ENDPOINT }}/v1/projects/{{ $('Generate Access Token').item.json.PROJECT_ID }}/locations/{{ $('Generate Access Token').item.json.LOCATION }}/publishers/google/models/{{ $('Generate Access Token').item.json.MODEL_VERSION }}:fetchPredictOperation",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Generate Access Token').item.json.ACCESS_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"operationName\": \"{{ $('Vertex AI - VEO3').item.json.name }}\"\n}",
        "options": {
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        54012,
        3808
      ],
      "id": "b439cc64-66b2-47fb-844f-5c01ccfbd633",
      "name": "Vertex AI - Fetch Result"
    },
    {
      "parameters": {
        "jsCode": "// Process Vertex AI response\nconst response = $input.item.json;\nconst settings = $('Generate Access Token').item.json;\n\nconsole.log('==== PROCESS VEO3 RESPONSE ====');\nconsole.log('Response keys:', Object.keys(response));\n\n// Check if operation is still running\nif (response.done === false) {\n  return [{\n    json: {\n      is_async: true,\n      operation_name: $('Vertex AI - VEO3').item.json.name,\n      status: 'still_processing',\n      post_id: settings.POST_ID,\n      prompt: settings.TEXT_PROMPT,\n      original_prompt: settings.ORIGINAL_PROMPT,\n      message: 'Video still processing. Try fetching again later.'\n    }\n  }];\n}\n\nlet videoBase64 = '';\nlet mimeType = 'video/mp4';\n\n// Try different response formats from Veo 3.0\nif (response.response?.videos?.[0]?.bytesBase64Encoded) {\n  videoBase64 = response.response.videos[0].bytesBase64Encoded;\n  mimeType = response.response.videos[0].mimeType || 'video/mp4';\n} else if (response.response?.generatedSamples?.[0]?.video?.bytesBase64Encoded) {\n  videoBase64 = response.response.generatedSamples[0].video.bytesBase64Encoded;\n} else if (response.predictions?.[0]?.bytesBase64Encoded) {\n  videoBase64 = response.predictions[0].bytesBase64Encoded;\n} else if (response.generatedSamples?.[0]?.video?.bytesBase64Encoded) {\n  videoBase64 = response.generatedSamples[0].video.bytesBase64Encoded;\n}\n\nif (!videoBase64) {\n  console.log('Full response:', JSON.stringify(response));\n  throw new Error('No video data found. Response: ' + JSON.stringify(response).substring(0, 1000));\n}\n\nconsole.log('Video extracted successfully, size:', videoBase64.length);\nconsole.log('==== END PROCESS ====');\n\nreturn [{\n  json: {\n    video_base64: videoBase64,\n    video_data_url: `data:${mimeType};base64,${videoBase64}`,\n    mime_type: mimeType,\n    has_video: true,\n    is_async: false,\n    post_id: settings.POST_ID,\n    prompt: settings.TEXT_PROMPT,\n    original_prompt: settings.ORIGINAL_PROMPT\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        54236,
        3808
      ],
      "id": "cfc6823f-3365-439c-a2c2-b8e2492d3b88",
      "name": "Process Video Response"
    },
    {
      "parameters": {
        "jsCode": "// Convert base64 video to binary for YouTube upload\nconst videoBase64 = $json.video_base64;\nconst prompt = $json.original_prompt || $json.prompt || 'MSI Content';\nconst postId = $json.post_id;\nconst mimeType = $json.mime_type || 'video/mp4';\n\nif (!videoBase64) {\n  throw new Error('No video base64 data available');\n}\n\nconst binaryData = Buffer.from(videoBase64, 'base64');\nlet title = prompt.substring(0, 97);\nif (prompt.length > 97) title += '...';\nconst fileName = `msi_video_${Date.now()}.mp4`;\n\nreturn {\n  json: {\n    title,\n    description: `Generated with AI by MSI Technologies\\n\\nPrompt: ${prompt}\\n\\nPost ID: ${postId || 'N/A'}`,\n    post_id: postId,\n    original_prompt: prompt\n  },\n  binary: {\n    data: {\n      data: binaryData.toString('base64'),\n      mimeType: mimeType,\n      fileName: fileName\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        54460,
        3808
      ],
      "id": "31f57c79-326a-40d6-87db-8f6750e7dc80",
      "name": "Prepare YouTube Upload"
    },
    {
      "parameters": {
        "resource": "video",
        "operation": "upload",
        "title": "={{ $json.title }}",
        "categoryId": "28",
        "options": {
          "description": "={{ $json.description }}",
          "privacyStatus": "unlisted",
          "tags": "ai,content,msi,technology"
        }
      },
      "type": "n8n-nodes-base.youTube",
      "typeVersion": 1,
      "position": [
        53984,
        3808
      ],
      "id": "93459fd3-48fc-4ac0-828f-3b9f1ecc7440",
      "name": "Upload to YouTube",
      "credentials": {
        "youTubeOAuth2Api": {
          "id": "Mku9dCuHHXi7CGsE",
          "name": "YouTube account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconst preparedData = $('Prepare YouTube Upload').item.json;\n\nconst videoId = response.id || response.uploadId;\nconst youtubeUrl = `https://youtu.be/${videoId}`;\n\nreturn [{\n  json: {\n    youtube_url: youtubeUrl,\n    youtube_video_id: videoId,\n    post_id: preparedData.post_id,\n    title: preparedData.title,\n    prompt: preparedData.original_prompt\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        54208,
        3808
      ],
      "id": "f918bf55-0ad0-4516-bfa9-e9d744865de9",
      "name": "Extract YouTube URL"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.post_id && $json.post_id.length > 10 ? `UPDATE social_posts SET youtube_url = '${$json.youtube_url}', status = 'video_completed', updated_at = NOW() WHERE id = '${$json.post_id}' RETURNING *` : `SELECT '${$json.youtube_url}' as youtube_url, 'no_post_id' as status` }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        54432,
        3808
      ],
      "id": "0535f5d2-5671-44f3-b413-af5c03dda82a",
      "name": "Update DB with YouTube",
      "credentials": {
        "postgres": {
          "id": "WnTYs2zvPoE7hDJE",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Video uploaded to YouTube successfully', data: { youtube_url: $json.youtube_url, youtube_video_id: $json.youtube_video_id, post_id: $json.post_id, prompt: $json.prompt } }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        54656,
        3808
      ],
      "id": "ae7b52a4-4c0b-4bdd-afb4-935e8b8bed81",
      "name": "Respond Success"
    }
  ],
  "connections": {
    "Webhook - Video Gen": {
      "main": [
        [
          {
            "node": "Format Video Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Video Input": {
      "main": [
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent: Video Prompt Optimizer": {
      "main": [
        [
          {
            "node": "Settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Agent: Video Prompt Optimizer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Settings": {
      "main": [
        [
          {
            "node": "Download MSI Logo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download MSI Logo": {
      "main": [
        [
          {
            "node": "Logo to Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logo to Base64": {
      "main": [
        [
          {
            "node": "Merge Settings with Logo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Settings with Logo": {
      "main": [
        [
          {
            "node": "Check if Start Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Start Image": {
      "main": [
        [
          {
            "node": "Download Start Image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Use Logo as Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Start Image": {
      "main": [
        [
          {
            "node": "Start Image to Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start Image to Base64": {
      "main": [
        [
          {
            "node": "Merge Start Image Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Start Image Data": {
      "main": [
        [
          {
            "node": "Generate Access Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Use Logo as Base": {
      "main": [
        [
          {
            "node": "Generate Access Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Access Token": {
      "main": [
        [
          {
            "node": "Vertex AI - VEO3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vertex AI - VEO3": {
      "main": [
        [
          {
            "node": "Wait 2 Minutes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 2 Minutes": {
      "main": [
        [
          {
            "node": "Vertex AI - Fetch Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vertex AI - Fetch Result": {
      "main": [
        [
          {
            "node": "Process Video Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Video Response": {
      "main": [
        [
          {
            "node": "Prepare YouTube Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare YouTube Upload": {
      "main": [
        [
          {
            "node": "Upload to YouTube",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to YouTube": {
      "main": [
        [
          {
            "node": "Extract YouTube URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract YouTube URL": {
      "main": [
        [
          {
            "node": "Update DB with YouTube",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update DB with YouTube": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b5116c87255060ddf18db8a2b1b90e34b38f50f44815cf784a0b8a92b6bb4e6e"
  }
}